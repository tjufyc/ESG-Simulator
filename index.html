
	      <!DOCTYPE html>
<html>
  <head>
    <title>CodeSandbox</title>

    <script type="importmap">
      {"imports":{"react":"https://esm.sh/react@18.3.1","https:":"https://esm.sh/https:?external=react,react-dom","lucide-react":"https://esm.sh/lucide-react?external=react,react-dom","leancloud-storage":"https://esm.sh/leancloud-storage?external=react,react-dom","react-dom":"https://esm.sh/react-dom@18.3.1","react/jsx-runtime":"https://esm.sh/react@18.3.1/jsx-runtime","react-dom/client":"https://esm.sh/react-dom@18.3.1/client","tailwindcss/defaultTheme":"https://esm.sh/tailwindcss/defaultTheme","tailwindcss-animate":"https://esm.sh/tailwindcss-animate"}}
    </script>

    <script>
      window.addEventListener("error", function (event) {
        const errorObj = {
          message: event.message,
          source: event.filename,
          lineno: event.lineno,
          colno: event.colno,
          stack: event.error ? event.error.stack : null
        };
        window.parent.postMessage(
          { action: "error", error: JSON.stringify(errorObj) },
          "*"
        );
        event.preventDefault();
      });

  function handleImportError(error) {
    throw new Error('Import module failed: ' + error.target.src);
  }

  const observer = new MutationObserver(mutations => {
    mutations.forEach(mutation => {
      mutation.addedNodes.forEach(node => {
        if (node.tagName === 'SCRIPT' && node.type === 'module') {
          node.onerror = handleImportError;
        }
      });
    });
  });

  observer.observe(document.documentElement, { childList: true, subtree: true });

  document.querySelectorAll('script[type="module"]').forEach(script => {
    script.onerror = handleImportError;
  });

  
window.console = new Proxy(console, {
  get(target, prop) {
    if (['log', 'warn', 'error'].includes(prop)) {
      return new Proxy(target[prop], {
        apply(fn, thisArg, args) {
          fn.apply(thisArg, args);
          window.parent.postMessage({ action: 'console', 
            type: prop, 
            args: args.map((arg) => {
              try {
                return JSON.stringify(arg).replace(/^["']|["']$/g, '');
              } catch (e) {
                return arg;
              }
            }) 
          }, '*');
        }
      });
    }
    return target[prop];
  }
});


    </script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,container-queries"></script>
    <style type="text/tailwindcss">
      @layer base {
        :root {
          --background: 0 0% 100%;
          --foreground: 222.2 47.4% 11.2%;

          --muted: 210 40% 96.1%;
          --muted-foreground: 215.4 16.3% 46.9%;

          --popover: 0 0% 100%;
          --popover-foreground: 222.2 47.4% 11.2%;

          --border: 214.3 31.8% 91.4%;
          --input: 214.3 31.8% 91.4%;

          --card: 0 0% 100%;
          --card-foreground: 222.2 47.4% 11.2%;

          --primary: 222.2 47.4% 11.2%;
          --primary-foreground: 210 40% 98%;

          --secondary: 210 40% 96.1%;
          --secondary-foreground: 222.2 47.4% 11.2%;

          --accent: 210 40% 96.1%;
          --accent-foreground: 222.2 47.4% 11.2%;

          --destructive: 0 100% 50%;
          --destructive-foreground: 210 40% 98%;

          --ring: 215 20.2% 65.1%;

          --radius: 0.5rem;
        }

        .dark {
          --background: 224 71% 4%;
          --foreground: 213 31% 91%;

          --muted: 223 47% 11%;
          --muted-foreground: 215.4 16.3% 56.9%;

          --accent: 216 34% 17%;
          --accent-foreground: 210 40% 98%;

          --popover: 224 71% 4%;
          --popover-foreground: 215 20.2% 65.1%;

          --border: 216 34% 17%;
          --input: 216 34% 17%;

          --card: 224 71% 4%;
          --card-foreground: 213 31% 91%;

          --primary: 210 40% 98%;
          --primary-foreground: 222.2 47.4% 1.2%;

          --secondary: 222.2 47.4% 11.2%;
          --secondary-foreground: 210 40% 98%;

          --destructive: 0 63% 31%;
          --destructive-foreground: 210 40% 98%;

          --ring: 216 34% 17%;

          --radius: 0.5rem;
        }
      }
    </style>
    <script type="module">
          import defaultTheme from "tailwindcss/defaultTheme"
          import tailwindcssAnimate from "tailwindcss-animate"

          const fontFamily = defaultTheme.fontFamily;

          tailwind.config = {
            darkMode: ["class"],
        content: ["app/**/*.{ts,tsx}", "components/**/*.{ts,tsx}"],
        theme: {
          container: {
            center: true,
            padding: "2rem",
            screens: {
              "2xl": "1400px",
            },
          },
          extend: {
            colors: {
              border: "hsl(var(--border))",
              input: "hsl(var(--input))",
              ring: "hsl(var(--ring))",
              background: "hsl(var(--background))",
              foreground: "hsl(var(--foreground))",
              primary: {
                DEFAULT: "hsl(var(--primary))",
                foreground: "hsl(var(--primary-foreground))",
              },
              secondary: {
                DEFAULT: "hsl(var(--secondary))",
                foreground: "hsl(var(--secondary-foreground))",
              },
              destructive: {
                DEFAULT: "hsl(var(--destructive))",
                foreground: "hsl(var(--destructive-foreground))",
              },
              muted: {
                DEFAULT: "hsl(var(--muted))",
                foreground: "hsl(var(--muted-foreground))",
              },
              accent: {
                DEFAULT: "hsl(var(--accent))",
                foreground: "hsl(var(--accent-foreground))",
              },
              popover: {
                DEFAULT: "hsl(var(--popover))",
                foreground: "hsl(var(--popover-foreground))",
              },
              card: {
                DEFAULT: "hsl(var(--card))",
                foreground: "hsl(var(--card-foreground))",
              },
            },
            borderRadius: {
              lg: `var(--radius)`,
              md: `calc(var(--radius) - 2px)`,
              sm: "calc(var(--radius) - 4px)",
            },
            fontFamily: {
              sans: [...fontFamily.sans],
            },

            keyframes: {
              "accordion-down": {
                from: { height: "0" },
                to: { height: "var(--radix-accordion-content-height)" },
              },
              "accordion-up": {
                from: { height: "var(--radix-accordion-content-height)" },
                to: { height: "0" },
              },
            },
            animation: {
              "accordion-down": "accordion-down 0.2s ease-out",
              "accordion-up": "accordion-up 0.2s ease-out",
            },
          },
        },
        plugins: [tailwindcssAnimate]
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.27.0/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      		  import {createRoot} from "react-dom/client";
            
      		  
import React, { useState, useEffect, useRef } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from "https://esm.sh/shadcdn?external=react,react-dom";
import { Button } from "https://esm.sh/shadcdn?external=react,react-dom";
import { Checkbox } from "https://esm.sh/shadcdn?external=react,react-dom";
import { Input } from "https://esm.sh/shadcdn?external=react,react-dom";
import { Badge } from "https://esm.sh/shadcdn?external=react,react-dom";
import { Alert, AlertTitle, AlertDescription } from "https://esm.sh/shadcdn?external=react,react-dom";
import { ScrollArea } from "https://esm.sh/shadcdn?external=react,react-dom";
import { Textarea } from "https://esm.sh/shadcdn?external=react,react-dom";
import { 
  User, Building2, Landmark, Globe, Users, Activity, 
  ArrowRight, FileText, CheckCircle2, Info, MapPin, 
  Banknote, Clock, ShieldAlert, XCircle, AlertTriangle,
  Timer, Image as ImageIcon, Gavel, BookOpen, Reply,
  ClipboardCheck, Award, Megaphone, Handshake, Eye,
  Sun, Zap, Truck, HardHat, FileSignature, ListChecks,
  Lock, PieChart, BarChart3, ScrollText, Target, Scale
} from 'lucide-react';

// --- LEANCLOUD 集成 ---
import AV from 'leancloud-storage';

// 初始化 LeanCloud
try {
  AV.init({
    appId: "oxljnef7788g0vxPG8KFVbov-MdYXbMMI",
    appKey: "w3iUN3cMVOVBaPAMh96Dr2VX",
    serverURL: "https://oxljnef7.api.lncldglobal.com"
  });
  console.log("LeanCloud Initialized");
} catch (err) {
  console.error("LeanCloud Init Error:", err);
}

// --- 1. 静态配置 ---

const PROJECT_INFO = {
  name: "SunLink 光伏+输变电项目", 
  location: "A国 (虚构发展中国家) - 北部干旱荒漠与'绿洲'湿地保护区的交界地带",
  scope_items: [
    "新建一座 100 MW 光伏电站",
    "配套建设约 80 km、132kV 输电线路，接入国家主干电网",
    "扩建一座现有变电站，新增 132/220kV 主变及相关设备"
  ],
  timeline: "计划并网发电时间：24个月 (游戏中1分钟代表1个月)",
  stages_visual: [
    { id: 1, title: "立项审批", task: "开展环境社会影响评价 (ESIA)", color: "bg-blue-50 border-blue-200 text-blue-800" },
    { id: 2, title: "项目融资", task: "签订环境社会承诺计划 (ESCP)", color: "bg-indigo-50 border-indigo-200 text-indigo-800" },
    { id: 3, title: "EPC合同谈判", task: "编制环境社会管理计划 (ESMP) 与合同设计", color: "bg-violet-50 border-violet-200 text-violet-800" }, 
    { id: 4, title: "项目建设", task: "执行环境社会管理计划 (ESMP)", color: "bg-orange-50 border-orange-200 text-orange-800" },
    { id: 5, title: "验收评价", task: "竣工验收与ESG后评价", color: "bg-emerald-50 border-emerald-200 text-emerald-800" }
  ],
  background: "A国作为典型的资源型发展中国家，正面临严重的能源短缺与减排压力。政府引入国际能源巨头 GreenGen 投资建设该国最大的光伏电站。然而，项目选址极具争议：它虽然避开了核心耕地，但紧邻濒危物种'长尾沙鸡'的最后一块繁殖地，且项目用水可能通过地下水系影响下游原住民部落的唯一水源。",
  mission: "这是一场多方博弈。在资金有限、工期紧迫、且国际NGO高度关注的背景下，各方需在经济利益、环境合规与社会稳定之间寻找极其脆弱的平衡点。任何一方的激进决策都可能导致项目停摆。"
};

const ROLE_DETAILS = {
  owner: {
    label: "业主",
    desc: "投资方 GreenGen 集团",
    task: "你需要对总部的财务报表负责，首要目标是控制投资和按期并网发电。虽然你知道ESG很重要，但同时也意味着昂贵的成本。"
  },
  gov: {
    label: "政府",
    desc: "A国能源与环境部",
    task: "你处于夹缝之中。一方面，你需要这个项目带来的电力和税收政绩；另一方面，你必须依据法律监管环境问题，否则会被国际社会指责甚至引发国内动荡。你的审批权是你最大的筹码。"
  },
  mdb: {
    label: "多边开发银行",
    desc: "世界基础设施银行 (WIB)",
    task: "你为项目提供关键的低息贷款，遵循世界银行《环境社会框架》（ESF），期望通过项目促进当地经济社会发展并支持当地能力建设。你的《环境社会标准》（ESS）是项目的紧箍咒，你并不直接管理项目建设，但如果项目出现丑闻，声誉风险是你无法接受的。"
  },
  epc: {
    label: "EPC承包商", 
    desc: "GIP国际工程公司",
    task: "你是项目的总承包商。你的目标是争取对自己有利的合同条件，在合同谈判阶段与业主划分ESG责任，并在报价中考虑自己需要负责的环境社会管理计划（ESMP）。建设阶段按合同办事，落实ESMP会增加成本，但也需要考虑企业声誉的影响。"
  },
  ngo: {
    label: "公众",
    desc: "当地受影响社区及环保组织 EcoWatch",
    task: "你们资源最少，但声音最大。你们不反对项目，但反对以牺牲环境为代价的发展，希望社区从中获益，担心生态环境破坏。如果诉求得不到满足，你们会抗议、甚至阻工。"
  }
};

const ESIA_ITEMS = [
  { id: 'b1', label: '水土保持方案', cost: 5 }, 
  { id: 'b2', label: '施工噪音控制', cost: 5 }, 
  { id: 'b3', label: '固体废弃物处理', cost: 10 },
  { id: 'b4', label: '粉尘与空气监测', cost: 5 }, 
  { id: 'b5', label: '社区交通安全计划', cost: 10 },
  { id: 'b6', label: '土地征用补偿机制', cost: 20 }, 
  { id: 'b7', label: '文化遗产勘测', cost: 5 }, 
  { id: 'a1', label: '生物多样性专项评估', cost: 20 }, 
  { id: 'a2', label: '原住民知情同意(FPIC)', cost: 10 },
  { id: 'a3', label: '全生命周期碳足迹', cost: 20 }, 
];

const ESMP_LIBRARY = [
  { id: 'mp1', label: '基于性别的暴力/性剥削和虐待行动计划 (GBV/SEA/SH)', cost: 20, crisisTitle: "暗夜哭声", crisisDesc: "夜幕降临，工地附近的村落不再宁静。多名妇女报告称，在往返集市的途中遭到身穿项目制服工人的言语骚扰甚至肢体拉扯。更有传闻称，有工头利用招工机会要求非正当的'性服务'作为录用条件。恐惧在社区蔓延，妇女不敢独自出门，愤怒的家属聚集在工地大门，要求交出涉事人员，否则将切断工地水源。" },
  { id: 'mp2', label: '劳工管理程序 (LMP)', cost: 20, crisisTitle: "血汗工棚", crisisDesc: "为赶在雨季前完成地基工程，项目部强制实行'两班倒'制度，工人连续工作超过16小时且无加班费。与此同时，临时搭建的工棚拥挤不堪，缺乏通风设备，食堂卫生条件恶劣导致多人食物中毒。愤怒的情绪在高温下发酵，数百名工人在清晨集体罢工，举着'我们要休息'的横幅封锁了进场道路，工程全面瘫痪。" },
  { id: 'mp3', label: '移民安置行动计划 (RAP)', cost: 20, crisisTitle: "看不见的邻居", crisisDesc: "在项目征地红线边缘，居住着一群没有土地所有权的经济移民。推土机在清理场地时，强制拆除了他们的简易棚屋，并未提供任何过渡性安置方案。这些失去住所的家庭拖家带口，在工地大门口搭起了帐篷营地，即使在烈日下也拒绝离开。国际人权观察组织的记者已抵达现场，摄像机对准了在此哭泣的老人和儿童，指责项目方'暴力驱逐'。" },
  { id: 'mp4', label: '安全保卫人员管理计划 (SMP)', cost: 20, crisisTitle: "过度防卫", crisisDesc: "几名当地村民试图进入工地废料堆捡拾废弃的金属边角料，被受雇的私人安保公司人员发现。安保人员未按程序进行劝阻，而是直接放出护卫犬并使用警棍驱赶，导致两名村民头部受伤流血，一人骨折。消息传回村庄，激愤的村民手持农具包围了工地，声称如果不安置伤者并惩办凶手，就要烧毁安保岗亭。" },
  { id: 'mp5', label: '废物与危险废物管理计划', cost: 20, crisisTitle: "黑色渗漏", crisisDesc: "施工机械更换下来的废机油和液压油被随意堆放在未做防渗处理的土坑中。一场暴雨过后，黑色的油污溢出，顺着地势流入了附近村民赖以生存的灌溉渠。下游的农田土壤表面浮现出油光，刚种下的秧苗成片枯死。村民拿着发黑的土壤样本来到项目部索赔，环保部门也接到了举报，准备对现场进行突击检查。" },
  { id: 'mp6', label: '生物多样性管理计划 (BMP)', cost: 20, crisisTitle: "带血的羽毛", crisisDesc: "尽管ESIA中已标记了珍稀鸟类'长尾沙鸡'的繁殖区域，但为了抄近路，一辆重型运输卡车擅自驶入保护区边缘，碾压了多处隐蔽在草丛中的巢穴。几只濒危幼鸟死亡的照片被观鸟爱好者发布在社交媒体上，迅速引发全网震怒。环保NGO发布紧急声明，指责项目方虽然做出了承诺但完全没有落实，要求立即停工整顿。" },
  { id: 'mp7', label: '水资源管理计划', cost: 20, crisisTitle: "干涸的井", crisisDesc: "光伏板清洗工作需要大量用水，项目部为了节约成本，擅自在工地内打深井抽取地下水，而未告知周边社区。两个月后，下游村庄的百年古井水位急剧下降，甚至干涸见底，村民的生活用水和牲畜饮水陷入绝境。村长带着枯竭水井的照片和请愿书来到项目部，指责项目是'吸血鬼'，剥夺了他们的生存资源。" },
  { id: 'mp8', label: '交通管理计划', cost: 20, crisisTitle: "夺命尘土", crisisDesc: "重型运输车辆日夜穿梭在狭窄的乡村土路上，扬起的漫天尘土让路边的庄稼蒙上了厚厚的灰尘，导致减产。更严重的是，一辆超速行驶的混凝土搅拌车在转弯处失控，撞伤了村民的一头耕牛，且司机未停车查看直接驶离。这一肇事逃逸行为彻底引爆了村民的怒火，他们搬来巨石和树干，彻底阻断了运输道路。" },
  { id: 'mp9', label: '职业健康与安全计划 (OHS)', cost: 20, crisisTitle: "高空坠落", crisisDesc: "在输电线路铁塔组立过程中，一名年轻工人在未系安全带的情况下在20米高空作业，不慎踩空坠落。虽然经过抢救保住了性命，但造成了永久性残疾。事故调查显示，现场缺乏安全监护人，且该工人并未接受过高处作业培训。这一严重的安全事故暴露了项目安全管理体系的形同虚设，劳动监察部门已介入调查。" },
  { id: 'mp10', label: '文化遗产管理计划 (CHMP)', cost: 20, crisisTitle: "祖灵的愤怒", crisisDesc: "挖掘机在平整变电站用地时，意外挖出了一些陶片和骨骸，但施工方为了不影响进度，选择隐瞒不报并继续施工，导致一处未被记录的古代部族墓葬群遭到严重破坏。当地部落长老闻讯赶来，痛哭流涕，认为这是对祖先神灵的极大亵渎。部落成员在工地周围举行诅咒仪式，并威胁要对'亵渎者'进行精神和肉体上的报复。" },
  { id: 'mp11', label: '利益相关方参与计划 (SEP)', cost: 20, crisisTitle: "被遗忘的声音", crisisDesc: "由于地形原因，项目方微调了输电线路的走向，虽然在合规范围内，但并未及时告知新受影响的社区。直到施工队进入农田，村民才惊觉自己的土地将被铁塔跨越。村民们感到被欺骗和无视，认为项目方在搞'暗箱操作'。他们阻拦施工队进场，表示在没有得到合理解释和重新协商之前，决不允许任何机械开动。" },
];

const INITIAL_STATES = {
  owner: { money: 500, reputation: 100, label: '业主' },
  gov: { cost: 0, reputation: 100, label: '政府' },
  mdb: { cost: 0, reputation: 100, label: '多边开发银行' },
  epc: { money: 200, reputation: 100, label: 'EPC承包商' },
  ngo: { benefit: 50, reputation: 100, label: '公众' }
};

const RISK_TABLE = [
  { level: '高风险', basis: '可能产生不可逆转、累积、多样或者前所未有的重大不利环境和社会影响', req: '对高风险项目进行环境和社会影响评估（ESIA），签署环境社会承诺计划（ESCP）并编制环境和社会管理计划（ESMP）' },
  { level: '中风险', basis: '（i）项目具有有限的潜在不利环境和社会影响；（ii）影响并非前所未有；（iii）不存在或者仅有少量影响是不可逆的或累积性的；（iv）仅限于项目区域；并且（v）在运营过程中可通过良好实践做法控制影响', req: '要求客户对项目的环境和社会风险及影响进行初步审查。基于该审查的结果，与客户协商确定客户评估项目环境和社会风险及影响的适当工具' },
  { level: '低风险', basis: '项目可能产生极少或不存在环境和社会不利影响', req: '不要求进行环境和社会评估，但要求客户对项目的环境和社会层面进行分析' }
];

// --- UI Helper Components ---

const SummaryForm = ({ role, onSubmit }) => {
  const [pros, setPros] = useState("");
  const [cons, setCons] = useState("");
  const [scores, setScores] = useState({});

  const handleScoreChange = (targetRole, val) => {
     setScores(prev => ({...prev, [targetRole]: val}));
  };

  const handleSubmit = () => {
     const allScoresFilled = Object.keys(INITIAL_STATES).every(k => scores[k] && scores[k] !== "");
     if(!pros || !cons || !allScoresFilled) { alert("请填写优点、不足，并完成所有满意度评价"); return; }
     onSubmit(role, { pros, cons, scores });
  };

  return (
    <div className="space-y-3 pb-10">
       <div className="text-xs font-bold text-slate-700">请填写项目完工总结:</div>
       <div className="space-y-1">
          <span className="text-[10px]">项目优点/成功之处:</span>
          <Textarea className="min-h-[50px] text-[10px]" value={pros} onChange={e=>setPros(e.target.value)} />
       </div>
       <div className="space-y-1">
          <span className="text-[10px]">不足/待改进之处:</span>
          <Textarea className="min-h-[50px] text-[10px]" value={cons} onChange={e=>setCons(e.target.value)} />
       </div>
       <div className="space-y-2 border-t pt-2">
          <span className="text-[10px] font-bold">参与方满意度评价 (1-10): <span className="text-red-500">*必填</span></span>
          {Object.keys(INITIAL_STATES).map(k => (
             <div key={k} className="flex items-center justify-between text-[10px]">
                <span>{INITIAL_STATES[k].label} {k===role ? "(自评)" : ""}</span>
                <Input type="number" min={1} max={10} className="w-12 h-6 text-center" onChange={e=>handleScoreChange(k, e.target.value)}/>
             </div>
          ))}
       </div>
       <Button size="sm" className="w-full bg-green-600" onClick={handleSubmit}>提交总结</Button>
    </div>
  )
};

// Transition Overlay Component
const TransitionOverlay = ({ isVisible, stageTitle, extraText, onComplete }) => {
    // Req 1: 3 seconds instead of 5
    const [count, setCount] = useState(3);
    
    useEffect(() => {
        if (isVisible) {
            setCount(3); 
            const timer = setInterval(() => {
                setCount(prev => {
                    if (prev <= 1) {
                        clearInterval(timer);
                        return 0;
                    }
                    return prev - 1;
                });
            }, 1000);
            return () => clearInterval(timer);
        }
    }, [isVisible]);

    useEffect(() => {
        if (isVisible && count === 0) {
            onComplete();
        }
    }, [count, isVisible, onComplete]);

    if (!isVisible) return null;

    return (
        <div className="absolute inset-0 z-[100] bg-black/95 flex flex-col items-center justify-center text-white animate-in fade-in duration-300 text-center px-4">
            <h2 className="text-3xl font-bold mb-4">阶段流转中</h2>
            <div className="text-xl mb-2">{stageTitle}</div>
            {extraText && <div className="text-lg text-yellow-400 mb-6 max-w-2xl animate-pulse whitespace-pre-wrap">{extraText}</div>}
            <div className="text-6xl font-mono font-bold text-blue-400">{count}</div>
        </div>
    );
};

// Responsibility List Component - Fixed Scrollbar
const EsmpResponsibilityList = ({ ownerRespEsmp }) => (
    <div className="mt-2 border border-slate-200 rounded overflow-hidden flex flex-col max-h-[120px]">
        <div className="bg-slate-100 text-[10px] px-2 py-1 font-bold border-b border-slate-200 text-slate-600 flex justify-between items-center shrink-0">
           <span>ESMP 责任划分表</span>
           <ListChecks size={12}/>
        </div>
        {/* Constraint 1: Scrollbar fixed with h-[80px] overflow-y-auto */}
        <div className="flex-1 bg-white p-1 h-[80px] overflow-y-auto">
           {ESMP_LIBRARY.map(item => {
              const isOwner = ownerRespEsmp.includes(item.id);
              return (
                 <div key={item.id} className="flex items-center justify-between text-[9px] py-0.5 px-1 border-b border-slate-50 last:border-0">
                    <span className="text-slate-700 truncate max-w-[150px] leading-tight">{item.label}</span>
                    <Badge variant="outline" className={`text-[8px] h-3 px-1 leading-none ${isOwner ? 'text-blue-600 bg-blue-50 border-blue-100' : 'text-orange-600 bg-orange-50 border-orange-100'}`}>
                        {isOwner ? "业主" : "EPC"}
                    </Badge>
                 </div>
              )
           })}
        </div>
    </div>
);

// Crisis Context Component
const CrisisContextBox = ({ crisis }) => {
    if (!crisis) return null;
    return (
        <div className="bg-red-50 border border-red-200 rounded p-2 mb-2 text-[10px] text-slate-700 shrink-0">
            <div className="font-bold flex items-center gap-1 text-red-700 mb-1">
                <AlertTriangle size={12}/> 当前危机: {crisis.title}
            </div>
            <div className="leading-snug">{crisis.desc}</div>
            <div className="mt-1 text-[9px] text-slate-500 font-mono">关联ESMP: {ESMP_LIBRARY.find(i=>i.id===crisis.esmpId)?.label}</div>
        </div>
    );
};


function SunLinkESGSimV7_15_LeanCloud() {
  // --- 全局状态 ---
  const [viewMode, setViewMode] = useState('cover'); 
  const [gameTime, setGameTime] = useState(0);
  const [isTimerRunning, setIsTimerRunning] = useState(false);
  const [stage, setStage] = useState(1);
  const [logs, setLogs] = useState([]); 
  const [playerState, setPlayerState] = useState(INITIAL_STATES);
  
  // Timeline Tracking
  const [timeStart1, setTimeStart1] = useState(0); // Start of Game
  const [timeStart2, setTimeStart2] = useState(0); // Contract Signed
  const [timeEnd, setTimeEnd] = useState(0); // Acceptance Passed
  
  // Transition State
  const [isTransitioning, setIsTransitioning] = useState(false);
  const [transitionContext, setTransitionContext] = useState(null); // Stores next stage/crisis info

  // Floating Animations State
  const [floatEffects, setFloatEffects] = useState([]);
  const [financialAlerts, setFinancialAlerts] = useState({ owner: null, epc: null }); 
  
  // Idle State Info
  const [lastActionInfo, setLastActionInfo] = useState({
    owner: "等待立项审批启动...",
    gov: "等待业主提交ESIA...",
    mdb: "等待项目融资申请...",
    epc: "等待招标开始...",
    ngo: "等待ESIA公示..."
  });

  const [activeRole, setActiveRole] = useState('owner'); 

  // --- S1: ESIA ---
  const [s1State, setS1State] = useState('owner_draft');
  const [ownerEsiaSelection, setOwnerEsiaSelection] = useState([]);
  const [confirmedEsiaSelection, setConfirmedEsiaSelection] = useState([]);
  const [ngoRequirements, setNgoRequirements] = useState([]); 
  const [govMandates, setGovMandates] = useState([]);
  const [hasProtested, setHasProtested] = useState(false);
  const [s1Feedback, setS1Feedback] = useState(null);
  const [s1SubmissionCount, setS1SubmissionCount] = useState(1); 
  
  const [accumulatedNgoReqs, setAccumulatedNgoReqs] = useState([]);
  const [accumulatedGovMandates, setAccumulatedGovMandates] = useState([]);

  // --- S2: Financing ---
  const [s2State, setS2State] = useState('idle');
  const [riskLevel, setRiskLevel] = useState(null);
  const [ownerEscpSelection, setOwnerEscpSelection] = useState([]);
  const [confirmedEscpSelection, setConfirmedEscpSelection] = useState([]); 
  const [s2SubmissionCount, setS2SubmissionCount] = useState(1); 
  const [loanAmount] = useState(1500); 

  const [govEscpMandates, setGovEscpMandates] = useState([]);
  const [mdbEscpMandates, setMdbEscpMandates] = useState([]);
  const [accumulatedGovEscpReqs, setAccumulatedGovEscpReqs] = useState([]); 
  const [accumulatedMdbEscpReqs, setAccumulatedMdbEscpReqs] = useState([]);

  // --- S3: EPC Contract Negotiation ---
  const [s3State, setS3State] = useState('idle');
  const [tenderLimitPrice, setTenderLimitPrice] = useState(0);
  const [tenderDuration, setTenderDuration] = useState(20); 
  const [delayPenalty, setDelayPenalty] = useState(0); // 误期损害赔偿费 (万/月)
  const [earlyBonus, setEarlyBonus] = useState(0);     // 提前完工奖励 (万/月)
  const [ownerRespEsmp, setOwnerRespEsmp] = useState([]);
  const [epcRespEsmp, setEpcRespEsmp] = useState([]);
  const [epcBid, setEpcBid] = useState({ price: 0 }); 
  const [epcBidHistory, setEpcBidHistory] = useState([]); 
  
  // Req 2: Owner reject reason
  const [ownerRejectReason, setOwnerRejectReason] = useState("");

  // --- S3 -> S4 Transition (Planning & Audit) ---
  const [epcExecPlan, setEpcExecPlan] = useState([]);
  const [originalEpcExecPlan, setOriginalEpcExecPlan] = useState([]); 
  const [ownerAuditItems, setOwnerAuditItems] = useState([]);
  const [s3Phase, setS3Phase] = useState('tender'); 
  const [epcViolations, setEpcViolations] = useState([]); 

  // --- S4: Construction & Crisis ---
  const [s4State, setS4State] = useState('idle');
  const [crisisQueue, setCrisisQueue] = useState([]); 
  const [currentCrisis, setCurrentCrisis] = useState(null);
  const [s4Countdown, setS4Countdown] = useState(0); 
  const [resolutionMsg, setResolutionMsg] = useState(""); 
  
  // Crisis/Protest Events
  const [protestState, setProtestState] = useState('idle'); 
  const [protestHandler, setProtestHandler] = useState(null); 
  const [ngoDemandAmount, setNgoDemandAmount] = useState(0);
  const [ngoDemandReason, setNgoDemandReason] = useState(""); 
  const [offerAmount, setOfferAmount] = useState(0);
  const [partyOfferReason, setPartyOfferReason] = useState(""); 
  const [govRulingAmount, setGovRulingAmount] = useState(""); 
  const [govRulingReason, setGovRulingReason] = useState(""); 
  const [govRulingHistory, setGovRulingHistory] = useState([]);
  
  const [govRulingCount, setGovRulingCount] = useState(0);
  const [partyResponse, setPartyResponse] = useState(null); 
  const [ngoResponse, setNgoResponse] = useState(null);
  
  const [partyAppealInput, setPartyAppealInput] = useState('');
  // Req 4: Appeal Reason
  const [partyAppealReason, setPartyAppealReason] = useState('');

  const [ngoAppealInput, setNgoAppealInput] = useState('');
  // Req 4: Appeal Reason
  const [ngoAppealReason, setNgoAppealReason] = useState('');
  
  const [ownerPayDecisionReason, setOwnerPayDecisionReason] = useState(""); 
  const [epcProtestReason, setEpcProtestReason] = useState(""); 

  // Req 7: S4 Final Ruling Confirmation
  const [confirmedParties, setConfirmedParties] = useState([]);

  // Payment Tracking
  const [bankDisbursedPct, setBankDisbursedPct] = useState(0);
  const [ownerPaidPct, setOwnerPaidPct] = useState(0);
  const [finalContractPrice, setFinalContractPrice] = useState(0);
  const [finalContractDuration, setFinalContractDuration] = useState(0);
  const [finalDelayPenalty, setFinalDelayPenalty] = useState(0); 
  const [finalEarlyBonus, setFinalEarlyBonus] = useState(0);     

  const [bankFreezeDecision, setBankFreezeDecision] = useState(null); 

  // --- S5: T5 (Acceptance - New Logic) ---
  const [inspectionState, setInspectionState] = useState('idle'); 
  const [rejectReason, setRejectReason] = useState("");
  const [fixPlanText, setFixPlanText] = useState("");
  
  // New S5 States for negotiation
  const [ownerPayProposal, setOwnerPayProposal] = useState("");
  const [ownerFeedback, setOwnerFeedback] = useState("");
  const [epcClaimProposal, setEpcClaimProposal] = useState("");
  const [epcClaimReason, setEpcClaimReason] = useState("");
  const [s5GovRuling, setS5GovRuling] = useState("");
  const [s5GovRulingReason, setS5GovRulingReason] = useState(""); 
  
  // Req 8: S5 Ruling Confirmation
  const [s5ConfirmedParties, setS5ConfirmedParties] = useState([]);

  // --- S6: Summary ---
  const [summaryData, setSummaryData] = useState({});
  const [isSummarySubmitted, setIsSummarySubmitted] = useState({});

  // Helper to disable NGO button after clicking "no claim"
  const [ngoNoClaimDisabled, setNgoNoClaimDisabled] = useState(false);

  const scrollRef = useRef(null);

  // --- Timer ---
  useEffect(() => {
    let interval;
    if (isTimerRunning && !isTransitioning) interval = setInterval(() => {
        setGameTime(t => t + 1);
    }, 1000);
    return () => clearInterval(interval);
  }, [isTimerRunning, isTransitioning]);

  useEffect(() => {
    if (stage === 1 && logs.length === 0 && isTimerRunning) {
       addLog("当前为项目立项审批阶段，请业主开展项目环境社会影响评价（ESIA）", "blue");
    }
  }, [stage, logs, isTimerRunning]);

  // S4 Countdown Effect (Construction Start -> Crisis)
  useEffect(() => {
    if (s4State === 'construction_start' && s4Countdown > 0 && !isTransitioning) {
      const timer = setTimeout(() => setS4Countdown(c => c - 1), 1000);
      return () => clearTimeout(timer);
    } else if (s4State === 'construction_start' && s4Countdown === 0 && !isTransitioning) {
       // Start with index 0 explicitly
       startNextCrisis(crisisQueue, 0);
    }
  }, [s4State, s4Countdown, crisisQueue, isTransitioning]);


  // --- Helper Functions ---
  const addFloatEffect = (role, value) => {
    const key = `${role}-${value}-${Date.now()}`;
    setFloatEffects(prev => {
        const now = Date.now();
        // Req 1: Keep only for 3000ms
        const filtered = prev.filter(e => now - e.timestamp < 3000);
        const duplicate = filtered.find(e => e.role === role && e.value === value && now - e.timestamp < 1000);
        if (duplicate) return filtered;
        
        return [...filtered, { id: key, role, value, timestamp: now }];
    });
  };

  // Req 1: Ensure cleanup runs to remove old effects
  useEffect(() => {
      const timer = setInterval(() => {
          const now = Date.now();
          setFloatEffects(prev => prev.filter(e => now - e.timestamp < 3000));
      }, 1000);
      return () => clearInterval(timer);
  }, []);

  const updateStat = (role, key, val) => {
    if (val === 0) return;
    setPlayerState(prev => ({ ...prev, [role]: { ...prev[role], [key]: prev[role][key] + val } })); 
    addFloatEffect(role, val);
  };

  const updateLastAction = (role, text) => {
    setLastActionInfo(prev => ({ ...prev, [role]: text }));
  };

  const addLog = (msg, type = 'info') => {
    const fixedMsg = msg.replace(/EPC/g, "EPC承包商");
    const t = `${Math.floor(gameTime/60)}分${gameTime%60}秒`;
    setLogs(prev => [...prev, { msg: fixedMsg, type, time: t }]);
  };

  const setFinancialAlert = (role, msg) => {
      setFinancialAlerts(prev => ({...prev, [role]: msg}));
      setTimeout(() => setFinancialAlerts(prev => ({...prev, [role]: null})), 8000);
  };


  // --- Transition Logic (Refactored) ---
  const triggerStageTransition = (targetStage, title, extraText="", crisisIndex=null) => {
      setIsTransitioning(true);
      // Store context for the completion handler
      setTransitionContext({
          targetStage,
          crisisIndex,
          title,
          extraText
      });
  };

  const completeTransition = () => {
      setIsTransitioning(false);
      
      if (!transitionContext) return;

      const { targetStage, crisisIndex } = transitionContext;

      // Is this a crisis switch within Stage 4?
      if (targetStage === 4 && crisisIndex !== null) {
          const crisis = crisisQueue[crisisIndex];
          if (crisis) {
             setCurrentCrisis({ ...crisis, index: crisisIndex });
             setS4State(`t${crisisIndex+1}_crisis`);
             setProtestState('ngo_decide'); setActiveRole('ngo');
             
             // Reset crisis-specific states
             setNgoDemandAmount(0);
             setNgoDemandReason("");
             setOfferAmount(0);
             setPartyOfferReason("");
             setGovRulingCount(0);
             setGovRulingHistory([]);
             setBankFreezeDecision(null);
             setNgoNoClaimDisabled(false); 
             setPartyAppealInput('');
             setPartyAppealReason('');
             setNgoAppealInput('');
             setNgoAppealReason('');
             setGovRulingAmount(""); // Reset
             setGovRulingReason("");
             setOwnerPayDecisionReason("");
             setEpcProtestReason("");
             setConfirmedParties([]); // Reset for Req 7
         
             addLog(`危机爆发 (${crisisIndex+1}/4): [${crisis.title}]`, 'red');
          }
          return;
      }

      // Standard Stage Switch
      setStage(targetStage);
      
      if (targetStage === 2) {
        // Req 2: Triggered after Gov approval overlay
        setS2State('owner_apply'); 
        setActiveRole('owner');
        addLog('进入项目融资阶段。请业主向银行申请贷款。', 'purple');
      } else if (targetStage === 3) {
        setS3State('owner_tender'); 
        setActiveRole('owner');
        addLog(`项目融资协议已签署，多边开发银行贷款1500万（分阶段拨付），融资关闭，进入EPC合同谈判阶段。`, 'green');
      } else if (targetStage === 4) {
        // Req 3: Triggered after EPC confirms contract sign
        setS4State('s4_planning'); 
        setActiveRole('epc');
        setS3Phase('planning'); 
        addLog('进入项目建设阶段(S4)。请承包商编制ESMP执行方案。', 'orange');
      } else if (targetStage === 5) {
         setS4State('finished'); 
         setInspectionState('epc_apply'); 
         setActiveRole('epc');
         addLog('S4阶段结束。进入S5验收与后评价阶段。', 'green');
      } else if (targetStage === 6) {
         // Req 8: Triggered after S5 final ruling confirmations
         setIsTimerRunning(false);
         setActiveRole('all');
         addLog('项目竣工移交。进入总结阶段。', 'green');
      }
  };

  const startSim = () => {
      setTimeStart1(0); 
      setViewMode('game');
      setIsTimerRunning(true);
      triggerStageTransition(1, "项目立项审批阶段");
  }

  // Payment Logic
  const processScheduledPayment = (crisisIndex) => {
     const ratio = crisisIndex === 3 ? 0.15 : 0.20;
     const ratioTxt = crisisIndex === 3 ? "15%" : "20%";
     
     let ownerPayAmt = 0;

     const nextBankPct = Math.min(bankDisbursedPct + (ratio*100), 95);
     const actualBankDisbursed = nextBankPct - bankDisbursedPct; 
     
     if (actualBankDisbursed > 0.1) { 
         const bankPay = loanAmount * (actualBankDisbursed / 100);
         updateStat('owner', 'money', bankPay);
         setBankDisbursedPct(nextBankPct);
         setFinancialAlert('owner', `银行拨付${ratioTxt}贷款: +$${bankPay.toFixed(1)}万`);
     }

     // Calculate Owner Payment
     const nextOwnerPct = Math.min(ownerPaidPct + (ratio*100), 95);
     const actualOwnerPaid = nextOwnerPct - ownerPaidPct;
     
     if (actualOwnerPaid > 0.1) {
         const ownerPay = finalContractPrice * (actualOwnerPaid / 100);
         updateStat('owner', 'money', -ownerPay);
         updateStat('epc', 'money', ownerPay);
         setOwnerPaidPct(nextOwnerPct);
         ownerPayAmt = ownerPay;
         setFinancialAlert('owner', `支付进度款: -$${ownerPay.toFixed(1)}万`);
         setFinancialAlert('epc', `收到进度款: +$${ownerPay.toFixed(1)}万`);
     }
     
     addLog(`资金流转(自动): 银行拨付${ratioTxt}，业主支付${ratioTxt}进度款。`, 'green');
     return ownerPayAmt;
  };


  // --- 阶段流转逻辑 ---

  // Stage 1
  const s1OwnerSubmit = () => {
    const multiplier = 1.0 + (s1SubmissionCount - 1) * 0.2;
    const newItems = ownerEsiaSelection.filter(id => !confirmedEsiaSelection.includes(id));
    
    const newCost = newItems.reduce((sum, id) => sum + (ESIA_ITEMS.find(i=>i.id===id).cost * multiplier), 0);
    if (newCost > 0) {
        updateStat('owner', 'money', -Math.round(newCost));
    }

    setConfirmedEsiaSelection([...ownerEsiaSelection]);
    setS1State('ngo_eval'); setActiveRole('ngo');
    setS1Feedback(null);
    
    const itemNames = ownerEsiaSelection.map(id => ESIA_ITEMS.find(i=>i.id===id).label).join('; ');
    updateLastAction('owner', `已提交ESIA: ${ownerEsiaSelection.length}项`);
    addLog(`业主提交ESIA方案。包含评价: ${itemNames || "无"}。`, 'blue');
  };

  const s1NgoEval = (protest) => {
    setHasProtested(protest);
    if (protest) {
       const newReqs = ngoRequirements.filter(id => !accumulatedNgoReqs.includes(id));
       if (newReqs.length > 0) {
         const protestCost = newReqs.length * 2;
         const repGain = newReqs.length * 2;
         updateStat('ngo', 'benefit', -protestCost); 
         updateStat('ngo', 'reputation', repGain);
         setAccumulatedNgoReqs(prev => [...prev, ...newReqs]);
       }
       const reqNames = ngoRequirements.map(id => ESIA_ITEMS.find(i=>i.id===id).label).join('; ');
       updateLastAction('ngo', `抗议并要求: ${ngoRequirements.length}项补充`);
       addLog(`公众提出抗议，需补充以下ESIA专项评价：${reqNames}`, 'red');
    } else {
       updateLastAction('ngo', `无异议`);
       addLog(`公众无异议。`, 'gray');
    }
    setS1State('gov_review'); setActiveRole('gov');
  };

  const s1GovReview = (approve) => {
    const govSelectedIds = approve ? confirmedEsiaSelection : [...confirmedEsiaSelection, ...govMandates];
    const newGovMandates = govMandates.filter(id => !accumulatedGovMandates.includes(id));
    
    const repGain = newGovMandates.length * 1;
    const allPublicReqs = [...new Set([...accumulatedNgoReqs, ...ngoRequirements])];
    const finalList = approve ? confirmedEsiaSelection : [...confirmedEsiaSelection, ...govMandates];
    const unmetPublicReqs = allPublicReqs.filter(id => !finalList.includes(id));
    const repPenalty = unmetPublicReqs.length * 2;
    const netRepChange = repGain - repPenalty;
    
    if (netRepChange !== 0) updateStat('gov', 'reputation', netRepChange);

    if (approve) {
      updateLastAction('gov', `批准立项。`);
      addLog(`政府批准ESIA。政府声誉变动: ${netRepChange}`, netRepChange >= 0 ? 'green' : 'orange');
      
      // Req 2: Trigger 3s overlay, THEN S2 owner apply logic in completeTransition
      triggerStageTransition(2, "项目融资阶段", "政府已批准立项，项目正式进入融资流程。");
      return; 
      
    } else {
      if (newGovMandates.length > 0) {
          const govCost = newGovMandates.length * 2;
          updateStat('gov', 'cost', govCost);
          setAccumulatedGovMandates(prev => [...prev, ...newGovMandates]);
      }
      
      const allExtras = [...new Set([...ngoRequirements, ...govMandates])];
      const uniqueMissedItems = allExtras.filter(id => !confirmedEsiaSelection.includes(id));
      const ownerPenalty = uniqueMissedItems.length * 3;
      
      if (ownerPenalty > 0) {
         updateStat('owner', 'reputation', -ownerPenalty);
      }

      const mandateNames = govMandates.map(id => ESIA_ITEMS.find(i=>i.id===id).label).join('; ');
      let fb = `政府驳回ESIA。要求补充: ${mandateNames}`;
      
      updateLastAction('gov', `驳回并要求补充: ${govMandates.length}项`);
      setS1Feedback(fb);
      addLog(`${fb}。业主声誉 -${ownerPenalty}`, 'red'); 
      
      setS1State('owner_draft'); setActiveRole('owner');
      setS1SubmissionCount(c => c + 1);
    }
  };

  // Stage 2
  const s2OwnerApply = () => {
      setS2State('risk_assess'); setActiveRole('mdb');
      updateLastAction('owner', '申请融资1500万');
      addLog('业主申请项目融资1500万。', 'blue');
  };

  const s2MdbRisk = (lvl) => {
    setRiskLevel(lvl);
    setS2State('owner_escp'); setActiveRole('owner');
    updateLastAction('mdb', `评定风险为: ${lvl}`);
    addLog(`S2: 银行评级为 ${lvl}。请业主选择ESCP。`, 'purple');
  };

  const s2OwnerEscp = () => {
    const multiplier = 1.0 + (s2SubmissionCount - 1) * 0.2;
    const newItems = ownerEscpSelection.filter(id => !confirmedEscpSelection.includes(id));
    const cost = newItems.reduce((sum, id) => sum + (ESMP_LIBRARY.find(i=>i.id===id).cost * multiplier), 0);
    
    if (cost > 0) updateStat('owner', 'money', -Math.round(cost));

    setConfirmedEscpSelection([...ownerEscpSelection]); 
    setS2State('gov_check'); setActiveRole('gov');
    updateLastAction('owner', `提交ESCP: ${ownerEscpSelection.length}项`);
    addLog('S2: 业主提交ESCP承诺。', 'blue');
  };

  const s2GovCheck = (pass) => {
    if (pass) {
      setS2State('mdb_sign'); setActiveRole('mdb');
      updateLastAction('gov', '通过业主ESCP');
      addLog('S2: 政府通过业主ESCP。', 'green');
    } else {
      const addedItems = govEscpMandates.filter(id => !accumulatedGovEscpReqs.includes(id));
      if (addedItems.length > 0) {
          const costIncrease = addedItems.length * 2; 
          const repIncrease = addedItems.length * 2; 
          const ownerRepDrop = addedItems.length * 3;

          updateStat('gov', 'cost', costIncrease);
          updateStat('gov', 'reputation', repIncrease);
          updateStat('owner', 'reputation', -ownerRepDrop);
          setAccumulatedGovEscpReqs(prev => [...prev, ...addedItems]);
      }
      setS2State('owner_escp'); setActiveRole('owner');
      setS2SubmissionCount(c => c + 1); 
      updateLastAction('gov', '驳回业主ESCP');
      addLog(`S2: 政府驳回业主ESCP。要求补充: ${addedItems.map(id=>ESMP_LIBRARY.find(x=>x.id===id).label).join(', ')}`, 'red');
    }
  };

  const s2MdbSign = (sign) => {
    if (sign) {
      updateStat('owner', 'money', 300);
      setBankDisbursedPct(20);
      setFinancialAlert('owner', "银行首笔拨款: +$300万");
      
      updateLastAction('mdb', '签署贷款协议');
      triggerStageTransition(3, "EPC合同谈判阶段");
      return;
    } else {
      const addedItems = mdbEscpMandates.filter(id => !confirmedEscpSelection.includes(id)); 
      if (addedItems.length > 0) {
        const costIncrease = addedItems.length * 2; 
        const repIncrease = addedItems.length * 2; 
        const ownerRepDrop = addedItems.length * 3;

        updateStat('mdb', 'cost', costIncrease);
        updateStat('mdb', 'reputation', repIncrease);
        updateStat('owner', 'reputation', -ownerRepDrop);
        setAccumulatedMdbEscpReqs(prev => [...prev, ...addedItems]);
      }
      setS2State('owner_escp'); setActiveRole('owner');
      setS2SubmissionCount(c => c + 1);
      updateLastAction('mdb', '拒绝贷款');
      addLog(`S2: 银行拒绝贷款。要求补充: ${addedItems.map(id=>ESMP_LIBRARY.find(x=>x.id===id).label).join(', ')}`, 'purple');
    }
  };

  // Stage 3
  const s3OwnerTender = () => {
    setEpcRespEsmp(ESMP_LIBRARY.map(i => i.id).filter(id => !ownerRespEsmp.includes(id)));
    
    setS3State('epc_bid'); setActiveRole('epc');
    updateLastAction('owner', `发布招标文件。自管${ownerRespEsmp.length}项，工期${tenderDuration}月`);
    addLog(`S3: 业主发标。自管ESMP: ${ownerRespEsmp.length}项。工期要求: ${tenderDuration}个月。误期罚款:${delayPenalty}万/月, 提前奖励:${earlyBonus}万/月`, 'blue');
  };

  const s3EpcBid = () => {
    // Reset rejection reason on new bid
    setOwnerRejectReason("");
    const newBid = { ...epcBid, duration: tenderDuration, round: epcBidHistory.length + 1 };
    setEpcBidHistory([...epcBidHistory, newBid]);
    setS3State('owner_eval'); setActiveRole('owner');
    updateLastAction('epc', `投标报价: $${epcBid.price}万`);
    addLog(`S3: EPC承包商提交第${newBid.round}轮报价: $${epcBid.price}万。`, 'orange');
  };

  const s3OwnerEval = (accept) => {
    if (accept) {
      setFinalContractPrice(epcBid.price);
      setFinalContractDuration(tenderDuration);
      setFinalDelayPenalty(delayPenalty);
      setFinalEarlyBonus(earlyBonus);
      setTimeStart2(gameTime); 
      
      updateLastAction('owner', '接受EPC投标');
      addLog(`S3: 业主接受投标。合同价: $${epcBid.price}万, 工期: ${tenderDuration}月。`, 'green');
      
      // Req 3: EPC interface notification first
      setS3State('epc_contract_sign'); setActiveRole('epc');
      addLog(`系统：等待EPC承包商签署确认合同。`, 'orange');
      
    } else {
      setS3State('epc_bid'); setActiveRole('epc');
      updateLastAction('owner', '驳回EPC投标');
      
      // Req 2: Feedback reason
      let logMsg = 'S3: 业主驳回投标。';
      if (ownerRejectReason) {
          logMsg += ` 理由: ${ownerRejectReason}`;
      }
      addLog(logMsg, 'red');
    }
  };
  
  // Req 3: EPC confirms contract sign
  const s3EpcSignConfirm = () => {
      triggerStageTransition(4, "项目建设阶段", `合同签约完成。\n合同价: $${epcBid.price}万\n工期: ${tenderDuration}个月\n误期罚款: ${delayPenalty}万/月\n提前奖励: ${earlyBonus}万/月`);
  };

  // S4 (Planning first, then Construction)
  const s4EpcPlan = () => {
    setOriginalEpcExecPlan([...epcExecPlan]);
    setS4State('s4_audit'); setActiveRole('owner');
    updateLastAction('epc', '提交执行方案');
    addLog('S4: EPC承包商提交ESMP执行方案，等待业主审计。', 'orange');
  };

  const s4OwnerAudit = () => {
    const auditCost = ownerAuditItems.length * 5;
    updateStat('owner', 'money', -auditCost);
    addLog(`S4: 业主执行抽查，花费$${auditCost}万。`, 'blue');

    const violations = ownerAuditItems.filter(id => !epcExecPlan.includes(id) && epcRespEsmp.includes(id));
    
    if (violations.length > 0) {
       const repDrop = violations.length * 5;
       updateStat('epc', 'reputation', -repDrop);
       setEpcViolations(violations);
       setS4State('s4_punish_decide'); setActiveRole('owner'); // Punishment state
       updateLastAction('owner', `发现${violations.length}项违规`);
       addLog(`S4: 审计发现 ${violations.length} 项违规！承包商声誉 -${repDrop}。`, 'red');
    } else {
       updateLastAction('owner', '审计通过');
       // Req 4: Ask EPC confirmation
       addLog('S4: 审计通过。等待承包商确认。', 'green');
       
       setS4State('epc_audit_pass_confirm'); setActiveRole('epc');
    }
  };

  const s4OwnerPunishDecide = (action) => {
     if (action === 'rectify') {
        setEpcExecPlan(prev => [...new Set([...prev, ...epcViolations])]);
        setS4State('s4_epc_replan'); setActiveRole('epc');
        updateLastAction('owner', '责令整改');
        addLog('S4: 业主责令整改。', 'blue');
     } else {
        updateLastAction('owner', '直接通过');
        addLog('S4: 业主选择放行。', 'gray');
        setS4State('epc_audit_pass_confirm'); setActiveRole('epc');
     }
  };

  const s4EpcReplanSubmit = () => {
     const stillMissing = epcViolations.filter(id => !epcExecPlan.includes(id));
     if (stillMissing.length > 0) {
        alert("整改方案必须包含被业主查出的漏项！");
        return;
     }
     setS4State('s4_owner_reaudit'); setActiveRole('owner');
     updateLastAction('epc', '提交整改方案');
     addLog('S4: EPC承包商提交整改方案。', 'orange');
  };

  const s4OwnerReaudit = () => {
     updateLastAction('owner', '复查通过');
     addLog('S4: 整改复查通过。', 'green');
     setS4State('epc_audit_pass_confirm'); setActiveRole('epc');
  };
  
  // Req 4: EPC confirms audit pass -> trigger crisis
  const s4EpcConfirmAuditPass = () => {
     prepareS4Construction();
     setS4State('construction_start');
     setS4Countdown(5); 
  };

  // Prepare logic
  const prepareS4Construction = () => {
    const missedItems = epcRespEsmp.filter(id => !epcExecPlan.includes(id));
    let candidates = [...ESMP_LIBRARY];
    let selected = [];
    
    const missedCandidates = candidates.filter(c => missedItems.includes(c.id));
    missedCandidates.sort(() => 0.5 - Math.random());
    selected = [...missedCandidates];
    
    const otherCandidates = candidates.filter(c => !missedItems.includes(c.id));
    otherCandidates.sort(() => 0.5 - Math.random());
    selected = [...selected, ...otherCandidates].slice(0, 4); // Ensure 4 items
    
    const queue = selected.map((item, idx) => ({
       time: `t${idx+1}`,
       esmpId: item.id,
       title: item.crisisTitle,
       desc: item.crisisDesc
    }));
    setCrisisQueue(queue);

    const ownerPay = finalContractPrice * 0.2;
    updateStat('owner', 'money', -ownerPay);
    updateStat('epc', 'money', ownerPay);
    setOwnerPaidPct(20);
    
    setFinancialAlert('owner', `支付预付款(20%): -$${ownerPay.toFixed(1)}万`);
    setFinancialAlert('epc', `收到预付款(20%): +$${ownerPay.toFixed(1)}万`);

    // Req 3: Log modification
    addLog(`资金流转: 业主支付预付款$${ownerPay}万(20%)。`, 'green');
  }

  const startNextCrisis = (queue, index) => {
     if (isTransitioning) return;

     setS4State('s4_transitioning'); 

     if (index >= queue.length) {
        // Transition to S5
        triggerStageTransition(5, "验收与后评价阶段");
        return;
     }
     
     triggerStageTransition(4, "施工推进中", `项目建设按计划推进，突然……`, index);
  };

  // Crisis Flow
  const protestNgoDecide = (claim) => {
     if (claim) {
        updateStat('ngo', 'benefit', -10);
        updateStat('ngo', 'reputation', 10);
        setProtestState('ngo_input_demand');
        updateLastAction('ngo', '决定索赔');
        addLog('公众决定索赔 (成本10万, 声誉+10)。', 'red');
     } else {
        setNgoNoClaimDisabled(true);
        updateStat('ngo', 'reputation', -10);
        updateLastAction('ngo', '放弃索赔');
        addLog('公众放弃索赔 (声誉-10)。项目继续。', 'gray');
        resolveCrisis(false, true, "公众放弃索赔，危机解除。"); 
     }
  };

  const protestNgoSubmitDemand = () => {
    const esmpId = currentCrisis.esmpId;
    let responsible = 'epc';
    if (ownerRespEsmp.includes(esmpId)) responsible = 'owner';
    
    updateStat(responsible, 'reputation', -20);
    const other = responsible === 'owner' ? 'epc' : 'owner';
    updateStat(other, 'reputation', -10);
    
    addLog(`系统判定: 实际责任方为 ${responsible==='owner'?'业主':'EPC承包商'}。`, 'orange');
    addLog(`声誉惩罚: 责任方-20, 非责任方-10。`, 'red');

    setProtestHandler(responsible); 
    setProtestState('owner_route'); setActiveRole('owner'); 
    updateLastAction('ngo', `索赔 $${ngoDemandAmount}万`);
    
    // Log the reason
    if (ngoDemandReason) {
        addLog(`公众索赔理由: ${ngoDemandReason}`, 'red');
    }
  };

  const protestOwnerRoute = (handleSelf) => {
    if (handleSelf) {
        setProtestHandler('owner');
        setProtestState('party_negotiate'); setActiveRole('owner');
        updateLastAction('owner', '决定自行处理');
        addLog('业主决定自行处理危机。', 'blue');
    } else {
        setProtestHandler('epc');
        setProtestState('epc_route_check'); setActiveRole('epc');
        updateLastAction('owner', '转交EPC承包商处理');
        addLog('业主将危机转交EPC承包商处理。', 'orange');
    }
  };

  const protestEpcRouteCheck = (accept) => {
     if (accept) {
         setProtestState('party_negotiate'); setActiveRole('epc');
         updateLastAction('epc', '接受处理');
         addLog('EPC承包商接受处理危机。', 'blue');
     } else {
         setProtestHandler('owner');
         setProtestState('owner_route'); setActiveRole('owner');
         updateLastAction('epc', '拒绝并退回业主');
         addLog('EPC承包商拒绝处理，退回给业主。', 'red');
     }
  };

  const protestPartyNegotiate = (amount) => {
     setOfferAmount(amount);
     setProtestState('ngo_response'); setActiveRole('ngo');
     updateLastAction(protestHandler, `主张 $${amount}万`); 
     addLog(`${protestHandler==='owner'?'业主':'EPC承包商'} 主张赔偿 $${amount}万。`, 'blue');
     
     if (partyOfferReason) {
        addLog(`责任方主张理由: ${partyOfferReason}`, 'blue');
     }
  };

  const protestNgoResponse = (accept) => {
     if (accept) {
        updateStat(protestHandler, 'money', -offerAmount);
        updateStat('ngo', 'benefit', offerAmount); 
        addLog(`公众接受赔偿。危机解除。`, 'green');
        
        setFinancialAlert(protestHandler, `支付赔偿金: -$${offerAmount}万`);

        resolveCrisis(false, true, `双方达成一致，${protestHandler==='owner'?'业主':'EPC承包商'}支付赔偿金$${offerAmount}万。`); 
     } else {
        addLog('公众拒绝赔偿。政府介入。', 'red');
        setProtestState('gov_ruling'); setActiveRole('gov');
     }
  };

  const protestGovRuling = (amount) => {
     const numAmount = Number(amount);
     const count = govRulingCount + 1;
     setGovRulingCount(count);
     
     // Req 4: Store history with reasons
     const historyItem = { 
         count, 
         amount: numAmount, 
         ngoDemand: ngoDemandAmount, 
         ngoReason: ngoDemandReason,
         partyOffer: offerAmount,
         partyReason: partyOfferReason,
         // Capture appeal reasons from current round if available
         appealReasonParty: partyAppealReason,
         appealReasonNgo: ngoAppealReason
     }; 
     setGovRulingHistory([...govRulingHistory, historyItem]);

     updateLastAction('gov', `第${count}次裁决: $${numAmount}万`);
     
     if (govRulingReason) {
        addLog(`政府裁决理由: ${govRulingReason}`, 'purple');
     }
     
     if (count >= 3) {
        addLog(`政府终局裁决: $${numAmount}万。强制执行。`, 'purple');
        
        // Req 5: Show ruling result first before bank decision
        setProtestState('ruling_result_display'); setActiveRole('all');
     } else {
        addLog(`政府第${count}次裁决下达。等待双方表态。`, 'blue');
        setPartyResponse(null);
        setNgoResponse(null);
        setPartyAppealInput('');
        setPartyAppealReason(''); // Reset
        setNgoAppealInput('');
        setNgoAppealReason(''); // Reset
        setProtestState('parties_react_ruling'); setActiveRole('all'); 
     }
  };
  
  // Req 7: Acknowledgement Step with double confirmation
  const acknowledgeRulingResult = (role) => {
     const newConfirmed = [...confirmedParties, role];
     setConfirmedParties(newConfirmed);
     
     // Need both 'ngo' and 'party' (owner or epc) to confirm
     const hasNgo = newConfirmed.includes('ngo');
     const hasParty = newConfirmed.includes(protestHandler);

     if (hasNgo && hasParty) {
         const numAmount = Number(govRulingAmount);
         updateStat(protestHandler, 'money', -numAmount);
         updateStat('ngo', 'benefit', numAmount);
         setFinancialAlert(protestHandler, `强制支付赔偿: -$${numAmount}万`);

         setProtestState('bank_decision'); setActiveRole('mdb');
     }
  };

  const submitPartyReaction = (type, appealVal, appealReas) => {
      setPartyResponse(type);
      setOfferAmount(type === 'accept' ? Number(govRulingAmount) : Number(appealVal));
      if (type === 'appeal') {
          setPartyAppealReason(appealReas); // Save reason for Gov to see
          if(appealReas) addLog(`责任方申诉理由: ${appealReas}`, 'blue');
      }
  };

  const submitNgoReaction = (type, appealVal, appealReas) => {
      setNgoResponse(type);
      setNgoDemandAmount(type === 'accept' ? Number(govRulingAmount) : Number(appealVal)); 
      if (type === 'appeal') {
          setNgoAppealReason(appealReas); // Save reason for Gov to see
          if(appealReas) addLog(`公众申诉理由: ${appealReas}`, 'red');
      }
  };

  useEffect(() => {
    if (protestState === 'parties_react_ruling' && partyResponse && ngoResponse) {
        const rulingVal = Number(govRulingAmount);
        if (partyResponse === 'accept' && ngoResponse === 'accept') {
           updateStat(protestHandler, 'money', -rulingVal);
           updateStat('ngo', 'benefit', rulingVal);
           
           setFinancialAlert(protestHandler, `支付赔偿金: -$${rulingVal}万`);

           addLog('双方接受裁决。危机解除。', 'green');
           resolveCrisis(false, true, `双方接受政府裁决，${protestHandler==='owner'?'业主':'EPC承包商'}支付赔偿金$${rulingVal}万。`);
        } else {
           addLog('一方或双方提出申诉，进入下一轮裁决。', 'orange');
           setTimeout(() => {
               setGovRulingAmount(""); 
               setGovRulingReason(""); 
               setProtestState('gov_ruling'); setActiveRole('gov');
           }, 1000);
        }
    }
  }, [partyResponse, ngoResponse, protestState]);


  const protestBankDecision = (freeze) => {
     setBankFreezeDecision(freeze ? 'freeze' : 'continue');
     const ratioTxt = currentCrisis.index === 3 ? "15%" : "20%";
     updateLastAction('mdb', freeze ? `暂停拨付${ratioTxt}贷款` : '继续拨付贷款');
     
     addLog(`多边开发银行决定: ${freeze?'暂停':'继续'}拨付贷款。通知业主。`, 'purple');
     
     setProtestState('owner_pay_decision'); setActiveRole('owner');
  };

  const protestOwnerPayDecision = (pay) => {
     const ratioTxt = currentCrisis.index === 3 ? "15%" : "20%";
     updateLastAction('owner', pay ? '支付进度款' : `暂停支付${ratioTxt}进度款`);
     
     let msg = "危机结束。";

     if (ownerPayDecisionReason) {
         addLog(`业主决策理由: ${ownerPayDecisionReason}`, pay ? 'green' : 'red');
     }
     
     if (bankFreezeDecision === 'continue') {
        const ratio = currentCrisis.index === 3 ? 0.15 : 0.20;
        
        const nextBankPct = Math.min(bankDisbursedPct + (ratio*100), 95);
        const actualBankDisbursed = nextBankPct - bankDisbursedPct;

        if (actualBankDisbursed > 0.1) {
            const bankPay = loanAmount * (actualBankDisbursed/100);
            updateStat('owner', 'money', bankPay); 
            setBankDisbursedPct(nextBankPct);
            setFinancialAlert('owner', `银行拨款: +$${bankPay.toFixed(1)}万`);
        }
     }
     
     if (pay) {
        const ratio = currentCrisis.index === 3 ? 0.15 : 0.20;
        
        const nextOwnerPct = Math.min(ownerPaidPct + (ratio*100), 95);
        const actualOwnerPaid = nextOwnerPct - ownerPaidPct;
        
        if (actualOwnerPaid > 0.1) {
            const ownerPay = finalContractPrice * (actualOwnerPaid/100);
            updateStat('owner', 'money', -ownerPay);
            updateStat('epc', 'money', ownerPay);
            setOwnerPaidPct(nextOwnerPct);
            
            setFinancialAlert('owner', `支付进度款: -$${ownerPay.toFixed(1)}万`);
            setFinancialAlert('epc', `收到进度款: +$${ownerPay.toFixed(1)}万`);
            
            addLog(`业主决定: 支付${ratioTxt}进度款。通知承包商。`, 'green');
            msg = `业主决定继续支付进度款 ($${ownerPay.toFixed(1)}万)。`;
            resolveCrisis(false, false, msg);
        } else {
            addLog('业主决定支付，但支付比例已达上限(95%)。', 'gray');
            msg = "业主决定支付，但已达支付上限。";
            resolveCrisis(false, false, msg);
        }
     } else {
        setProtestState('epc_notify_freeze'); setActiveRole('epc');
        addLog('业主决定: 暂停支付进度款。通知承包商。', 'red');
     }
  };

  const protestEpcNotifyFreeze = (protest) => {
     if (protest) {
         setProtestState('owner_reconsider_pay'); setActiveRole('owner');
         addLog('承包商反对暂停支付，要求业主重新考虑。', 'orange');
         if (epcProtestReason) {
             addLog(`承包商抗议理由: ${epcProtestReason}`, 'orange');
         }
     } else {
         const msg = "业主决定暂停支付进度款。承包商知悉。";
         resolveCrisis(false, false, msg);
     }
  };

  const protestOwnerReconsider = (pay) => {
      if (pay) {
         protestOwnerPayDecision(true);
      } else {
         setProtestState('epc_notify_freeze'); setActiveRole('epc');
         addLog('业主坚持暂停支付。通知承包商。', 'red');
      }
  };

  const resolveCrisis = (skipped, autoPay, customMsg) => {
     if (autoPay) {
        processScheduledPayment(currentCrisis.index);
     }
     
     const finalMsg = customMsg || "本轮危机处理完毕，进入下一阶段。";
     setResolutionMsg(finalMsg);
     setS4State('s4_resolution'); // New resolution state
     setActiveRole('all');

     addLog('危机结束。进入结算界面。', 'green');
     
     // Wait 4 seconds then transition to next crisis
     const nextIndex = currentCrisis.index + 1;
     setTimeout(() => {
        startNextCrisis(crisisQueue, nextIndex);
     }, 4000); 
  };

  // --- S5: Acceptance (Requirement 11-14 Revised) ---
  const s5EpcApply = () => {
     setInspectionState('owner_decide_pay'); setActiveRole('owner');
     updateLastAction('epc', '申请竣工验收');
     addLog('承包商申请竣工验收。', 'orange');
  };

  const s5OwnerSubmitProposal = () => {
     const proposal = parseFloat(ownerPayProposal);
     // Constraint 3: proposal >= ownerPaidPct && proposal <= 100
     if (isNaN(proposal) || proposal < ownerPaidPct || proposal > 100) {
         alert(`支付比例必须在 ${ownerPaidPct}% 到 100% 之间`);
         return;
     }
     if (!ownerFeedback) {
         alert("请填写反馈意见");
         return;
     }

     setTimeEnd(gameTime); // Record end time per Req 11
     setInspectionState('epc_review_proposal'); setActiveRole('epc');
     updateLastAction('owner', `通过验收，拟付至${proposal}%`);
     addLog(`业主通过质量验收。拟支付至${proposal}%。意见: ${ownerFeedback}`, 'blue');
  };

  const s5EpcReview = (accept) => {
      if (accept) {
         finalizeSettlement(parseFloat(ownerPayProposal));
      } else {
         setInspectionState('epc_appeal_input');
      }
  };

  const s5EpcSubmitAppeal = () => {
      if (!epcClaimProposal || !epcClaimReason) { alert("请填写完整"); return; }
      const val = parseFloat(epcClaimProposal);
      // Constraint 4: val >= ownerPaidPct && val <= 100
      if (isNaN(val) || val < ownerPaidPct || val > 100) {
         alert(`申诉比例必须在 ${ownerPaidPct}% 到 100% 之间`);
         return;
      }

      setInspectionState('gov_s5_ruling'); setActiveRole('gov');
      updateLastAction('epc', `申诉：要求付至${epcClaimProposal}%`);
      addLog(`承包商拒绝接受，发起申诉。主张支付至${epcClaimProposal}%。`, 'red');
  };

  const s5GovMakeRuling = () => {
      const ruling = parseFloat(s5GovRuling);
      // Constraint 5: ruling >= ownerPaidPct && ruling <= 100
      if (isNaN(ruling) || ruling < ownerPaidPct || ruling > 100) {
          alert(`裁决比例必须在 ${ownerPaidPct}% 到 100% 之间`);
          return;
      }
      
      // 1. Publish result and reason
      addLog(`政府裁决：业主应支付至${ruling}%。`, 'purple');
      if (s5GovRulingReason) {
          addLog(`裁决理由：${s5GovRulingReason}`, 'purple');
      }

      // Req 8: Transition to S5 Ruling Confirmation (New State)
      setInspectionState('s5_ruling_result'); setActiveRole('all');
  };

  // Req 8: S5 Final Confirmation
  const s5AcknowledgeRuling = (role) => {
     const newConfirmed = [...s5ConfirmedParties, role];
     setS5ConfirmedParties(newConfirmed);

     // Need Owner and EPC to confirm
     const hasOwner = newConfirmed.includes('owner');
     const hasEpc = newConfirmed.includes('epc');

     if (hasOwner && hasEpc) {
        finalizeSettlement(parseFloat(s5GovRuling));
     }
  };

  const finalizeSettlement = (finalPct) => {
      const diffPct = finalPct - ownerPaidPct;
      if (diffPct > 0) {
           const payAmt = finalContractPrice * (diffPct / 100);
           updateStat('owner', 'money', -payAmt);
           updateStat('epc', 'money', payAmt);
           setOwnerPaidPct(finalPct);
           
           setFinancialAlert('owner', `支付结算款: -$${payAmt.toFixed(1)}万`);
           setFinancialAlert('epc', `收到结算款: +$${payAmt.toFixed(1)}万`);
      }

      // Penalty/Bonus Calc
      const actualTime = timeEnd; // Use recorded time
      const actualMonths = Math.round((actualTime - timeStart2) / 60); 
      const deviation = actualMonths - finalContractDuration;
      
      let bonusPenaltyText = "";
      if (deviation > 0) {
             if (finalDelayPenalty > 0) {
                 const penaltyAmt = deviation * finalDelayPenalty;
                 updateStat('epc', 'money', -penaltyAmt);
                 updateStat('owner', 'money', penaltyAmt);
                 bonusPenaltyText = `项目延误 ${deviation} 个月。承包商支付误期赔偿: $${penaltyAmt}万`;
                 setFinancialAlert('epc', `支付误期赔偿: -$${penaltyAmt}万`);
                 setFinancialAlert('owner', `收到误期赔偿: +$${penaltyAmt}万`);
             } else {
                 bonusPenaltyText = `项目延误 ${deviation} 个月。无误期赔偿约定。`;
             }
      } else if (deviation < 0) {
             if (finalEarlyBonus > 0) {
                 const bonusAmt = Math.abs(deviation) * finalEarlyBonus;
                 updateStat('owner', 'money', -bonusAmt);
                 updateStat('epc', 'money', bonusAmt);
                 bonusPenaltyText = `项目提前 ${Math.abs(deviation)} 个月。业主支付提前奖励: $${bonusAmt}万`;
                 setFinancialAlert('owner', `支付提前奖励: -$${bonusAmt}万`);
                 setFinancialAlert('epc', `收到提前奖励: +$${bonusAmt}万`);
             } else {
                 bonusPenaltyText = `项目提前 ${Math.abs(deviation)} 个月。无提前奖励约定。`;
             }
      } else {
             bonusPenaltyText = "项目按期完工。";
      }

      addLog(`结算完成。最终支付比例: ${finalPct}%。${bonusPenaltyText}`, 'green');
      
      // Constraint 6: Exact Text Transition Overlay
      triggerStageTransition(6, "完工总结阶段", "项目已完成结算，顺利进入并网发电，请填写项目总结。");
  };

  const submitSummary = (role, data) => {
    setSummaryData(prev => {
        const nextSummary = { ...prev, [role]: data };

        // --- LEANCLOUD UPLOAD LOGIC ---
        const doCloudSave = async () => {
             try {
                const GameRecord = AV.Object.extend('GameRecord');
                const record = new GameRecord();

                // Basic Info
                record.set('timestamp', new Date());
                record.set('totalTimeSeconds', gameTime);

                // Role Status & Metrics
                record.set('finalScores', playerState);

                // Process Data
                record.set('logs', logs);
                record.set('crisisHistory', crisisQueue);
                record.set('govRulingHistory', govRulingHistory);

                // Contract Info
                record.set('contract', {
                    price: finalContractPrice,
                    duration: finalContractDuration,
                    penalty: finalDelayPenalty,
                    bonus: finalEarlyBonus
                });

                // The Summary Content (Most important part here)
                record.set('summary', nextSummary);

                await record.save();
                console.log("Data uploaded to LeanCloud successfully.");
             } catch (e) {
                 console.error("LeanCloud upload failed:", e);
             }
        };
        doCloudSave();
        // -------------------------------

        return nextSummary;
    });

    setIsSummarySubmitted(prev => ({ ...prev, [role]: true }));
    addLog(`系统: ${INITIAL_STATES[role].label} 已提交完工总结。`, 'gray');
  };

  // --- 视图组件 ---

  const FloatingText = ({ value, type }) => (
      <span className={`absolute -top-4 right-0 text-xs font-black animate-out fade-out slide-out-to-top-4 duration-[3000ms] z-50 ${value > 0 ? 'text-green-600' : 'text-red-600'}`}>
        {value > 0 ? '+' : ''}{value}
      </span>
  );

  // New gentle alert component
  const GentleAlert = ({ text, colorClass }) => {
      if (!text) return null;
      return (
          <div className={`w-full mb-1 px-2 py-1 rounded text-[9px] font-medium flex items-center gap-1 animate-in slide-in-from-top-1 fade-in duration-500 ${colorClass}`}>
              <Banknote size={10}/>
              {text}
          </div>
      )
  };

  const renderS1ApprovedEsiaListFull = () => (
      <div className="mt-2 border border-slate-200 rounded overflow-hidden flex flex-col max-h-[120px]">
        <div className="bg-slate-100 text-[10px] px-2 py-1 font-bold border-b border-slate-200 text-slate-600 flex justify-between items-center shrink-0">
           <span>已通过的ESIA</span>
           <ListChecks size={12}/>
        </div>
        {/* Constraint 1: Fixed Scrollbar */}
        <div className="flex-1 bg-white p-1 h-[80px] overflow-y-auto">
           {ESIA_ITEMS.map(item => {
              const isOwnerSelected = ownerEsiaSelection.includes(item.id);
              const isConfirmed = confirmedEsiaSelection.includes(item.id); // Confirmed list is the final list passed in S1
              const isGovReq = accumulatedGovMandates.includes(item.id); 
              const isNgoReq = accumulatedNgoReqs.includes(item.id);
              
              const isApproved = isConfirmed || isGovReq;

              if (!isApproved) {
                  return (
                     <div key={item.id} className="flex items-center justify-between text-[9px] py-0.5 px-1 border-b border-slate-50 last:border-0 opacity-50 grayscale">
                         <span className="text-slate-700 leading-none">{item.label}</span>
                         <span className="text-[8px] text-slate-400">业主未选</span>
                     </div>
                  )
              }
              
              return (
                 <div key={item.id} className={`flex items-center justify-between text-[9px] py-0.5 px-1 border-b border-slate-50 last:border-0`}>
                    <span className="text-slate-700 leading-none">{item.label}</span>
                    <div className="flex gap-1">
                         {isOwnerSelected && <Badge variant="outline" className="text-[8px] h-3 px-1 text-blue-500 bg-blue-50 border-blue-100 leading-none">已选</Badge>}
                         {isNgoReq && <Badge variant="outline" className="text-[8px] h-3 px-1 text-red-500 bg-red-50 border-red-100 leading-none">公众</Badge>}
                         {isGovReq && <Badge variant="outline" className="text-[8px] h-3 px-1 text-green-500 bg-green-50 border-green-100 leading-none">政府</Badge>}
                    </div>
                 </div>
              )
           })}
        </div>
      </div>
  );

  const renderS2ApprovedEscpListFull = () => (
    <div className="mt-2 border border-slate-200 rounded overflow-hidden flex flex-col max-h-[120px]">
       <div className="bg-slate-100 text-[10px] px-2 py-1 font-bold border-b border-slate-200 text-slate-600 flex justify-between items-center shrink-0">
          <span>已签署ESCP</span>
          <ListChecks size={12}/>
       </div>
       {/* Constraint 1: Fixed Scrollbar */}
       <div className="flex-1 bg-white p-1 h-[80px] overflow-y-auto">
          {ESMP_LIBRARY.map(item => {
             const isOwner = confirmedEscpSelection.includes(item.id);
             const isGov = accumulatedGovEscpReqs.includes(item.id);
             const isMdb = accumulatedMdbEscpReqs.includes(item.id);
             const isSigned = isOwner || isGov || isMdb;
             
             return (
                <div key={item.id} className={`flex items-center justify-between text-[9px] py-0.5 px-1 border-b border-slate-50 last:border-0 ${!isSigned ? 'opacity-50 grayscale' : ''}`}>
                   <span className="text-slate-700 truncate max-w-[150px] leading-none">{item.label}</span>
                   <div className="flex gap-1">
                      {isSigned ? (
                          <>
                            {isOwner && <Badge variant="outline" className="text-[8px] h-3 px-1 text-blue-500 bg-blue-50 border-blue-100 leading-none">业</Badge>}
                            {isGov && <Badge variant="outline" className="text-[8px] h-3 px-1 text-green-500 bg-green-50 border-green-100 leading-none">政</Badge>}
                            {isMdb && <Badge variant="outline" className="text-[8px] h-3 px-1 text-purple-500 bg-purple-50 border-purple-100 leading-none">银</Badge>}
                          </>
                      ) : (
                          <span className="text-[8px] text-slate-400">未选</span>
                      )}
                   </div>
                </div>
             )
          })}
       </div>
    </div>
  );

  const renderTimer = () => {
      const totalSeconds = 24 * 60;
      const remaining = totalSeconds - gameTime;
      const m = Math.floor(Math.abs(remaining) / 60);
      const s = Math.abs(remaining) % 60;
      
      return (
        <span className={`font-mono font-bold ${remaining < 0 ? 'text-red-600 animate-pulse' : 'text-slate-700'}`}>
          {remaining >= 0 ? `剩余 ${m}分${String(s).padStart(2,'0')}秒` : `延期 ${m}分${String(s).padStart(2,'0')}秒`}
        </span>
      );
  };

  const renderTopBar = () => (
    <div className="h-14 bg-white border-b border-slate-200 flex justify-between items-center px-4 shrink-0 shadow-sm z-20 relative">
      <div className="flex items-center gap-4">
        <div className="flex items-center gap-2">
          <Activity className="text-blue-600" />
          <span className="font-bold text-lg text-slate-800 hidden md:block">SunLink v7.15</span>
        </div>
        <div className="flex gap-1 overflow-x-auto">
          {[1,2,3,4,5].map(s => (
            <Badge key={s} variant={stage===s?"default":"outline"} className={stage===s?"bg-blue-600 hover:bg-blue-700 whitespace-nowrap":"text-slate-500 whitespace-nowrap"}>
              {s===1?"立项审批":s===2?"项目融资":s===3?"EPC合同谈判":s===4?"项目建设":"验收与后评价"} 
            </Badge>
          ))}
        </div>
      </div>
      <div className="hidden md:flex items-center gap-2 text-[10px] font-mono">
         {Object.keys(INITIAL_STATES).map(k => (
           <div key={k} className={`flex flex-col items-center leading-none px-2 py-1 rounded border relative ${
               k==='owner'?'bg-blue-50 border-blue-100':
               k==='gov'?'bg-green-50 border-green-100':
               k==='mdb'?'bg-purple-50 border-purple-100':
               k==='epc'?'bg-orange-50 border-orange-100':
               'bg-red-50 border-red-100'
           }`}>
             <span className="text-slate-500 scale-75 mb-0.5">{INITIAL_STATES[k].label}声誉</span>
             <span className={`font-black text-slate-900 ${playerState[k].reputation<80?'text-red-600':''}`}>
               {playerState[k].reputation}分
             </span>
             {/* Animation fix */}
             {floatEffects.filter(e => e.role === k && !['money','cost','benefit'].includes(e.id)).map(e => (
                <FloatingText key={e.id} value={e.value} />
             ))}
           </div>
         ))}
      </div>
      <div className="flex items-center gap-4">
        <Button variant="outline" size="sm" onClick={() => setViewMode(viewMode==='roles'?'game':'roles')}>
          {viewMode==='roles' ? <Reply className="mr-2" size={16}/> : <BookOpen className="mr-2" size={16}/>}
          {viewMode==='roles' ? "返回" : "档案"}
        </Button>
        <div className="bg-slate-100 px-3 py-1 rounded flex items-center gap-2 border border-slate-200 text-xs">
          <Timer size={16} className="text-slate-500"/>
          {renderTimer()}
        </div>
      </div>
    </div>
  );

  const renderRoleColumn = (roleKey, title, Icon, colorClass) => {
    // Req 7: Add confirmedParties check to keep active
    const isActive = activeRole === roleKey || activeRole === 'all' 
       || (stage===4 && ['gov','ngo',protestHandler].includes(roleKey))
       || (stage===4 && protestState==='ruling_result_display' && (roleKey==='ngo' || roleKey===protestHandler))
       || (stage===5 && inspectionState==='s5_ruling_result' && (roleKey==='owner' || roleKey==='epc'));

    const state = playerState[roleKey];
    
    let metricLabel = "";
    let metricValue = "";

    if (roleKey === 'owner' || roleKey === 'epc') { 
        metricLabel = "可用资金"; 
        metricValue = `$${state.money.toFixed(1)}万`; 
    } else if (roleKey === 'gov' || roleKey === 'mdb') { 
        metricLabel = "监督成本"; 
        metricValue = `$${state.cost}万`; 
    } else if (roleKey === 'ngo') { 
        metricLabel = "社会效益"; 
        metricValue = `$${state.benefit}万`; 
    }

    return (
      <Card className={`h-full flex flex-col border-t-0 border-b-0 border-r-0 border-l-4 ${colorClass} transition-all duration-300 shadow-sm rounded-sm ${isActive ? 'bg-white ring-1 ring-slate-200' : 'bg-slate-50 opacity-60 grayscale-[0.5]'}`}>
        <CardHeader className="py-2 px-2 bg-white border-b border-slate-100 shrink-0 relative">
          <CardTitle className="text-xs font-bold flex items-center gap-2 text-slate-700">
            <Icon size={14} className={colorClass.replace('border-','text-')} />
            <span className="truncate">{title}</span>
          </CardTitle>
          <div className="grid grid-cols-1 gap-1 mt-1">
             <div className="text-[10px] bg-slate-50 border border-slate-200 px-1 py-0.5 rounded-sm flex justify-between relative overflow-visible">
                <span className="text-slate-500">{metricLabel}</span>
                <span className={`font-bold ${state.money<0||state.cost>500?'text-red-500':'text-slate-700'}`}>
                    {metricValue}
                </span>
                {/* Animation fix */}
                {floatEffects.filter(e => e.role === roleKey).map(e => (
                   <FloatingText key={e.id} value={e.value} />
                ))}
             </div>
             <div className="md:hidden text-[9px] flex justify-between text-slate-400">
                <span>声誉</span>
                <span>{state.reputation}分</span>
             </div>
          </div>
        </CardHeader>
        
        <CardContent className="flex-1 p-0 overflow-hidden relative min-h-0 flex flex-col"> 
           
           <div className="px-2 pt-2 space-y-1 shrink-0">
              {roleKey === 'owner' && <GentleAlert text={financialAlerts.owner} colorClass="bg-blue-50 text-blue-700 border border-blue-100" />}
              {roleKey === 'epc' && <GentleAlert text={financialAlerts.epc} colorClass="bg-orange-50 text-orange-700 border border-orange-100" />}
           </div>

           {isActive ? (
               <ScrollArea className="flex-1 w-full h-full">
                  <div className="p-2 pb-10">
                      {renderRoleContent(roleKey)}
                  </div>
               </ScrollArea>
           ) : (
             <div className="flex flex-col items-center justify-center h-full text-center p-2 space-y-2 animate-in fade-in">
                <div className="bg-slate-100 p-2 rounded-md w-full border border-slate-200">
                   <div className="text-[9px] text-slate-400 mb-1 uppercase tracking-wider">状态</div>
                   <div className="text-[10px] font-medium text-slate-600 leading-tight">
                      {lastActionInfo[roleKey]}
                   </div>
                </div>
             </div>
           )}
        </CardContent>
      </Card>
    );
  };

  const renderRoleContent = (role) => {
    if (stage === 6) {
       if (isSummarySubmitted[role]) {
          return <div className="text-center text-green-600 pt-4"><CheckCircle2 className="mx-auto mb-2"/> 已提交总结</div>
       }
       return <SummaryForm role={role} onSubmit={submitSummary} />;
    }
    
    // --- Global Crisis Resolution Screen ---
    if (stage === 4 && s4State === 's4_resolution') {
       return (
           <div className="h-full flex flex-col items-center justify-center bg-green-50 p-2 text-center animate-in fade-in space-y-3 border border-green-100 rounded-md">
               <div className="w-10 h-10 rounded-full bg-green-200 flex items-center justify-center mb-1">
                  <CheckCircle2 size={20} className="text-green-700"/>
               </div>
               <div className="font-bold text-[11px] text-green-800">本轮危机处理结束</div>
               <div className="text-[10px] text-slate-600 bg-white p-2 rounded border border-green-100 shadow-sm">{resolutionMsg}</div>
               <div className="text-[9px] text-slate-400 mt-4 animate-pulse">等待进入下一阶段...</div>
           </div>
       )
    }
    
    // Req 5: Global Ruling Result Display
    // Req 7: Double Confirmation Logic
    if (stage === 4 && protestState === 'ruling_result_display') {
        const isResponsible = role === protestHandler;
        const isNgo = role === 'ngo';
        
        if (!isResponsible && !isNgo) return null;

        const confirmed = confirmedParties.includes(role);

        return (
           <div className="h-full flex flex-col space-y-2 bg-purple-50 p-2 rounded border border-purple-200">
               <div className="font-bold text-purple-800 text-center text-[10px] mb-2"><Gavel size={12} className="inline mr-1"/>政府终局裁决结果</div>
               <div className="bg-white p-2 rounded border border-purple-100 text-[9px]">
                   <div className="flex justify-between mb-1">
                       <span>裁决金额:</span>
                       <span className="font-bold text-red-600">${govRulingAmount}万</span>
                   </div>
                   {govRulingReason && (
                       <div className="border-t pt-1 mt-1">
                           <span className="font-bold text-slate-500">裁决理由:</span>
                           <p className="text-slate-700">{govRulingReason}</p>
                       </div>
                   )}
               </div>
               <div className="text-[9px] text-slate-500 text-center mt-4">请确认裁决结果。</div>
               {confirmed ? (
                   <div className="text-center text-green-600 text-[10px] font-bold">已确认，等待对方...</div>
               ) : (
                   <Button size="sm" className="w-full bg-purple-600" onClick={()=>acknowledgeRulingResult(role)}>确认裁决</Button>
               )}
           </div>
        );
    }

    // Req 8: S5 Ruling Result Display
    if (stage === 5 && inspectionState === 's5_ruling_result') {
        if (role !== 'owner' && role !== 'epc') return null;
        const confirmed = s5ConfirmedParties.includes(role);

        return (
            <div className="h-full flex flex-col space-y-2 bg-purple-50 p-2 rounded border border-purple-200">
               <div className="font-bold text-purple-800 text-center text-[10px] mb-2"><Gavel size={12} className="inline mr-1"/>S5 结算终局裁决</div>
               <div className="bg-white p-2 rounded border border-purple-100 text-[9px]">
                   <div className="flex justify-between mb-1">
                       <span>支付比例:</span>
                       <span className="font-bold text-red-600">{s5GovRuling}%</span>
                   </div>
                   {s5GovRulingReason && (
                       <div className="border-t pt-1 mt-1">
                           <span className="font-bold text-slate-500">裁决理由:</span>
                           <p className="text-slate-700">{s5GovRulingReason}</p>
                       </div>
                   )}
               </div>
               {confirmed ? (
                   <div className="text-center text-green-600 text-[10px] font-bold mt-4">已确认，等待对方...</div>
               ) : (
                   <Button size="sm" className="w-full bg-purple-600 mt-4" onClick={()=>s5AcknowledgeRuling(role)}>确认裁决</Button>
               )}
            </div>
        );
    }


    // --- OWNER ---
    if (role === 'owner') {
      if (stage === 1 && s1State === 'owner_draft') {
        const multiplier = 1.0 + (s1SubmissionCount - 1) * 0.2;
        return (
        <div className="space-y-2 flex flex-col">
          {s1Feedback && <Alert variant="destructive" className="text-[10px] p-2 bg-red-50 border-red-100 text-red-700"><AlertDescription>{s1Feedback}</AlertDescription></Alert>}
          <div className="font-bold text-blue-800 text-[10px]">
             {s1SubmissionCount > 1 ? "选择补充 (价格上涨" + Math.round((multiplier-1)*100) + "%):" : "请开展ESIA专项评价 (括号内为成本):"}
          </div>
          <div className="border border-slate-200 rounded-sm shadow-inner bg-white h-[150px] overflow-y-auto">
             {ESIA_ITEMS.map(i => {
            const isConfirmed = confirmedEsiaSelection.includes(i.id);
            const isNgoReq = accumulatedNgoReqs.includes(i.id);
            const isGovReq = accumulatedGovMandates.includes(i.id);
            const currentCost = Math.round(i.cost * multiplier);
            
            return (
              <div key={i.id} className={`flex gap-2 py-0.5 px-1 border-b border-slate-100 last:border-0 items-center ${isConfirmed ? 'bg-slate-100 opacity-70' : 'hover:bg-slate-50'}`}>
                <Checkbox className="h-3 w-3" checked={ownerEsiaSelection.includes(i.id)} disabled={isConfirmed} 
                  onCheckedChange={(c)=>c?setOwnerEsiaSelection([...ownerEsiaSelection,i.id]):(!isConfirmed&&setOwnerEsiaSelection(ownerEsiaSelection.filter(x=>x!==i.id)))} />
                <div className="flex-1 flex flex-col justify-center">
                   <span className="text-slate-700 text-[9px] leading-none">{i.label} <span className="text-slate-400">(${currentCost}万)</span></span>
                   <div className="flex gap-1 mt-0.5">
                      {isNgoReq && !isConfirmed && <Badge variant="outline" className="text-[8px] h-3 px-1 text-red-600 border-red-200 bg-red-50 leading-none">公众要求</Badge>}
                      {isGovReq && !isConfirmed && <Badge variant="outline" className="text-[8px] h-3 px-1 text-green-600 border-green-200 bg-green-50 leading-none">政府要求</Badge>}
                   </div>
                </div>
              </div>
            )
          })}
          </div>
          <div className="text-[9px] text-slate-500 italic bg-slate-100 p-1 rounded leading-tight">提交后不可撤回，若被驳回，后续成本将增加20%，声誉-3分/项。</div>
          <Button size="sm" className="w-full bg-blue-600 hover:bg-blue-700 h-7 text-[10px]" onClick={s1OwnerSubmit}>开展ESIA专项评价</Button>
        </div>
      );}
      if (stage === 2 && s2State === 'owner_apply') return (
         <div className="flex flex-col items-center justify-center h-full space-y-4">
            <Banknote size={48} className="text-blue-300"/>
            <div className="text-center text-xs text-slate-600">请向多边开发银行申请项目融资</div>
            <Button className="bg-blue-600 hover:bg-blue-700 w-full" onClick={s2OwnerApply}>向多边开发银行以项目融资方式借款1500万</Button>
         </div>
      );
      if (stage === 2 && s2State === 'owner_escp') {
        const multiplier = 1.0 + (s2SubmissionCount - 1) * 0.2;
        return (
        <div className="space-y-2 flex flex-col">
          {riskLevel && <Alert className="p-1 bg-purple-50 border-purple-200 text-[10px] text-purple-800"><AlertDescription>银行评级结果：{riskLevel}</AlertDescription></Alert>}

          <div className="font-bold text-purple-700 text-[10px]">请选择贷款协议ESCP (括号内为成本):</div>
          {(accumulatedGovEscpReqs.length > 0 || accumulatedMdbEscpReqs.length > 0) && (
              <Alert className="p-1 bg-red-50 text-[9px] border-red-200 text-red-800 mb-1">
                  <AlertDescription>
                      需补充: 
                      {[...accumulatedGovEscpReqs].map(id=>ESMP_LIBRARY.find(x=>x.id===id)?.label + '(政府)').join(', ')}
                      {accumulatedGovEscpReqs.length>0 && accumulatedMdbEscpReqs.length>0 && ', '}
                      {[...accumulatedMdbEscpReqs].map(id=>ESMP_LIBRARY.find(x=>x.id===id)?.label + '(银行)').join(', ')}
                  </AlertDescription>
              </Alert>
          )}
          
          {/* Requirement 3: Scrollbar for S2 Selection Box */}
          <div className="bg-white border rounded h-[150px] overflow-y-auto">{ESMP_LIBRARY.map(i => {
             const isGovReq = accumulatedGovEscpReqs.includes(i.id);
             const isMdbReq = accumulatedMdbEscpReqs.includes(i.id);
             const isPreviouslyLocked = confirmedEscpSelection.includes(i.id);
             const isForced = isGovReq || isMdbReq; 
             
             const isLocked = isPreviouslyLocked || isForced;

             const currentCost = Math.round(i.cost * multiplier);

             return (
                <div key={i.id} className={`flex gap-2 py-0.5 px-1 border-b items-center ${isLocked ? 'bg-slate-100 opacity-60' : ''}`}>
                    <Checkbox className="h-3 w-3"
                        checked={isForced ? true : ownerEscpSelection.includes(i.id)} 
                        disabled={isLocked} 
                        onCheckedChange={c=>c?setOwnerEscpSelection([...ownerEscpSelection,i.id]):(!isLocked && setOwnerEscpSelection(ownerEscpSelection.filter(x=>x!==i.id)))}
                    />
                    <div className="flex flex-col justify-center">
                        <span className="text-[9px] leading-none">{i.label} (${currentCost}万)</span>
                        <div className="flex gap-1 mt-0.5">
                            {isGovReq && <Badge variant="outline" className="text-[8px] px-1 h-3 text-green-600 bg-green-50 leading-none">政府要求</Badge>}
                            {isMdbReq && <Badge variant="outline" className="text-[8px] px-1 h-3 text-purple-600 bg-purple-50 leading-none">银行要求</Badge>}
                        </div>
                    </div>
                </div>
             )
          })}</div>
          
          <div className="text-[9px] text-red-500 italic bg-red-50 p-1 rounded leading-tight">提交后不可撤回，若被驳回，后续成本增加20%，声誉-3分/项。</div>
          <Button size="sm" className="w-full h-7 text-[10px]" onClick={s2OwnerEscp}>提交ESCP</Button>
          {renderS1ApprovedEsiaListFull()}
        </div>
      );}
      if (stage === 3 && s3State === 'owner_tender') return (
         <div className="space-y-2 flex flex-col">
           <Alert className="p-1 bg-green-50 border-green-200 text-[9px] text-green-800"><AlertDescription>1500万项目融资协议已签署，当前拨付300万（20%）</AlertDescription></Alert>

           <div className="space-y-0.5">
              <span className="text-[9px]">控制价($万) <span className="text-red-500">*必填</span></span>
              <Input type="number" onChange={e=>setTenderLimitPrice(Number(e.target.value))} className="h-6 text-[10px]"/>
           </div>
           <div className="space-y-0.5">
              <span className="text-[9px]">合同工期(月) - 默认20起</span>
              <div className="flex items-center gap-2">
                 <Input type="number" defaultValue={20} onChange={e=>setTenderDuration(Number(e.target.value))} className="h-6 text-[10px] flex-1"/>
              </div>
           </div>
           
           <div className="grid grid-cols-2 gap-2">
               <div className="space-y-0.5">
                  <span className="text-[9px]">误期罚款(万/月)</span>
                  <Input type="number" min={0} defaultValue={0} onChange={e=>setDelayPenalty(Number(e.target.value))} className="h-6 text-[10px]"/>
               </div>
               <div className="space-y-0.5">
                  <span className="text-[9px]">提前奖励(万/月)</span>
                  <Input type="number" min={0} defaultValue={0} onChange={e=>setEarlyBonus(Number(e.target.value))} className="h-6 text-[10px]"/>
               </div>
           </div>

           <div className="font-bold text-[10px] mt-1">业主自管ESMP (未选将由EPC负责):</div>
           <div className="text-[8px] text-slate-500">注：业主选择ESMP不消耗资金。</div>
           
           {/* Constraint 1: Scrollbar for S3 ESMP Selection - Fixed Height */}
           <div className="bg-white border rounded h-[120px] overflow-y-auto">{ESMP_LIBRARY.map(i => {
               const inEscp = confirmedEscpSelection.includes(i.id);
               return (
                 <div key={i.id} className="flex gap-1 py-0.5 px-1 items-center border-b last:border-0">
                    <Checkbox className="h-3 w-3" onCheckedChange={c=>c?setOwnerRespEsmp([...ownerRespEsmp,i.id]):setOwnerRespEsmp(ownerRespEsmp.filter(x=>x!==i.id))}/>
                    <div className="flex flex-col justify-center">
                        <span className="text-[9px] leading-none">{i.label}</span>
                        <div className="flex gap-1 mt-0.5">
                           {inEscp ? <span className="text-[8px] text-purple-600 bg-purple-50 px-1 rounded leading-none">已列入ESCP</span> : <span className="text-[8px] text-gray-400 leading-none">未列入ESCP</span>}
                        </div>
                    </div>
                 </div>
               )
           })}</div>
           <Button size="sm" className="w-full h-7 text-[10px]" onClick={s3OwnerTender} disabled={!tenderLimitPrice || tenderLimitPrice <= 0}>发布招标文件</Button>
           {renderS2ApprovedEscpListFull()}
         </div>
      );
      if (stage === 3 && s3State === 'owner_eval') return (
        <div className="space-y-2 p-2 bg-amber-50 rounded border border-amber-200 flex flex-col">
          <div className="font-bold text-center border-b border-amber-200 pb-1 mb-1 text-[10px]">报价历史</div>
          <div className="h-20 overflow-y-auto border bg-white rounded p-1 mb-1">
             {epcBidHistory.map(h => (
                <div key={h.round} className="text-[9px] flex justify-between border-b border-slate-100 py-0.5">
                   <span>第{h.round}轮</span>
                   <span className="font-bold">${h.price}万</span>
                </div>
             ))}
          </div>
          
          <div className="grid grid-cols-2 gap-1 text-center text-[9px]">
             <div className="text-slate-500">控制价</div><div className="font-bold">${tenderLimitPrice}</div>
             <div className="text-slate-500">EPC最新报价</div><div className={`font-bold ${epcBid.price>tenderLimitPrice?'text-red-600':''}`}>${epcBid.price}</div>
             <div className="text-slate-500">合同工期</div><div className="font-bold">{tenderDuration}</div>
          </div>
          
          {/* Req 2: Reject Reason Input */}
          <Input placeholder="驳回理由(可选)" className="h-6 text-[10px] bg-white" value={ownerRejectReason} onChange={e=>setOwnerRejectReason(e.target.value)}/>

          <div className="flex gap-1 mt-1">
            <Button size="sm" className="flex-1 h-7 text-[10px] bg-green-600 whitespace-normal leading-tight" onClick={()=>s3OwnerEval(true)}>接受报价</Button>
            <Button size="sm" className="flex-1 h-7 text-[10px] bg-red-600 leading-tight" onClick={()=>s3OwnerEval(false)}>驳回重报</Button>
          </div>
          <EsmpResponsibilityList ownerRespEsmp={ownerRespEsmp} />
        </div>
      );
      if (stage === 4 && (s4State === 's4_audit' || s4State === 's4_owner_reaudit')) return (
        <div className="space-y-2 flex flex-col">
           <div className="font-bold flex items-center gap-1 text-[10px]"><Gavel size={10}/> {s4State==='s4_audit'?'抽查审计项':'整改复查项'}:</div>
           <div className="text-[8px] text-gray-500 mb-1">抽查成本5万元/项。</div>
           <div className="bg-white border rounded h-[150px] overflow-y-auto">{ESMP_LIBRARY.map(item => {
               const isOwnerResp = ownerRespEsmp.includes(item.id);
               return (
                   <div key={item.id} className={`flex gap-1 py-0.5 px-1 items-center border-b last:border-0 ${isOwnerResp ? 'opacity-50 bg-slate-50' : ''}`}>
                       <Checkbox className="h-3 w-3"
                           checked={ownerAuditItems.includes(item.id)} 
                           disabled={isOwnerResp || (s4State==='s4_owner_reaudit' && ownerAuditItems.includes(item.id))} 
                           onCheckedChange={c=>c?setOwnerAuditItems([...ownerAuditItems,item.id]):setOwnerAuditItems(ownerAuditItems.filter(x=>x!==item.id))}
                       />
                       <div className="flex flex-col justify-center">
                          <span className="text-[9px] leading-none">{item.label}</span>
                          {isOwnerResp && <span className="text-[8px] text-blue-500 leading-none">业主负责 (不可选)</span>}
                       </div>
                   </div>
               )
           })}</div>
           
           {s4State === 's4_audit' ? (
             <Button size="sm" className="w-full h-7 text-[10px]" onClick={s4OwnerAudit}>执行审计 (花费{ownerAuditItems.length*5}万)</Button>
           ) : (
             <Button size="sm" className="w-full h-7 text-[10px] bg-orange-600" onClick={s4OwnerReaudit}>执行复查</Button>
           )}
        </div>
      );
      if (stage === 4 && s4State === 's4_punish_decide') return (
         <div className="space-y-2 bg-red-50 p-2 rounded border border-red-200">
            <div className="font-bold text-red-700 text-[10px]">审计发现违规!</div>
            <div className="text-[9px] mb-2 leading-tight">EPC承包商未执行: {epcViolations.map(id=>ESMP_LIBRARY.find(x=>x.id===id)?.label).join(', ')}</div>
            <Button size="sm" className="w-full h-7 text-[10px] bg-blue-600 mb-1" onClick={()=>s4OwnerPunishDecide('rectify')}>责令整改</Button>
            <Button size="sm" variant="outline" className="w-full h-7 text-[10px]" onClick={()=>s4OwnerPunishDecide('pass')}>直接通过 (有风险)</Button>
         </div>
      );
      if (stage === 4 && protestState === 'owner_route') return (
        <div className="space-y-2 bg-orange-50 p-2 rounded border border-orange-200 flex flex-col">
           <CrisisContextBox crisis={currentCrisis} />

           <div className="font-bold text-[10px] text-orange-800">收到公众/NGO索赔通知</div>
           <div className="text-[9px] text-orange-600 mb-1">NGO索赔: ${ngoDemandAmount}万</div>
           {/* Req 5: Show NGO reason in Owner interface */}
           {ngoDemandReason && <div className="text-[9px] bg-white p-1 rounded text-red-600 border border-red-100 mb-2"><strong>索赔原因:</strong> {ngoDemandReason}</div>}
           
           <div className="text-[9px] mb-1">请根据合同ESMP责任划分，判定由谁处理。</div>
           
           <div className="space-y-1 border-t border-orange-200 pt-2">
             <div className="text-[9px] font-bold">责任在业主?</div>
             <Button size="sm" className="w-full h-6 text-[10px]" onClick={()=>protestOwnerRoute(true)}>自行处理</Button>
           </div>
           <div className="space-y-1 border-t border-orange-200 pt-2">
              <div className="text-[9px] font-bold">责任在EPC承包商?</div>
              <Button size="sm" variant="outline" className="w-full h-6 text-[10px]" onClick={()=>protestOwnerRoute(false)}>转交EPC承包商处理</Button>
           </div>

           <EsmpResponsibilityList ownerRespEsmp={ownerRespEsmp} />
        </div>
      );
      if (stage === 4 && protestState === 'party_negotiate' && protestHandler === 'owner') return (
         <div className="space-y-2 bg-blue-50 p-2 rounded border border-blue-200">
             <CrisisContextBox crisis={currentCrisis} />
             <div className="text-[10px] font-bold text-red-600">公众索赔: ${ngoDemandAmount}万</div>
             {ngoDemandReason && <div className="text-[9px] bg-white p-1 rounded text-red-600 mb-1">理由: {ngoDemandReason}</div>}
             
             <Input type="number" placeholder="输入主张金额($)" className="h-7 text-[10px] bg-white mb-1" onChange={e=>setOfferAmount(Number(e.target.value))}/>
             
             {/* Req 1: Reason Input */}
             <Input type="text" placeholder="理由(可选)" className="h-7 text-[10px] bg-white mb-1" onChange={e=>setPartyOfferReason(e.target.value)}/>

             <Button size="sm" className="w-full h-7 text-[10px]" onClick={()=>protestPartyNegotiate(offerAmount)} disabled={offerAmount < 0}>主张赔偿</Button>
         </div>
      );
      if (stage === 4 && protestState === 'parties_react_ruling' && protestHandler === 'owner') return (
         <div className="space-y-2 bg-blue-50 p-2 rounded border border-blue-200">
            <CrisisContextBox crisis={currentCrisis} />
            <div className="font-bold text-blue-800 flex items-center gap-1 text-[10px]"><Gavel size={10}/> 政府裁决: ${govRulingAmount}万</div>
            {govRulingReason && <div className="text-[9px] bg-white p-1 rounded text-purple-700 mb-1">理由: {govRulingReason}</div>}
            
            {!partyResponse ? (
              <>
                 <Button size="sm" className="w-full bg-green-600 h-7 text-[10px]" onClick={()=>submitPartyReaction('accept')}>接受裁决</Button>
                 
                 <div className="pt-2 mt-1 border-t border-blue-200 space-y-1">
                    <Input type="number" placeholder="申诉主张金额($)" className="h-7 bg-white text-[10px]" value={partyAppealInput} onChange={e=>setPartyAppealInput(e.target.value)} />
                    {/* Req 4: Party Appeal Reason */}
                    <Input type="text" placeholder="申诉理由(可选)" className="h-7 bg-white text-[10px] mt-1" value={partyAppealReason} onChange={e=>setPartyAppealReason(e.target.value)} />
                    <Button size="sm" className="w-full bg-red-600 h-7 text-[10px] mt-1" onClick={()=>submitPartyReaction('appeal', partyAppealInput, partyAppealReason)} disabled={!partyAppealInput}>提交申诉</Button>
                 </div>
              </>
            ) : <div className="text-center text-gray-600 text-[9px] mt-2 italic">已提交，等待对方...</div>}
         </div>
      );

      if (stage === 4 && protestState === 'owner_pay_decision') return (
         <div className="space-y-2 bg-purple-50 p-2 rounded border border-purple-200">
             <CrisisContextBox crisis={currentCrisis} />
             <div className="font-bold text-purple-800 text-[10px]">银行决定: {bankFreezeDecision==='freeze'?'暂停拨付':'继续拨付'}</div>
             {bankFreezeDecision==='freeze' && <div className="text-[9px] text-red-600 bg-white p-1 rounded border border-red-100 mb-1 font-bold">
                 多边银行暂停本阶段 {currentCrisis?.index === 3 ? '15%' : '20%'} 贷款拨付
             </div>}
             <div className="text-[9px] mb-2">是否继续支付EPC承包商进度款 ({currentCrisis?.index === 3 ? '15%' : '20%'})?</div>
             
             {/* Req 3: Owner Pay Reason */}
             <Input type="text" placeholder="理由(可选)" className="h-7 text-[10px] bg-white mb-1" onChange={e=>setOwnerPayDecisionReason(e.target.value)}/>

             <Button size="sm" className="w-full bg-green-600 h-7 text-[10px]" onClick={()=>protestOwnerPayDecision(true)}>支付</Button>
             <Button size="sm" className="w-full bg-red-600 h-7 text-[10px]" onClick={()=>protestOwnerPayDecision(false)}>暂停支付</Button>
         </div>
      );

      // Requirement 9: Owner Reconsider
      if (stage === 4 && protestState === 'owner_reconsider_pay') return (
         <div className="space-y-2 bg-orange-50 p-2 rounded border border-orange-200">
             <div className="font-bold text-orange-800 text-[10px] flex items-center gap-1"><AlertTriangle size={10}/> 承包商反对暂停支付</div>
             <div className="text-[9px] mb-2 bg-white p-2 rounded border border-orange-100">
                 承包商要求业主支付进度款。
                 {epcProtestReason && <div className="mt-1 font-bold">理由: {epcProtestReason}</div>}
             </div>
             <Button size="sm" className="w-full bg-green-600 h-7 text-[10px]" onClick={()=>protestOwnerReconsider(true)}>同意，支付进度款</Button>
             
             {/* Req 6: Button Text Change */}
             <Button size="sm" className="w-full bg-red-600 h-7 text-[10px]" onClick={()=>protestOwnerReconsider(false)}>反对，暂停支付，留置争议</Button>
         </div>
      );

      // Requirement 11: S5 New Logic - Owner Decide Pay
      if (stage === 5 && inspectionState === 'owner_decide_pay') return (
        <div className="space-y-2 bg-orange-50 p-2 rounded border border-orange-200">
           <div className="font-bold text-orange-800 flex items-center gap-1 text-[10px]"><ClipboardCheck size={10}/> 竣工验收决策</div>
           <div className="grid grid-cols-2 gap-2 text-[9px] mb-2">
              <div className="bg-white p-1 rounded">银行拨付: {bankDisbursedPct}%</div>
              <div className="bg-white p-1 rounded">业主已付: {ownerPaidPct}%</div>
           </div>
           
           <div className="space-y-1">
              <div className="text-[9px] font-bold">支付合同额比例至(%) (> {ownerPaidPct}%):</div>
              <Input type="number" className="h-7 text-[10px]" min={ownerPaidPct} max={100} onChange={e=>setOwnerPayProposal(e.target.value)}/>
           </div>

           <div className="space-y-1">
              <div className="text-[9px] font-bold">反馈意见:</div>
              <Textarea className="h-12 text-[10px] bg-white" onChange={e=>setOwnerFeedback(e.target.value)} placeholder="解释支付比例..."/>
           </div>
           
           <Button size="sm" className="w-full bg-green-600 mt-2 h-7 text-[10px]" onClick={s5OwnerSubmitProposal}>通过质量验收</Button>
        </div>
      );
    }

    // --- GOV ---
    if (role === 'gov') {
       if (stage === 1 && s1State === 'gov_review') {
         const hasNewMandates = govMandates.filter(id => !accumulatedGovMandates.includes(id)).length > 0;
         return (
         <div className="space-y-2 flex flex-col">
           {hasProtested && <Alert className="p-1 bg-red-50 text-[9px] border-red-200 text-red-800"><AlertDescription>⚠️ 公众提出抗议</AlertDescription></Alert>}
           <div className="flex flex-col gap-1">
               <Button size="sm" className="w-full bg-green-600 hover:bg-green-700 h-7 text-[10px]" onClick={()=>s1GovReview(true)}>批准业主ESIA</Button>
               <Button size="sm" className="w-full bg-red-600 hover:bg-red-700 h-7 text-[10px]" onClick={()=>s1GovReview(false)} disabled={!hasNewMandates}>驳回业主ESIA</Button>
           </div>
           <div className="font-bold mt-1 text-[10px] text-slate-600">请选择政府监管部门要求补充的ESIA专项评价：</div>
           {/* Constraint 1: Scrollbar for S2 ESIA - Fixed Height */}
           <div className="bg-white border border-slate-200 rounded h-[120px] overflow-y-auto">
             {ESIA_ITEMS.map(i=> {
                const isOwnerSelected = confirmedEsiaSelection.includes(i.id);
                const isPublicReq = accumulatedNgoReqs.includes(i.id) || ngoRequirements.includes(i.id);
                if (isOwnerSelected) return <div key={i.id} className="flex gap-1 py-0.5 px-1 items-center bg-slate-100 opacity-60 border-b last:border-0"><Checkbox className="h-3 w-3" checked disabled /><span className="text-[9px] text-slate-500 leading-none">{i.label}</span></div>
                return (
                    <div key={i.id} className="flex gap-1 py-0.5 px-1 items-center hover:bg-slate-50 border-b last:border-0">
                       <Checkbox className="h-3 w-3" onCheckedChange={c=>c?setGovMandates([...govMandates,i.id]):setGovMandates(govMandates.filter(x=>x!==i.id))}/>
                       <div className="flex-1 flex items-center justify-between"><span className="text-[9px] leading-none">{i.label}</span>{isPublicReq && <Badge variant="outline" className="text-[8px] h-3 px-1 text-red-600 border-red-200 bg-red-50 leading-none">公众要求</Badge>}</div>
                    </div>
                )
             })}
           </div>
           <div className="text-[9px] text-slate-500 bg-slate-100 p-1 rounded leading-tight">监督成本2万/项；声誉+1分/项，若未满足公众要求，声誉-2分/项。</div>
         </div>
       );}
       if (stage === 2 && s2State === 'gov_check') {
         const hasNewMandates = govEscpMandates.filter(id => !accumulatedGovEscpReqs.includes(id)).length > 0;
         return (
         <div className="space-y-2 flex flex-col">
            <div className="font-bold text-[10px] text-slate-600">审核ESCP (勾选新增项以驳回):</div>
            <div className="bg-white border rounded h-[150px] overflow-y-auto">{ESMP_LIBRARY.map(i => {
                const isOwnerSelected = ownerEscpSelection.includes(i.id);
                const isAccumulatedGov = accumulatedGovEscpReqs.includes(i.id);
                const isAccumulatedMdb = accumulatedMdbEscpReqs.includes(i.id);
                const isAlreadyForced = isAccumulatedGov || isAccumulatedMdb;

                return (
                    <div key={i.id} className={`flex gap-2 py-0.5 px-1 border-b last:border-0 items-center ${isOwnerSelected || isAlreadyForced ? 'bg-slate-100 opacity-60' : ''}`}>
                        <Checkbox className="h-3 w-3"
                           checked={isOwnerSelected || isAlreadyForced || govEscpMandates.includes(i.id)} 
                           disabled={isOwnerSelected || isAlreadyForced} 
                           onCheckedChange={c=>c?setGovEscpMandates([...govEscpMandates,i.id]):setGovEscpMandates(govEscpMandates.filter(x=>x!==i.id))}
                        />
                        <span className="text-[9px] leading-none">{i.label}</span>
                        <div className="ml-auto flex gap-1">
                           {isOwnerSelected && <span className="text-[8px] text-slate-500 leading-none">(业主)</span>}
                           {isAccumulatedGov && <Badge variant="outline" className="text-[8px] px-1 h-3 text-green-600 bg-green-50 leading-none">政府</Badge>}
                           {isAccumulatedMdb && <Badge variant="outline" className="text-[8px] px-1 h-3 text-purple-600 bg-purple-50 leading-none">银行</Badge>}
                        </div>
                    </div>
                )
            })}</div>
            <div className="flex gap-2 mt-1">
               <Button size="sm" className="flex-1 bg-green-600 h-7 text-[10px]" onClick={()=>s2GovCheck(true)}>通过</Button>
               <Button size="sm" className="flex-1 bg-red-600 h-7 text-[10px]" onClick={()=>s2GovCheck(false)} disabled={!hasNewMandates}>驳回</Button>
            </div>
            <div className="text-[9px] text-slate-500 bg-slate-100 p-1 rounded leading-tight">监督成本+2万/项，政府声誉+2分/项。</div>
            {renderS1ApprovedEsiaListFull()}
         </div>
       );}
       if (stage === 4 && protestState === 'gov_ruling') return (
         <div className="space-y-2 border-t-4 border-red-500 pt-2 bg-red-50 p-2 rounded border border-red-100 flex flex-col">
            <CrisisContextBox crisis={currentCrisis} />

            <div className="font-bold text-red-700 text-center border-b border-red-200 pb-1 text-[10px]">
               {govRulingCount >= 2 ? "第3次: 终局裁决" : `第${govRulingCount + 1}次裁决`}
            </div>
            
            {/* Req 6: Display text replacement */}
            <div className="text-[9px] mb-1 bg-white border border-red-100 rounded p-1 max-h-40 overflow-y-auto">
               <div className="grid grid-cols-3 gap-1 font-bold border-b pb-1 mb-1 text-center text-slate-600">
                  <div>轮次</div>
                  <div>公众/责任方</div>
                  <div>裁决</div>
               </div>
               <div className="grid grid-cols-3 gap-1 py-1 border-b border-slate-50 last:border-0 text-center items-center">
                   <div className="text-slate-500">当前</div>
                   <div className="font-bold">
                       ${ngoDemandAmount} / ${offerAmount}
                       {ngoDemandReason && <div className="text-[8px] text-red-500 font-normal text-left truncate px-1">公众理由:{ngoDemandReason}</div>}
                       {partyOfferReason && <div className="text-[8px] text-blue-500 font-normal text-left truncate px-1">责任方理由:{partyOfferReason}</div>}
                   </div>
                   <div className="text-red-600 italic">待定</div>
               </div>
               {govRulingHistory.map(h => (
                   <div key={h.count} className="grid grid-cols-3 gap-1 py-1 border-b border-slate-50 last:border-0 text-center items-center opacity-60">
                       <div>R{h.count}</div>
                       <div>
                           ${h.ngoDemand}/${h.partyOffer}
                           {h.appealReasonNgo && <div className="text-[8px] text-red-500 font-normal text-left truncate px-1">公众申诉:{h.appealReasonNgo}</div>}
                           {h.appealReasonParty && <div className="text-[8px] text-blue-500 font-normal text-left truncate px-1">责任方申诉:{h.appealReasonParty}</div>}
                       </div>
                       <div>
                           ${h.amount}
                       </div>
                   </div>
               ))}
            </div>

            <div className="space-y-0.5 mt-1">
               <span className="text-[9px] font-bold">裁决赔偿额($万):</span>
               <Input type="number" className="h-6 bg-white text-[10px]" value={govRulingAmount} onChange={e=>setGovRulingAmount(e.target.value)}/>
            </div>
            
            {/* Req 4: Always show reason input */}
            <div className="space-y-0.5 mt-1">
               <span className="text-[9px] font-bold">裁决理由(可选):</span>
               <Input type="text" className="h-6 bg-white text-[10px]" value={govRulingReason} onChange={e=>setGovRulingReason(e.target.value)}/>
            </div>

            <Button size="sm" className="w-full bg-red-600 hover:bg-red-700 h-7 text-[10px] mt-1" onClick={()=>protestGovRuling(govRulingAmount)} disabled={govRulingAmount === "" || Number(govRulingAmount) < 0}>
               {govRulingCount >= 2 ? "发布终局裁决 (强制执行)" : "发布裁决"}
            </Button>

            <EsmpResponsibilityList ownerRespEsmp={ownerRespEsmp} />
         </div>
       );

       // Requirement 14: Government S5 Ruling
       if (stage === 5 && inspectionState === 'gov_s5_ruling') return (
           <div className="space-y-2 bg-purple-50 p-2 rounded border border-purple-200">
              <div className="font-bold text-purple-800 text-[10px]">S5 结算争议裁决</div>
              <div className="grid grid-cols-2 gap-2 mb-2">
                 <div className="bg-white p-2 rounded border border-purple-100 text-[9px]">
                    <div className="font-bold text-blue-600">业主主张</div>
                    <div>比例: {ownerPayProposal}%</div>
                    <div className="text-slate-500">{ownerFeedback}</div>
                 </div>
                 <div className="bg-white p-2 rounded border border-purple-100 text-[9px]">
                    <div className="font-bold text-orange-600">承包商主张</div>
                    <div>比例: {epcClaimProposal}%</div>
                    <div className="text-slate-500">{epcClaimReason}</div>
                 </div>
              </div>
              
              <div className="space-y-1">
                 <div className="text-[9px] font-bold">最终裁决支付比例(%):</div>
                 <Input type="number" min={ownerPaidPct} max={100} className="h-7 text-[10px]" onChange={e=>setS5GovRuling(e.target.value)}/>
              </div>
              {/* Req 4: S5 Gov Ruling Reason */}
              <div className="space-y-1">
                 <div className="text-[9px] font-bold">裁决理由(可选):</div>
                 <Textarea className="h-10 text-[10px]" onChange={e=>setS5GovRulingReason(e.target.value)}/>
              </div>
              <Button size="sm" className="w-full bg-purple-600 h-7 text-[10px]" onClick={s5GovMakeRuling}>发布裁决</Button>
           </div>
       );
    }

    // --- MDB ---
    if (role === 'mdb') {
       if (stage === 2 && s2State === 'risk_assess') return (
          <div className="flex flex-col">
             <div className="text-[9px] bg-yellow-50 border border-yellow-200 p-1 rounded mb-2 text-slate-700 leading-tight">
                请根据项目的类型、位置、敏感性和规模，判断项目的环境社会风险等级
             </div>

             <div className="text-[9px] border border-slate-200 rounded overflow-hidden mb-3 flex flex-col">
                <div className="grid grid-cols-4 bg-slate-100 font-bold p-1 border-b border-slate-200">
                   <div>风险等级</div>
                   <div className="col-span-1">分类依据</div>
                   <div className="col-span-2 pl-1">管理要求</div>
                </div>
                <div className="overflow-y-auto h-[200px]">
                   {RISK_TABLE.map((r,i) => (
                     <div key={i} className="grid grid-cols-4 p-1 border-b border-slate-100 last:border-0 bg-white hover:bg-slate-50 leading-tight">
                        <div className="font-bold text-blue-700">{r.level}</div>
                        <div className="col-span-1 text-[8px] text-slate-600">{r.basis}</div>
                        <div className="col-span-2 text-[8px] text-slate-600 pl-1">{r.req}</div>
                     </div>
                   ))}
                </div>
             </div>
             <div className="grid grid-cols-3 gap-2 mb-4">
                {['高风险','中风险','低风险'].map(l=><Button key={l} variant="outline" size="sm" className="text-[10px] h-6" onClick={()=>s2MdbRisk(l)}>{l}</Button>)}
             </div>
             {renderS1ApprovedEsiaListFull()}
          </div>
       );
       if (stage === 2 && s2State === 'mdb_sign') {
        const hasNewMandates = mdbEscpMandates.filter(id => !accumulatedMdbEscpReqs.includes(id)).length > 0;
        return (
          <div className="space-y-2 flex flex-col">
             <Alert className="p-1 bg-green-50 border-green-200 text-[9px] text-green-800"><AlertDescription>政府已批准ESCP。请复核并签约。</AlertDescription></Alert>
             <div className="bg-white border rounded h-[150px] overflow-y-auto">{ESMP_LIBRARY.map(i => {
                const isOwnerSelected = ownerEscpSelection.includes(i.id);
                const isAccumulatedGov = accumulatedGovEscpReqs.includes(i.id);
                const isAccumulatedMdb = accumulatedMdbEscpReqs.includes(i.id);
                const isAlreadyForced = isAccumulatedGov || isAccumulatedMdb;
                
                const isMdbSelected = mdbEscpMandates.includes(i.id);

                return (
                    <div key={i.id} className={`flex gap-2 py-0.5 px-1 border-b last:border-0 items-center ${isOwnerSelected || isAlreadyForced ? 'bg-slate-100 opacity-60' : ''}`}>
                        <Checkbox className="h-3 w-3"
                           checked={isOwnerSelected || isAlreadyForced || isMdbSelected} 
                           disabled={isOwnerSelected || isAlreadyForced} 
                           onCheckedChange={c=>c?setMdbEscpMandates([...mdbEscpMandates,i.id]):setMdbEscpMandates(mdbEscpMandates.filter(x=>x!==i.id))}
                        />
                        <span className="text-[9px] leading-none">{i.label}</span>
                        <div className="ml-auto flex gap-1">
                            {isOwnerSelected && !isAccumulatedGov && <Badge variant="outline" className="text-[8px] h-3 px-1 text-blue-600 leading-none">业主</Badge>}
                            {isAccumulatedGov && <Badge variant="outline" className="text-[8px] h-3 px-1 text-green-600 leading-none">政府</Badge>}
                            {isAccumulatedMdb && <Badge variant="outline" className="text-[8px] h-3 px-1 text-purple-600 leading-none">银行</Badge>}
                        </div>
                    </div>
                )
             })}</div>
             <div className="flex gap-2 mt-1">
                <div className="flex-1">
                  <Button size="sm" className="w-full bg-purple-600 h-7 text-[10px]" onClick={()=>s2MdbSign(true)}>签署1500万贷款协议</Button>
                  <div className="text-[8px] text-center text-purple-600 mt-0.5">分阶段拨付，当前支付20%</div>
                </div>
                <Button size="sm" variant="outline" className="w-full flex-1 h-7 text-[10px]" onClick={()=>s2MdbSign(false)} disabled={!hasNewMandates}>驳回</Button>
             </div>
          </div>
       );}
       if (stage === 4 && protestState === 'bank_decision') return (
          <div className="space-y-2 bg-red-50 p-2 rounded border border-red-200 flex flex-col">
             <div className="bg-white p-2 rounded border border-slate-200 text-[10px] mb-1">
                <div className="font-bold text-red-600 mb-0.5">相关事件: {currentCrisis?.title}</div>
                <div className="text-slate-500 leading-tight">{currentCrisis?.desc}</div>
             </div>

             <div className="text-[9px] border-t border-slate-200 pt-1 mb-1 max-h-24 overflow-y-auto">
                <div className="font-bold text-slate-700">历次裁决记录:</div>
                <div className="mt-0.5">
                    {govRulingHistory.map(h => (
                        <div key={h.count} className="grid grid-cols-3 gap-1 py-0.5 border-b border-slate-100">
                            <span>第{h.count}轮</span>
                            <span>${h.ngoDemand}/${h.partyOffer}</span>
                            <span className="font-bold text-purple-700">=> ${h.amount}</span>
                        </div>
                    ))}
                </div>
             </div>

             <div className="font-bold text-red-700 flex items-center gap-1 text-[10px]"><ShieldAlert size={10}/> 政府终局裁决已出</div>
             <div className="text-[9px] mb-1">是否因危机暂停当前 {currentCrisis?.index === 3 ? '15%' : '20%'} 贷款拨付?</div>
             <Button size="sm" className="w-full bg-red-700 text-white hover:bg-red-800 mb-1 h-7 text-[10px]" onClick={()=>protestBankDecision(true)}>暂停拨付</Button>
             <Button size="sm" className="w-full bg-green-600 hover:bg-green-700 h-7 text-[10px]" onClick={()=>protestBankDecision(false)}>继续拨付</Button>
          </div>
       );
    }

    // --- EPC ---
    if (role === 'epc') {
       if (stage === 3 && s3State === 'epc_bid') return (
          <div className="space-y-2 flex flex-col">
             {epcBidHistory.length > 0 && (
                <Alert className="p-1 bg-amber-50 border-amber-200 text-amber-800 mb-1">
                  <AlertDescription className="text-[9px] leading-none">
                     业主驳回了之前的报价。历史记录: {epcBidHistory.map(h=>`$${h.price}`).join(', ')}
                     {/* Req 2: Show Reject Reason */}
                     {ownerRejectReason && <div className="mt-1 text-red-600 font-bold">驳回理由: {ownerRejectReason}</div>}
                  </AlertDescription>
                </Alert>
             )}

             <div className="font-bold text-[10px] mb-0.5">责任划分 & 风险提示:</div>
             <div className="text-[9px] text-slate-500 bg-yellow-50 p-1 rounded border border-yellow-100 mb-1 leading-tight">
               根据ESMP责任划分、工期要求和各类风险，请合理报价。
             </div>
             {/* Constraint 1: Scrollbar for S3 ESMP View - Fixed Height */}
             <div className="bg-white border rounded mb-1 h-[120px] overflow-y-auto">{ESMP_LIBRARY.map(i => {
                 const isOwnerResp = ownerRespEsmp.includes(i.id);
                 return (
                    <div key={i.id} className="flex justify-between items-center py-0.5 px-1 border-b last:border-0 text-[9px]">
                       <span className="leading-none">{i.label}</span>
                       {isOwnerResp ? 
                          <Badge className="text-[8px] h-3 bg-blue-100 text-blue-700 hover:bg-blue-200 border-0 leading-none">业主</Badge> : 
                          <Badge className="text-[8px] h-3 bg-orange-100 text-orange-700 hover:bg-orange-200 border-0 leading-none">EPC</Badge>
                       }
                    </div>
                 )
             })}</div>

             <div className="space-y-0.5">
                 <div className="text-[9px] text-slate-500 leading-tight">
                     工期:{tenderDuration}月 | 误期罚款:{delayPenalty}万/月 | 提前奖励:{earlyBonus}万/月
                 </div>
                 <Input type="number" placeholder="报价($万)" className="h-7 text-[10px]" onChange={e=>setEpcBid({...epcBid, price: Number(e.target.value)})}/>
             </div>
             <Button size="sm" className="w-full bg-orange-500 hover:bg-orange-600 h-7 text-[10px]" onClick={s3EpcBid} disabled={!epcBid.price || epcBid.price <= 0}>提交报价</Button>
             {renderS2ApprovedEscpListFull()}
          </div>
       );
       // Req 3: EPC Contract Sign Confirmation
       if (stage === 3 && s3State === 'epc_contract_sign') return (
           <div className="space-y-2 bg-green-50 p-2 rounded border border-green-200 flex flex-col">
              <div className="font-bold text-center text-lg text-green-800 mb-2">业主接受报价</div>
              <div className="bg-white p-2 rounded border border-green-100 text-xs space-y-1">
                 <div className="flex justify-between"><span>合同价格:</span> <span className="font-bold">${epcBid.price}万</span></div>
                 <div className="flex justify-between"><span>合同工期:</span> <span className="font-bold">{tenderDuration}个月</span></div>
                 <div className="flex justify-between"><span>误期罚款:</span> <span className="font-bold">{delayPenalty}万/月</span></div>
                 <div className="flex justify-between"><span>提前奖励:</span> <span className="font-bold">{earlyBonus}万/月</span></div>
              </div>
              <div className="text-[10px] text-center text-slate-500 mt-2">请确认签署合同，随后进入项目建设阶段。</div>
              <Button size="sm" className="w-full bg-green-600 mt-2" onClick={s3EpcSignConfirm}>签署确认 & 进入建设阶段</Button>
           </div>
       );
       
       if (stage === 4 && (s4State === 's4_planning' || s4State === 's4_epc_replan')) return (
          <div className="space-y-2 flex flex-col">
             <div className="font-bold text-[10px]">ESMP执行方案:</div>
             <div className="text-[9px] text-red-500 bg-red-50 p-1 rounded border border-red-100 mb-1 leading-tight">
                {s4State === 's4_epc_replan' ? "整改阶段：被查出的漏项必须选择，且成本增加20%。之前已选的项不可撤销。" : "已提交选项不可撤回；若未执行且被业主审查发现，后续成本增加20%，声誉降低5分/项。"}
             </div>
             
             <div className="bg-white border rounded h-[150px] overflow-y-auto">{ESMP_LIBRARY.map(item => {
                 const isOwnerResp = ownerRespEsmp.includes(item.id);
                 const isViolation = epcViolations.includes(item.id);
                 
                 const wasOriginallySelected = originalEpcExecPlan.includes(item.id);
                 const isForced = s4State === 's4_epc_replan' && (isViolation || wasOriginallySelected);
                 
                 let displayCost = item.cost;
                 if (s4State === 's4_epc_replan' && isViolation) displayCost = Math.round(item.cost * 1.2);

                 return (
                   <div key={item.id} className={`flex gap-1 py-0.5 px-1 items-center border-b last:border-0 ${isOwnerResp ? 'opacity-50 bg-slate-50' : ''}`}>
                       <Checkbox className="h-3 w-3"
                          checked={isOwnerResp ? false : (isForced ? true : epcExecPlan.includes(item.id))} 
                          disabled={isOwnerResp || isForced}
                          onCheckedChange={c=>c?setEpcExecPlan([...epcExecPlan,item.id]):setEpcExecPlan(epcExecPlan.filter(x=>x!==item.id))}
                       />
                       <div className="flex flex-col justify-center">
                          <span className="text-[9px] leading-none">{item.label} (${displayCost}万)</span>
                          <div className="flex gap-1 mt-0.5">
                             {isOwnerResp && <span className="text-[8px] text-blue-500 leading-none">业主负责</span>}
                             {isViolation && <span className="text-[8px] text-red-600 font-bold leading-none">整改必选 (+20%)</span>}
                             {wasOriginallySelected && s4State === 's4_epc_replan' && <span className="text-[8px] text-gray-500 flex items-center leading-none"><Lock size={8} className="mr-0.5"/>已锁定</span>}
                          </div>
                       </div>
                   </div>
                 )
             })}</div>
             
             {s4State === 's4_planning' ? 
                <Button size="sm" className="w-full h-7 text-[10px]" onClick={s4EpcPlan}>提交执行方案</Button> :
                <Button size="sm" className="w-full bg-orange-600 h-7 text-[10px]" onClick={s4EpcReplanSubmit}>提交整改方案</Button>
             }
             {renderS2ApprovedEscpListFull()}
          </div>
       );
       // Req 4: EPC Audit Pass Confirmation
       if (stage === 4 && s4State === 'epc_audit_pass_confirm') return (
          <div className="space-y-2 bg-green-50 p-2 rounded border border-green-200 flex flex-col items-center justify-center h-full">
             <CheckCircle2 size={32} className="text-green-600 mb-2"/>
             <div className="font-bold text-green-800 text-center">业主ESMP审计通过</div>
             <div className="text-xs text-slate-600 text-center mb-4">您的执行方案已通过业主审查。点击确认开始施工。</div>
             <Button size="sm" className="w-full bg-green-600" onClick={s4EpcConfirmAuditPass}>确认 & 开始施工</Button>
          </div>
       );

       if (stage === 4 && protestState === 'epc_route_check') return (
         <div className="space-y-2 bg-orange-50 p-2 rounded border border-orange-200 flex flex-col">
             <CrisisContextBox crisis={currentCrisis} />
             
             <div className="font-bold text-orange-800 text-[10px]">业主转交危机处理</div>
             <div className="text-[9px] mb-1">业主认为这是EPC承包商的责任，转交给你处理。是否接受?</div>
             
             <Button size="sm" className="w-full bg-blue-600 mb-1 h-7 text-[10px]" onClick={()=>protestEpcRouteCheck(true)}>接受处理 (承担赔偿责任)</Button>
             <Button size="sm" variant="outline" className="w-full h-7 text-[10px]" onClick={()=>protestEpcRouteCheck(false)}>拒绝 (非我方责任，退回)</Button>

             <EsmpResponsibilityList ownerRespEsmp={ownerRespEsmp} />
         </div>
       );
       if (stage === 4 && protestState === 'party_negotiate' && protestHandler === 'epc') return (
          <div className="space-y-2 bg-blue-50 p-2 rounded border border-blue-200">
             <CrisisContextBox crisis={currentCrisis} />
             <div className="text-[10px] font-bold text-red-600">公众索赔: ${ngoDemandAmount}万</div>
             {ngoDemandReason && <div className="text-[9px] bg-white p-1 rounded text-red-600 mb-1">理由: {ngoDemandReason}</div>}
             
             <Input type="number" placeholder="输入主张金额($)" className="h-7 text-[10px] bg-white mb-1" onChange={e=>setOfferAmount(Number(e.target.value))}/>
             
             {/* Req 1: Reason Input */}
             <Input type="text" placeholder="理由(可选)" className="h-7 text-[10px] bg-white mb-1" onChange={e=>setPartyOfferReason(e.target.value)}/>

             <Button size="sm" className="w-full h-7 text-[10px]" onClick={()=>protestPartyNegotiate(offerAmount)} disabled={offerAmount < 0}>主张赔偿</Button>
          </div>
       );
       if (stage === 4 && protestState === 'parties_react_ruling' && protestHandler === 'epc') return (
         <div className="space-y-2 bg-blue-50 p-2 rounded border border-blue-200">
            <CrisisContextBox crisis={currentCrisis} />
            <div className="font-bold text-blue-800 flex items-center gap-1 text-[10px]"><Gavel size={10}/> 政府裁决: ${govRulingAmount}万</div>
            {govRulingReason && <div className="text-[9px] bg-white p-1 rounded text-purple-700 mb-1">理由: {govRulingReason}</div>}
            
            {!partyResponse ? (
              <>
                 <Button size="sm" className="w-full bg-green-600 h-7 text-[10px]" onClick={()=>submitPartyReaction('accept')}>接受裁决</Button>
                 <div className="pt-2 mt-1 border-t border-blue-200 space-y-1">
                    <Input type="number" placeholder="申诉主张金额($)" className="h-7 bg-white text-[10px]" value={partyAppealInput} onChange={e=>setPartyAppealInput(e.target.value)} />
                    {/* Req 4: Party Appeal Reason */}
                    <Input type="text" placeholder="申诉理由(可选)" className="h-7 bg-white text-[10px] mt-1" value={partyAppealReason} onChange={e=>setPartyAppealReason(e.target.value)} />
                    <Button size="sm" className="w-full bg-red-600 h-7 text-[10px] mt-1" onClick={()=>submitPartyReaction('appeal', partyAppealInput, partyAppealReason)} disabled={!partyAppealInput}>提交申诉</Button>
                 </div>
              </>
            ) : <div className="text-center text-gray-600 text-[9px] mt-2 italic">已提交，等待对方...</div>}
         </div>
       );
       
       // Requirement 9: EPC Notification Step with protest option
       if (stage === 4 && protestState === 'epc_notify_freeze') return (
         <div className="space-y-2 bg-red-50 p-2 rounded border border-red-200">
             <CrisisContextBox crisis={currentCrisis} />
             <div className="font-bold text-red-800 text-[10px] flex items-center gap-1"><AlertTriangle size={10}/> 业主暂停支付</div>
             <div className="text-[9px] mb-2 bg-white p-2 rounded border border-red-100">
                 业主已通知，暂停本阶段 {currentCrisis?.index === 3 ? '15%' : '20%'} 的进度款支付。
                 {ownerPayDecisionReason && <div className="mt-1 font-bold">理由: {ownerPayDecisionReason}</div>}
             </div>
             
             {/* Req 3: EPC Protest Reason */}
             <Input type="text" placeholder="抗议理由(可选)" className="h-7 text-[10px] bg-white mb-1" onChange={e=>setEpcProtestReason(e.target.value)}/>

             <Button size="sm" className="w-full bg-slate-600 mb-1 h-7 text-[10px]" onClick={()=>protestEpcNotifyFreeze(false)}>知悉，继续项目</Button>
             <Button size="sm" className="w-full bg-red-600 h-7 text-[10px]" onClick={()=>protestEpcNotifyFreeze(true)}>反对，要求业主支付</Button>
         </div>
       );

       if (stage === 5 && inspectionState === 'epc_apply') return (
         <div className="space-y-2">
            <div className="font-bold text-[10px] text-green-700">项目建设完成</div>
            <div className="text-[9px] bg-slate-100 p-1 rounded">业主已支付: {ownerPaidPct}% 合同款</div>
            <Button size="sm" className="w-full bg-green-600 h-7 text-[10px]" onClick={s5EpcApply}>发起竣工检验申请</Button>
         </div>
      );
      
      // Requirement 12: EPC Review Proposal Logic
      if (stage === 5 && inspectionState === 'epc_review_proposal') return (
         <div className="space-y-2 bg-blue-50 p-2 rounded border border-blue-200">
             <div className="font-bold text-blue-800 text-[10px]">业主通过验收</div>
             <div className="bg-white p-2 rounded border border-blue-100 text-[9px] mb-2">
                 <div><span className="font-bold">拟支付比例:</span> {ownerPayProposal}%</div>
                 <div><span className="font-bold">业主意见:</span> {ownerFeedback}</div>
             </div>
             <Button size="sm" className="w-full bg-green-600 mb-1 h-7 text-[10px]" onClick={()=>s5EpcReview(true)}>接受，完成结算</Button>
             <Button size="sm" className="w-full bg-red-600 h-7 text-[10px]" onClick={()=>s5EpcReview(false)}>申诉</Button>
         </div>
      );

      if (stage === 5 && inspectionState === 'epc_appeal_input') return (
         <div className="space-y-2 bg-red-50 p-2 rounded border border-red-200">
             <div className="font-bold text-red-800 text-[10px]">发起申诉</div>
             <div className="space-y-1">
                 <div className="text-[9px] font-bold">主张支付比例(%):</div>
                 <Input type="number" min={ownerPaidPct} max={100} className="h-7 text-[10px]" onChange={e=>setEpcClaimProposal(e.target.value)}/>
             </div>
             <div className="space-y-1">
                 <div className="text-[9px] font-bold">申诉理由:</div>
                 <Textarea className="h-12 text-[10px] bg-white" onChange={e=>setEpcClaimReason(e.target.value)}/>
             </div>
             <Button size="sm" className="w-full bg-red-600 mt-2 h-7 text-[10px]" onClick={s5EpcSubmitAppeal}>提交申诉 (政府介入)</Button>
         </div>
      );
    }

    // --- NGO ---
    if (role === 'ngo') {
      if (stage === 1 && s1State === 'ngo_eval') {
         const hasNewReqs = ngoRequirements.filter(id => !accumulatedNgoReqs.includes(id)).length > 0;
         return (
         <div className="space-y-2 flex flex-col">
            <div className="font-bold text-[10px] text-red-700">如对业主ESIA不满意，请勾选补充:</div>
            <div className="bg-white border rounded h-[150px] overflow-y-auto">{ESIA_ITEMS.map(i=> {
                const isOwnerSelected = confirmedEsiaSelection.includes(i.id);
                const isPrevReq = accumulatedNgoReqs.includes(i.id);
                if (isOwnerSelected) return <div key={i.id} className="flex gap-1 py-0.5 px-1 items-center bg-slate-100 opacity-60 border-b last:border-0"><Checkbox className="h-3 w-3" checked disabled /><span className="text-[9px] text-slate-500 leading-none">{i.label}</span></div>
                return (
                  <div key={i.id} className="flex gap-1 py-0.5 px-1 items-center hover:bg-slate-50 border-b last:border-0">
                     <Checkbox className="h-3 w-3" checked={isPrevReq || ngoRequirements.includes(i.id)} onCheckedChange={c=>c?setNgoRequirements([...ngoRequirements,i.id]):setNgoRequirements(ngoRequirements.filter(x=>x!==i.id))}/>
                     <span className="text-[9px] leading-none">{i.label}</span>
                     {isPrevReq && <Badge variant="outline" className="ml-auto text-[8px] h-3 px-1 text-red-500 bg-red-50 border-red-100 leading-none">公众</Badge>}
                  </div>
                )
            })}</div>
            <div className="text-[9px] text-slate-500 bg-slate-100 p-1 rounded leading-tight">监督成本2万/项，声誉+2分/项。</div>
            <div className="flex gap-2">
               <Button size="sm" variant="destructive" className="flex-1 h-7 text-[10px]" onClick={()=>s1NgoEval(true)} disabled={!hasNewReqs}>抗议</Button>
               <Button size="sm" variant="outline" className="flex-1 h-7 text-[10px]" onClick={()=>s1NgoEval(false)}>无异议</Button>
            </div>
         </div>
      );}
      if (stage === 4 && protestState === 'ngo_decide') return (
         <div className="space-y-2 bg-yellow-50 p-2 rounded border border-yellow-200 flex flex-col">
            <div className="font-bold text-red-600 text-[10px]">危机爆发: {currentCrisis?.title}</div>
            <div className="text-[9px] text-slate-700 mb-1 leading-tight overflow-y-auto max-h-32 bg-white p-1 border rounded">{currentCrisis?.desc}</div>
            
            <div className="text-[9px] text-slate-500 mb-1">提示: 索赔需花费努力成本10万(声誉+10); 不索赔声誉-10。</div>
            <Button size="sm" className="w-full bg-red-600 mb-1 h-7 text-[10px]" onClick={()=>protestNgoDecide(true)}>要求赔偿</Button>
            <Button size="sm" variant="outline" className="w-full h-7 text-[10px]" onClick={()=>protestNgoDecide(false)} disabled={ngoNoClaimDisabled}>不要求赔偿</Button>
         </div>
      );
      if (stage === 4 && protestState === 'ngo_input_demand') return (
         <div className="space-y-2">
            <CrisisContextBox crisis={currentCrisis} />
            <div className="space-y-0.5">
              <span className="text-[9px] font-bold">输入赔偿金额($万)</span>
              <Input type="number" className="h-7 text-[10px]" onChange={e=>setNgoDemandAmount(Number(e.target.value))}/>
            </div>
            {/* Req 1: Reason Input */}
            <div className="space-y-0.5">
               <span className="text-[9px] font-bold">索赔理由(可选)</span>
               <Input type="text" className="h-7 text-[10px]" onChange={e=>setNgoDemandReason(e.target.value)}/>
            </div>

            <Button size="sm" className="w-full bg-red-600 h-7 text-[10px]" onClick={protestNgoSubmitDemand} disabled={!ngoDemandAmount || ngoDemandAmount <= 0}>提交索赔</Button>
         </div>
      );
      if (stage === 4 && protestState === 'ngo_response') return (
         <div className="space-y-2 bg-blue-50 p-2 rounded border border-blue-200">
            <CrisisContextBox crisis={currentCrisis} />
            <div className="font-bold text-center border-b border-blue-200 pb-1 mb-1 text-[10px]">对方主张</div>
            <div className="flex justify-between text-[10px] mb-1">
               <div className="text-red-600 font-bold">我的诉求: ${ngoDemandAmount}</div>
               <div className="text-green-600 font-bold">对方主张: ${offerAmount}</div>
            </div>
            {partyOfferReason && <div className="text-[9px] bg-white p-1 rounded text-blue-600 mb-1">对方理由: {partyOfferReason}</div>}

            <Button size="sm" className="w-full bg-green-600 mb-1 h-7 text-[10px]" onClick={()=>protestNgoResponse(true)}>接受</Button>
            <Button size="sm" className="w-full bg-red-600 h-7 text-[10px]" onClick={()=>protestNgoResponse(false)}>拒绝 (政府介入)</Button>
         </div>
      );
      if (stage === 4 && protestState === 'parties_react_ruling') return (
         <div className="space-y-2 bg-blue-50 p-2 rounded border border-blue-200">
            <CrisisContextBox crisis={currentCrisis} />
            <div className="font-bold text-blue-800 flex items-center gap-1 text-[10px]"><Gavel size={10}/> 政府裁决: ${govRulingAmount}万</div>
            {govRulingReason && <div className="text-[9px] bg-white p-1 rounded text-purple-700 mb-1">理由: {govRulingReason}</div>}

            {!ngoResponse ? (
              <>
                <Button size="sm" className="w-full bg-green-600 h-7 text-[10px]" onClick={()=>submitNgoReaction('accept')}>接受裁决</Button>
                <div className="pt-2 mt-1 border-t border-blue-200 space-y-1">
                    <Input type="number" placeholder="申诉赔偿金额($)" className="h-7 bg-white text-[10px]" value={ngoAppealInput} onChange={e=>setNgoAppealInput(e.target.value)} />
                    {/* Req 4: Ngo Appeal Reason */}
                    <Input type="text" placeholder="申诉理由(可选)" className="h-7 bg-white text-[10px] mt-1" value={ngoAppealReason} onChange={e=>setNgoAppealReason(e.target.value)} />
                    <Button size="sm" className="w-full bg-red-600 h-7 text-[10px] mt-1" onClick={()=>submitNgoReaction('appeal', ngoAppealInput, ngoAppealReason)} disabled={!ngoAppealInput}>提交申诉</Button>
                </div>
              </>
            ) : <div className="text-center text-gray-600 text-[9px] mt-2 italic">已提交，等待对方...</div>}
         </div>
      );
    }

    return null;
  };

  const renderScene = () => {
      let content = null;
      let bgImage = "https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?auto=format&fit=crop&w=1000&q=80"; 

      if (stage === 1) {
          bgImage = "https://images.unsplash.com/photo-1532601224476-15c79f2f7a51?auto=format&fit=crop&w=1000&q=80"; // Desert landscape
          content = (
              <div className="flex flex-col items-center animate-in fade-in duration-1000">
                  <MapPin size={64} className="text-blue-400 mb-2 drop-shadow-lg" />
              </div>
          );
      } else if (stage === 2) {
          bgImage = "https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?auto=format&fit=crop&w=1000&q=80"; // Finance
          content = (
              <div className="flex flex-col items-center animate-in zoom-in duration-700">
                  <Banknote size={64} className="text-green-400 mb-2" />
              </div>
          );
      } else if (stage === 3) {
          bgImage = "https://images.unsplash.com/photo-1521791136064-7986c2920216?auto=format&fit=crop&w=1000&q=80"; // Handshake/Meeting
          content = (
              <div className="flex flex-col items-center animate-in fade-in duration-1000">
                  <Handshake size={80} className="text-orange-400 opacity-80" />
              </div>
          );
      } else if (stage === 4) {
          bgImage = "https://images.unsplash.com/photo-1541888946425-d81bb19240f5?auto=format&fit=crop&w=1000&q=80"; // Construction site
          if (s4State === 'construction_start' || s4State.includes('crisis')) {
              content = (
                  <div className="flex flex-col items-center text-center px-8 bg-black/30 p-4 rounded">
                      {s4State.includes('crisis') ? 
                        <AlertTriangle size={64} className="text-red-500 mb-2 animate-pulse" /> :
                        <HardHat size={64} className="text-yellow-400 mb-4" />
                      }
                  </div>
              );
          } 
      } else if (stage === 5 || stage === 6) {
          bgImage = "https://images.unsplash.com/photo-1509391366360-2e959784a276?auto=format&fit=crop&w=1000&q=80"; // Solar panels
          content = (
              <div className="flex flex-col items-center">
                  <Zap size={48} className="text-yellow-400 animate-bounce" />
              </div>
          );
      }

      return (
        <div className={`absolute inset-0 bg-slate-900 flex items-center justify-center overflow-hidden`}>
            <img src={bgImage} alt="Background" className="absolute inset-0 w-full h-full object-cover opacity-40" />
            <div className="z-10 transform scale-110 drop-shadow-2xl">{content}</div>
        </div>
      );
  };

  const renderSummaryOverlay = () => {
    if (stage !== 6 || Object.keys(isSummarySubmitted).length < 5) return null;

    // Calculate Averages
    const averages = {};
    Object.keys(INITIAL_STATES).forEach(target => {
        let sum = 0;
        let count = 0;
        Object.values(summaryData).forEach(data => {
            if (data.scores && data.scores[target]) {
                sum += parseFloat(data.scores[target]);
                count++;
            }
        });
        averages[target] = count > 0 ? (sum / count).toFixed(1) : 0;
    });

    const actualTotalMonths = Math.round((timeEnd - timeStart1) / 60);
    const plannedTotalMonths = 24;
    const totalDeviation = actualTotalMonths - plannedTotalMonths;
    
    const totalDevText = totalDeviation > 0 ? `延误 ${totalDeviation} 个月` : (totalDeviation < 0 ? `提前 ${Math.abs(totalDeviation)} 个月` : `按期完工`);
    const totalDevColor = totalDeviation > 0 ? 'text-red-600' : 'text-green-600';

    const actualEpcMonths = Math.round((timeEnd - timeStart2) / 60);
    const contractDuration = finalContractDuration || 20;
    const epcDeviation = actualEpcMonths - contractDuration;
    
    const epcDevText = epcDeviation > 0 ? `延误 ${epcDeviation} 个月` : (epcDeviation < 0 ? `提前 ${Math.abs(epcDeviation)} 个月` : `按期完工`);
    const epcDevColor = epcDeviation > 0 ? 'text-red-600' : 'text-green-600';

    return (
       <div className="absolute inset-0 bg-white/95 z-50 flex flex-col p-8 overflow-y-auto animate-in fade-in">
          <h2 className="text-3xl font-bold text-center mb-6 flex items-center justify-center gap-2"><Award className="text-yellow-500"/> 项目完工总结报告</h2>
          
          <div className="max-w-5xl mx-auto w-full mb-8 grid grid-cols-1 md:grid-cols-2 gap-4">
              <Card className="border-t-4 border-blue-600 shadow-sm">
                  <CardHeader className="pb-2"><CardTitle className="text-sm flex items-center gap-2"><PieChart size={16}/> 最终状态统计</CardTitle></CardHeader>
                  <CardContent>
                      <div className="grid grid-cols-5 gap-2 text-center text-xs font-bold bg-slate-100 p-2 rounded-t-md">
                          <div>角色</div>
                          <div>资金/成本</div>
                          <div>声誉</div>
                          <div>平均满意度</div>
                      </div>
                      {Object.keys(INITIAL_STATES).map(role => {
                          const s = playerState[role];
                          let val = s.money !== undefined ? s.money.toFixed(1) : (s.cost !== undefined ? s.cost : s.benefit);
                          let label = s.money !== undefined ? '资金' : (s.cost !== undefined ? '成本' : '效益');
                          return (
                              <div key={role} className="grid grid-cols-5 gap-2 text-center text-xs p-2 border-b border-slate-100 last:border-0">
                                  <div className="font-bold text-slate-700">{INITIAL_STATES[role].label}</div>
                                  <div>{label}: {val}</div>
                                  <div className={s.reputation < 60 ? 'text-red-600' : 'text-green-600'}>{s.reputation}</div>
                                  <div className="font-bold text-blue-600">{averages[role]}</div>
                              </div>
                          )
                      })}
                  </CardContent>
              </Card>

              <Card className="border-t-4 border-green-600 shadow-sm">
                  <CardHeader className="pb-2"><CardTitle className="text-sm flex items-center gap-2"><BarChart3 size={16}/> 项目执行概况</CardTitle></CardHeader>
                  <CardContent className="space-y-4 pt-4">
                      <div className="grid grid-cols-2 gap-4">
                         <div>
                             <div className="text-xs text-slate-500 mb-1">项目总工期 (实际/计划)</div>
                             <div className="text-lg font-bold flex items-center gap-2">
                                 {actualTotalMonths} / {plannedTotalMonths} <span className="text-xs text-slate-400">月</span>
                             </div>
                             <div className={`text-sm font-bold ${totalDevColor}`}>{totalDevText}</div>
                         </div>
                         <div>
                             <div className="text-xs text-slate-500 mb-1">EPC承包商工期 (实际/合同)</div>
                             <div className="text-lg font-bold flex items-center gap-2">
                                 {actualEpcMonths} / {contractDuration} <span className="text-xs text-slate-400">月</span>
                             </div>
                             <div className={`text-sm font-bold ${epcDevColor}`}>{epcDevText}</div>
                         </div>
                      </div>
                      <div className="pt-4 border-t border-slate-100">
                          <div className="flex justify-between text-xs mb-1">
                              <span>银行贷款拨付进度</span>
                              <span className="font-bold">{bankDisbursedPct.toFixed(0)}%</span>
                          </div>
                          <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                              <div className="h-full bg-purple-500" style={{width: `${bankDisbursedPct}%`}}></div>
                          </div>
                      </div>
                  </CardContent>
              </Card>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
             {Object.keys(INITIAL_STATES).map(role => (
                <Card key={role} className="border-t-4 border-slate-500 shadow-lg">
                   <CardHeader className="pb-2"><CardTitle className="text-sm">{INITIAL_STATES[role].label}</CardTitle></CardHeader>
                   <CardContent className="text-[10px] space-y-2">
                      <div className="bg-green-50 p-1 rounded border border-green-100"><span className="font-bold">优点:</span> {summaryData[role]?.pros}</div>
                      <div className="bg-red-50 p-1 rounded border border-red-100"><span className="font-bold">不足:</span> {summaryData[role]?.cons}</div>
                      <div className="border-t pt-1 font-bold">满意度评价:</div>
                      {summaryData[role]?.scores && Object.entries(summaryData[role].scores).map(([k,v])=>(
                         <div key={k} className="flex justify-between"><span>{INITIAL_STATES[k].label}</span><span>{v}</span></div>
                      ))}
                   </CardContent>
                </Card>
             ))}
          </div>
          <div className="mt-8 text-center text-slate-500 text-sm">
             {/* Req 7: Removed period */}
             感谢您的参与，欢迎关注天津大学全球工程经营实验室
          </div>
          <Button size="lg" className="mt-4 mx-auto" onClick={() => window.location.reload()}>结束并重启</Button>
       </div>
    );
  };

  // --- Main Render ---
  
  if (viewMode === 'cover') return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-slate-900 text-white p-8 relative overflow-hidden font-sans">
        <img 
          src="https://images.unsplash.com/photo-1473341304170-971dccb5ac1e?auto=format&fit=crop&w=2000&q=80" 
          alt="Cover Background" 
          className="absolute inset-0 w-full h-full object-cover opacity-30"
        />
        
        <div className="text-center space-y-8 z-10 animate-in fade-in duration-1000 slide-in-from-bottom-10 relative -top-[10%] leading-loose">
            <div className="mb-8 flex justify-center">
               <div className="w-24 h-24 bg-blue-500 rounded-full blur-[60px] absolute opacity-50 animate-pulse"></div>
               <Activity size={80} className="text-blue-400 relative z-10" />
            </div>
            <div className="space-y-4 relative -top-[25px]">
                <h1 className="text-5xl md:text-7xl font-black tracking-tight text-white drop-shadow-lg leading-relaxed">
                    SunLink
                </h1>
                <h1 className="text-4xl md:text-6xl font-black tracking-tight text-blue-300 drop-shadow-lg leading-relaxed">
                    ESG Simulator
                </h1>
            </div>

            <div className="mt-8 space-y-4 relative -top-[10px]">
                <h2 className="text-xl md:text-2xl font-light text-slate-200 tracking-wide leading-relaxed">
                    国际工程项目ESG
                </h2>
                <h2 className="text-xl md:text-2xl font-light text-slate-200 tracking-wide leading-relaxed">
                    多角色全流程模拟
                </h2>
            </div>
            
            <div className="mt-16">
                <Button 
                   size="lg" 
                   className="text-lg px-12 py-8 bg-blue-600 hover:bg-blue-500 text-white rounded-full shadow-[0_0_30px_-5px_rgba(37,99,235,0.5)] transition-all transform hover:scale-105 hover:shadow-[0_0_50px_-10px_rgba(37,99,235,0.7)] border border-blue-400/50 leading-relaxed" 
                   onClick={() => setViewMode('intro')}
                >
                   点击进入
                </Button>
            </div>
        </div>

        <div className="absolute bottom-8 text-center space-y-6 z-10 opacity-80 text-sm w-full flex flex-col items-center leading-[2.5]">
            <div>
                <p className="font-bold text-slate-200">开发单位：天津大学全球工程经营实验室</p>
                <p className="text-xs text-slate-400 font-light tracking-wider">Developed by Tianjin University Global Infrastructure Project Center</p>
            </div>
            <div className="mt-4">
                <p className="font-bold text-slate-200">联系人：傅老师 yongcheng_fu@126.com</p>
                <p className="text-xs text-slate-400 font-light tracking-wider">Contact: Dr. Fu  yongcheng_fu@126.com</p>
            </div>
        </div>
    </div>
  );

  if (viewMode === 'intro') return (
    <div className="min-h-screen flex items-center justify-center bg-slate-50 p-6 font-sans">
      <Card className="w-full max-w-5xl shadow-2xl border-t-4 border-blue-600 bg-white/95 backdrop-blur">
        <CardHeader className="border-b border-slate-100 pb-4">
          <div className="flex justify-between items-center">
             <div className="space-y-1">
                <CardTitle className="text-3xl font-black text-slate-800 tracking-tight">{PROJECT_INFO.name}</CardTitle>
                <div className="flex items-center gap-2 text-slate-500 text-sm font-medium">
                   <MapPin size={14} /> {PROJECT_INFO.location}
                </div>
             </div>
             <Badge variant="outline" className="text-blue-600 border-blue-200 bg-blue-50 text-lg px-3 py-1">v7.15</Badge>
          </div>
        </CardHeader>
        <CardContent className="space-y-8 pt-6">
          
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
             <div className="md:col-span-2 space-y-4">
                <div className="space-y-2">
                   <h3 className="font-bold text-lg flex items-center gap-2 text-slate-800"><FileText size={20} className="text-blue-500"/> 项目背景</h3>
                   <p className="text-slate-600 leading-relaxed text-justify text-sm">{PROJECT_INFO.background}</p>
                </div>
                
                <div className="space-y-2">
                   <h3 className="font-bold text-lg flex items-center gap-2 text-slate-800"><Target size={20} className="text-red-500"/> 挑战与使命</h3>
                   <p className="text-slate-600 leading-relaxed text-justify text-sm font-medium bg-slate-50 p-3 rounded border-l-4 border-slate-300">{PROJECT_INFO.mission}</p>
                </div>
             </div>

             <div className="space-y-4">
                <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 shadow-sm">
                   <h3 className="font-bold text-blue-800 mb-3 flex items-center gap-2"><Zap size={18}/> 工程范围</h3>
                   <ul className="space-y-2 text-xs text-blue-900">
                      {PROJECT_INFO.scope_items.map((item, i) => (
                         <li key={i} className="flex gap-2 items-start">
                            <span className="mt-1 w-1.5 h-1.5 rounded-full bg-blue-400 shrink-0"></span>
                            <span>{item}</span>
                         </li>
                      ))}
                   </ul>
                </div>
                <div className="bg-green-50 p-4 rounded-xl border border-green-100 shadow-sm">
                   <h3 className="font-bold text-green-800 mb-2 flex items-center gap-2"><Clock size={18}/> 并网发电进度目标</h3>
                   <div className="text-2xl font-black text-green-600">24个月</div>
                   <div className="text-xs text-green-700 mt-1 opacity-80">游戏中 1分钟 ≈ 现实 1个月</div>
                </div>
             </div>
          </div>

          <div className="space-y-4">
             <h3 className="font-bold text-lg flex items-center gap-2 text-slate-800"><Scale size={20} className="text-purple-500"/> 模拟阶段概览</h3>
             <div className="grid grid-cols-2 md:grid-cols-5 gap-2">
                {PROJECT_INFO.stages_visual.map((s) => (
                   <div key={s.id} className={`border p-3 rounded-lg text-center hover:shadow-md transition-all group ${s.color}`}>
                      <div className="w-8 h-8 rounded-full bg-white/50 backdrop-blur-sm flex items-center justify-center text-sm font-bold mb-2 mx-auto shadow-sm">{s.id}</div>
                      <div className="font-bold text-xs mb-1">{s.title}</div>
                      <div className="text-[10px] opacity-80 leading-tight">{s.task}</div>
                   </div>
                ))}
             </div>
          </div>

          <div className="pt-4 flex justify-center">
             <Button size="lg" className="w-full md:w-1/3 bg-slate-900 hover:bg-slate-800 text-white shadow-xl transform hover:-translate-y-1 transition-all" onClick={()=>setViewMode('roles')}>
                下一步: 查阅角色档案
             </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );

  if (viewMode === 'roles') return (
    <div className="min-h-screen bg-slate-50 p-4 font-sans overflow-y-auto">
       <div className="max-w-6xl mx-auto">
         <div className="flex justify-between items-center mb-6">
           <h2 className="text-2xl font-bold text-slate-800">角色档案</h2>
           <Button onClick={()=>setViewMode(isTimerRunning ? 'game' : 'intro')} variant="outline"><Reply className="mr-2" size={16}/>返回</Button>
         </div>
         <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            
            <Card className="border-t-8 border-slate-600 bg-white hover:shadow-xl transition-all min-h-[320px]">
                <CardHeader className="pb-4">
                    <CardTitle className="flex items-center gap-3 text-xl text-slate-700">
                        <div className="p-2 bg-slate-100 rounded-full shadow-sm"><ScrollText size={24}/></div> 
                        知情同意书
                    </CardTitle>
                </CardHeader>
                <CardContent className="text-sm text-slate-600 space-y-3 leading-relaxed">
                    <p>您即将参与的是一项关于国际工程项目ESG管理的决策行为实验，由天津大学全球工程经营实验室开发。</p>
                    <p>匿名性：您的所有回答将被严格保密，系统仅记录去标识化的决策数据用于科研统计分析。</p>
                    <p>自愿性：参与本实验完全自愿，您有权在任何时候关闭页面退出。</p>
                    <p>无风险：本实验不涉及任何商业利益或个人隐私风险。</p>
                </CardContent>
            </Card>

            {Object.entries(ROLE_DETAILS).map(([key, info]) => {
               const Icon = key==='owner'?User : key==='gov'?Landmark : key==='mdb'?Globe : key==='epc'?Building2 : Users;
               const styles = key==='owner'? 'border-blue-500 bg-blue-50/30' : 
                              key==='gov'? 'border-green-600 bg-green-50/30' : 
                              key==='mdb'? 'border-purple-600 bg-purple-50/30' : 
                              key==='epc'? 'border-orange-500 bg-orange-50/30' : 
                              'border-red-500 bg-red-50/30';
               const iconColor = key==='owner'?'text-blue-600':key==='gov'?'text-green-600':key==='mdb'?'text-purple-600':key==='epc'?'text-orange-500':'text-red-600';
               
               const descBg = key==='owner'?'bg-blue-100 text-blue-900':key==='gov'?'bg-green-100 text-green-900':key==='mdb'?'bg-purple-100 text-purple-900':key==='epc'?'bg-orange-100 text-orange-900':'bg-red-100 text-red-900';
               const statBg = key==='owner'?'bg-blue-50 border-blue-200':key==='gov'?'bg-green-50 border-green-200':key==='mdb'?'bg-purple-50 border-purple-200':key==='epc'?'bg-orange-50 border-orange-200':'bg-red-50 border-red-200';

               return (
                 <Card key={key} className={`border-t-8 hover:shadow-xl transition-all bg-white ${styles} min-h-[320px]`}>
                    <CardHeader className="pb-4">
                        <CardTitle className={`flex items-center gap-3 text-xl ${iconColor}`}>
                            <div className="p-2 bg-white rounded-full shadow-sm"><Icon size={24}/></div> 
                            {INITIAL_STATES[key].label}
                        </CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-5 text-base text-slate-700">
                       <div className={`p-3 rounded-md font-bold text-sm ${descBg}`}>{info.desc}</div>
                       <div className="bg-white p-4 rounded-md text-sm italic border-l-4 border-slate-400 shadow-sm leading-relaxed">{info.task}</div>
                       <div className="grid grid-cols-2 gap-4 pt-2">
                          <div className={`p-3 border rounded-md font-semibold flex flex-col items-center justify-center ${statBg}`}>
                            <span className="text-xs text-slate-500 mb-1">
                               {key==='owner' ? "初始资金" : 
                                key==='epc' ? "初始资金" :
                                (key==='gov'||key==='mdb') ? "初始监督成本" : "社会效益"}
                            </span>
                            <span className="text-xl">
                               ${key==='owner' ? INITIAL_STATES[key].money : 
                                key==='epc' ? INITIAL_STATES[key].money :
                                (key==='gov'||key==='mdb') ? INITIAL_STATES[key].cost : INITIAL_STATES[key].benefit}万
                            </span>
                          </div>
                          <div className={`p-3 border rounded-md font-semibold flex flex-col items-center justify-center ${statBg}`}>
                            <span className="text-xs text-slate-500 mb-1">初始声誉</span>
                            <span className="text-xl">{INITIAL_STATES[key].reputation}分</span>
                          </div>
                       </div>
                    </CardContent>
                 </Card>
               )
            })}
         </div>
         <div className="text-center">
           {!isTimerRunning && <Button size="lg" className="bg-green-600 hover:bg-green-700 px-12 py-6 text-xl shadow-md font-bold rounded-full" onClick={startSim}>开始模拟</Button>}
         </div>
       </div>
    </div>
  );

  // Game Layout - Responsive Grid (Requirement 1: UI Optimization)
  return (
    <div className="h-screen w-full bg-slate-100 flex flex-col font-sans overflow-hidden relative">
      {renderTopBar()}
      {renderSummaryOverlay()}
      
      <TransitionOverlay 
         isVisible={isTransitioning} 
         stageTitle={transitionContext?.title || ""} 
         extraText={transitionContext?.extraText || ""} 
         onComplete={completeTransition} 
      />

      {/* Middle: 5 Columns */}
      <div className="flex-1 p-2 overflow-hidden min-h-0">
         <div className="h-full grid grid-cols-1 md:grid-cols-5 gap-2">
            {renderRoleColumn('owner', '业主', User, 'border-blue-500')}
            {renderRoleColumn('gov', '政府', Landmark, 'border-green-600')}
            {renderRoleColumn('mdb', '多边开发银行', Globe, 'border-purple-600')}
            {renderRoleColumn('epc', 'EPC承包商', Building2, 'border-orange-500')}
            {renderRoleColumn('ngo', '公众', Users, 'border-red-500')}
         </div>
      </div>

      {/* Bottom: Visuals & Logs - Requirement 1: Reduced Height */}
      <div className="h-40 md:h-44 grid grid-cols-12 gap-2 px-2 pb-2 shrink-0">
        {/* Visual Area */}
        <div className="col-span-4 bg-slate-800 rounded-sm relative overflow-hidden flex flex-col items-center justify-center text-white shadow-inner group border border-slate-600 hidden md:flex">
           {renderScene()}
           
           <div className="z-20 text-center p-2 relative bottom-0 w-full bg-black/40 backdrop-blur-sm mt-auto border-t border-white/10">
             <h3 className="font-bold text-sm flex items-center justify-center gap-2 mb-0.5 text-white drop-shadow-md"><MapPin size={14} className="text-blue-400"/> 
               {stage===1 ? "项目规划与选址 (立项审批)" : stage===2 ? "项目融资 (ESCP签署)" : stage===3 ? "EPC合同谈判" : s4State.includes('crisis') ? "施工现场 (紧急状态)" : (stage===5 || stage===6) ? "验收总结阶段" : "建设现场"}
             </h3>
             <div className="text-[10px] text-slate-200 inline-block">
               {s4State.includes('crisis') ? "⚠️ 警报: 危机处理中" : (stage===5 || stage===6) ? "状态: 验收总结" : "状态: 正常推进"}
             </div>
           </div>
        </div>

        {/* Project Bulletin */}
        <div className="col-span-12 md:col-span-8 bg-white rounded-sm border border-slate-300 shadow-sm flex flex-col overflow-hidden">
           <div className="bg-slate-100 px-3 py-1.5 text-xs font-bold border-b border-slate-200 flex justify-between items-center shrink-0 text-slate-700">
             <div className="flex items-center gap-2"><Megaphone size={14}/> 项目公告栏</div>
             {stage===4 && currentCrisis && <span className="text-red-600 bg-red-50 px-2 py-0.5 rounded border border-red-200 animate-pulse">当前事件: {currentCrisis.title}</span>}
           </div>
           <div className="flex-1 overflow-y-auto p-2 font-mono text-[11px] space-y-1.5" ref={scrollRef}>
              {[...logs].reverse().map((l,i) => (
                <div key={i} className={`border-l-4 pl-2 py-0.5 text-sm rounded-r-sm ${l.type==='red'?'text-red-800 border-red-400 bg-red-50':l.type==='green'?'text-green-800 border-green-400 bg-green-50':l.type==='blue'?'text-blue-800 border-blue-400 bg-blue-50':l.type==='purple'?'text-purple-800 border-purple-400 bg-purple-50':'text-slate-700 border-slate-300 bg-slate-50'}`}>
                  <span className="opacity-60 mr-2 text-xs font-bold text-slate-500">[{l.time}]</span>{l.msg}
                </div>
              ))}
           </div>
        </div>
      </div>
    </div>
  );
}

      		  createRoot(document.getElementById("root")).render(
             <>
      		    <SunLinkESGSimV7_15_LeanCloud />
              </>
      		    );
              window.parent.postMessage({ action: "ready" }, "*");
    </script>
  </body>
</html>