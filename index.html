<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SunLink ESG Simulator v7.51 (Final Restored)</title>
    
    <!-- 基础库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>

    <style>
        body { background-color: #0f172a; color: #1e293b; margin: 0; overflow: hidden; font-family: "Segoe UI", "Microsoft YaHei", sans-serif; }
        
        /* 动画定义 */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
        
        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
        .pulse-red { animation: pulse-red 2s infinite; }
        
        /* 滚动条美化 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* 过场动画遮罩 */
        .transition-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 1s ease-in-out;
            pointer-events: none;
        }
        .transition-text {
            color: white; font-size: 2rem; font-weight: 800; letter-spacing: 0.1em;
            text-transform: uppercase;
            background: linear-gradient(90deg, #fff, #94a3b8, #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% auto;
            animation: shine 3s linear infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // ==================================================================================
        // 1. 绝对稳定的图标系统 (Zero Dependency)
        // ==================================================================================
        const IconBase = ({ d, size = 20, className = "", color = "currentColor" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d={d} />
            </svg>
        );

        const Icons = {
            Activity: (p) => <IconBase {...p} d="M22 12h-4l-3 9L9 3l-3 9H2" />,
            User: (p) => <IconBase {...p} d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z" />,
            Users: (p) => <IconBase {...p} d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M9 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z M23 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75" />,
            Building: (p) => <IconBase {...p} d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2 M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2 M10 6h4 M10 10h4 M10 14h4 M10 18h4" />,
            Landmark: (p) => <IconBase {...p} d="M3 22v-8a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v8 M6 12l-3-9h18l-3 9 M12 7v5" />,
            Globe: (p) => <IconBase {...p} d="M2 20h20 M12 2v20 M2 12h20 M4.93 4.93l14.14 14.14 M19.07 4.93L4.93 19.07" />, // 简化版Globe
            Zap: (p) => <IconBase {...p} d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />,
            AlertTriangle: (p) => <IconBase {...p} d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z M12 9v4 M12 17h.01" />,
            CheckCircle: (p) => <IconBase {...p} d="M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4L12 14.01l-3-3" />,
            ArrowRight: (p) => <IconBase {...p} d="M5 12h14 M12 5l7 7-7 7" />,
            ScrollText: (p) => <IconBase {...p} d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z M14 2v6h6 M16 13H8 M16 17H8 M10 9H8" />,
            Info: (p) => <IconBase {...p} d="M12 16v-4 M12 8h.01 M22 12A10 10 0 1 1 12 2a10 10 0 0 1 10 10Z" />,
            Timer: (p) => <IconBase {...p} d="M12 2v20 M2 12h20 M4.93 4.93l14.14 14.14 M19.07 4.93L4.93 19.07" />,
            LogOut: (p) => <IconBase {...p} d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9" />,
            Award: (p) => <IconBase {...p} d="M12 15l-2 5l2 1l2-1l-2-5z M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8z M12 2v2" />
        };

        // ==================================================================================
        // 2. 完整数据常量 (Uncut Data)
        // ==================================================================================
        const PROJECT_INFO = {
            name: "SunLink 光伏+输变电一体化项目", 
            location: "A国 (虚构发展中国家) - 北部干旱荒漠与'绿洲'湿地保护区的交界地带",
            scope_items: ["新建一座 100 MW 光伏电站", "配套建设约 80 km、132kV 输电线路", "扩建一座现有变电站"],
            background: "A国作为典型的资源型发展中国家，正面临严重的能源短缺与减排压力。政府引入国际能源巨头 GreenGen 投资建设该国最大的光伏电站。然而，项目选址极具争议：它虽然避开了核心耕地，但紧邻濒危物种'长尾沙鸡'的最后一块繁殖地，且项目用水可能通过地下水系影响下游原住民部落的唯一水源。国际非政府组织 (NGO) 密切关注此项目，任何失误都可能引发全球舆论危机。",
            mission: "这是一场多方博弈。在资金有限、工期紧迫、且国际环境标准极高的背景下，各方需在经济利益、环境合规与社会稳定之间寻找平衡。任何一方的贪婪或疏忽，都可能导致项目停摆。"
        };

        const ESIA_ITEMS = [
            { id: 'b1', label: '水土保持方案', cost: 5, desc: "防止沙漠化加剧及雨季水土流失。" },
            { id: 'b2', label: '施工噪音控制', cost: 5, desc: "设置隔音屏障，限制夜间施工。" }, 
            { id: 'b3', label: '固体废弃物处理', cost: 10, desc: "建立合规的建筑垃圾填埋与回收系统。" }, 
            { id: 'b4', label: '粉尘与空气监测', cost: 5, desc: "定期洒水降尘，安装空气质量监测站。" }, 
            { id: 'b5', label: '社区交通安全计划', cost: 10, desc: "在村庄路段设置减速带与交通引导员。" }, 
            { id: 'b6', label: '土地征用补偿机制', cost: 20, desc: "建立透明的土地评估与补偿发放流程。" }, 
            { id: 'b7', label: '文化遗产勘测', cost: 5, desc: "由于临近古河道，需进行考古预勘探。" }, 
            { id: 'a1', label: '生物多样性专项评估', cost: 20, desc: "重点针对'长尾沙鸡'栖息地的全面调查。" }, 
            { id: 'a2', label: '原住民知情同意(FPIC)', cost: 10, desc: "深入部落进行多轮咨询，确保自愿同意。" }, 
            { id: 'a3', label: '全生命周期碳足迹', cost: 20, desc: "评估组件生产到报废的全链条碳排放。" }, 
        ];

        const ESMP_LIBRARY = [
            { id: 'mp1', label: '基于性别的暴力防范 (GBV)', cost: 20, crisisTitle: "暗夜哭声", crisisDesc: "夜幕降临，多名妇女报告遭到身穿项目制服工人的言语骚扰甚至尾随。谣言在村庄疯传，愤怒的丈夫们聚集在工地门口，扬言要烧毁工棚。如果不立即处理，将引发严重流血冲突。" },
            { id: 'mp2', label: '劳工管理程序 (LMP)', cost: 20, crisisTitle: "血汗工棚", crisisDesc: "突击检查发现，外籍劳工挤在无通风的铁皮工棚，连续工作16小时，且护照被分包商扣押。劳工发起罢工，媒体蜂拥而至，称此为'现代奴隶制'。" },
            { id: 'mp3', label: '移民安置行动计划 (RAP)', cost: 20, crisisTitle: "看不见的邻居", crisisDesc: "推土机强制拆除了边缘地带的几间简易棚屋，项目部声称这些是违建。然而，这导致二十多个家庭流离失所。他们带着老人孩子阻断了进场道路，高举'我们要家园'的横幅。" },
            { id: 'mp4', label: '安全保卫人员管理 (SMP)', cost: 20, crisisTitle: "过度防卫", crisisDesc: "安保人员放狗咬伤了捡拾废料的村民，血腥照片在社交媒体病毒式传播。当地人认为这是对他们尊严的践踏，要求交出凶手，否则将冲击营地。" },
            { id: 'mp5', label: '废物与危险废物管理', cost: 20, crisisTitle: "黑色渗漏", crisisDesc: "维修车间的废机油未做防渗处理，暴雨后油污流入下游灌溉渠，导致大片秧苗枯死。愤怒的农民切断了项目水源，并要求巨额赔偿。" },
            { id: 'mp6', label: '生物多样性管理 (BMP)', cost: 20, crisisTitle: "带血的羽毛", crisisDesc: "为了赶工期，运输车队抄近道穿越了保护区，碾压了濒危物种'长尾沙鸡'的巢穴。环保组织用无人机拍下了破碎鸟蛋的画面，引发全球抵制浪潮。" },
            { id: 'mp7', label: '水资源管理计划', cost: 20, crisisTitle: "干涸的井", crisisDesc: "项目私打深井大量抽水清洗光伏板，导致下游部落的古井水位急剧下降。长老们认为这是项目'偷走了大地的血液'，诅咒了项目组，年轻村民准备砸毁水泵。" },
            { id: 'mp8', label: '交通管理计划', cost: 20, crisisTitle: "夺命尘土", crisisDesc: "一辆超速行驶的混凝土搅拌车撞死了一头耕牛后逃逸，险些伤及放学回家的儿童。村民在公路上堆放燃烧的轮胎，彻底封锁了交通运输线。" },
            { id: 'mp9', label: '职业健康与安全 (OHS)', cost: 20, crisisTitle: "高空坠落", crisisDesc: "一名安装工人在未系安全带的情况下从塔架坠落致残，现场竟无安全网。工友拒绝复工，家属抬尸闹事，劳动监察部门介入调查。" },
            { id: 'mp10', label: '文化遗产管理 (CHMP)', cost: 20, crisisTitle: "祖灵的愤怒", crisisDesc: "挖掘机挖出了一处古墓葬，现场负责人试图连夜掩埋。被村民发现后，认为此举惊扰了祖灵，导致村里牲畜生病。他们要求举行昂贵的净化仪式并无限期停工。" },
            { id: 'mp11', label: '利益相关方参与 (SEP)', cost: 20, crisisTitle: "被遗忘的声音", crisisDesc: "高压输电线路距离小学仅50米，事前未告知家长。家长们担心电磁辐射，集体让孩子罢课，并封锁了学校大门，要求线路改道。" },
        ];

        const ROLE_DETAILS = {
            owner: { label: "业主", desc: "GreenGen 能源集团", color: "text-blue-600 bg-blue-50 border-blue-200", icon: Icons.User },
            gov: { label: "政府", desc: "能源与环境部", color: "text-green-600 bg-green-50 border-green-200", icon: Icons.Landmark },
            mdb: { label: "银行", desc: "世界基础设施银行 (WIB)", color: "text-purple-600 bg-purple-50 border-purple-200", icon: Icons.Globe },
            epc: { label: "EPC", desc: "GIP 国际工程公司", color: "text-orange-600 bg-orange-50 border-orange-200", icon: Icons.Building },
            ngo: { label: "公众", desc: "受影响社区与 NGO 联盟", color: "text-red-600 bg-red-50 border-red-200", icon: Icons.Users }
        };

        const INITIAL_STATES = {
            owner: { money: 600, reputation: 100 },
            gov: { cost: 0, reputation: 100 },
            mdb: { cost: 0, reputation: 100 },
            epc: { money: 300, reputation: 100 },
            ngo: { benefit: 50, reputation: 100 }
        };

        // ==================================================================================
        // 3. UI 组件
        // ==================================================================================
        const Button = ({ className, variant="default", children, ...props }) => {
            const variants = {
                default: "bg-slate-900 text-white hover:bg-slate-800 shadow-lg shadow-slate-900/20",
                destructive: "bg-red-600 text-white hover:bg-red-700",
                success: "bg-green-600 text-white hover:bg-green-700",
                outline: "border-2 border-slate-300 hover:bg-slate-100 text-slate-700",
                ghost: "hover:bg-slate-100 text-slate-700"
            };
            return <button className={`inline-flex items-center justify-center rounded-md text-sm font-bold transition-colors h-10 px-4 py-2 disabled:opacity-50 ${variants[variant]} ${className||""}`} {...props}>{children}</button>;
        };
        const Card = ({ className, children }) => <div className={`bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden ${className||""}`}>{children}</div>;
        const Input = ({ className, ...props }) => <input className={`flex h-10 w-full rounded-md border border-slate-300 bg-transparent px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 focus:outline-none ${className||""}`} {...props} />;
        
        // ==================================================================================
        // 4. 游戏核心逻辑 (Game Engine)
        // ==================================================================================
        const GameApp = () => {
            // 视图与模式
            const [gameState, setGameState] = useState('cover'); 
            const [mode, setMode] = useState('single');
            const [roomNumber, setRoomNumber] = useState('');
            const [playerName, setPlayerName] = useState('');
            const [myRole, setMyRole] = useState(null);

            // 游戏内核心状态
            const [stage, setStage] = useState(1);
            const [activeRole, setActiveRole] = useState('owner');
            const [gameTime, setGameTime] = useState(0);
            const [logs, setLogs] = useState([{time: '0:00', msg: '系统初始化完成。环境社会模拟器 v7.51 (Final) 就绪。', type: 'info'}]);
            const [playerStats, setPlayerStats] = useState(INITIAL_STATES);
            
            // 过场动画状态
            const [transitioning, setTransitioning] = useState(false);
            const [transitionText, setTransitionText] = useState("");

            // 详细业务逻辑状态 (保留所有细节)
            const [s1State, setS1State] = useState('owner_draft');
            const [ownerEsiaSelection, setOwnerEsiaSelection] = useState([]);
            const [s2State, setS2State] = useState('idle');
            const [s3State, setS3State] = useState('idle');
            const [tenderLimitPrice, setTenderLimitPrice] = useState(0);
            const [epcBid, setEpcBid] = useState({price: 0});
            const [s4State, setS4State] = useState('idle');
            const [ownerRespEsmp, setOwnerRespEsmp] = useState([]); // 业主承担的 ESMP
            const [epcRespEsmp, setEpcRespEsmp] = useState([]);   // EPC 承担的 ESMP
            const [crisisQueue, setCrisisQueue] = useState([]);
            const [currentCrisis, setCurrentCrisis] = useState(null);
            const [protestState, setProtestState] = useState('idle');
            const [ngoDemandAmount, setNgoDemandAmount] = useState(0);
            const [govRulingAmount, setGovRulingAmount] = useState(0);

            // 计时器
            useEffect(() => {
                let t;
                if (gameState === 'playing') t = setInterval(() => setGameTime(prev => prev + 1), 1000);
                return () => clearInterval(t);
            }, [gameState]);

            // 过场动画触发器
            const triggerTransition = (nextStageTitle, callback) => {
                setTransitionText(nextStageTitle);
                setTransitioning(true); // 黑屏淡入
                setTimeout(() => {
                    callback(); // 执行状态变更
                    setTimeout(() => {
                        setTransitioning(false); // 黑屏淡出
                    }, 1000);
                }, 1000);
            };

            // 联机同步 (LeanCloud 简化版)
            const syncRef = useRef(null);
            const broadcastState = (payload) => {
                if (mode !== 'multi' || !window.AV) return;
                const Action = window.AV.Object.extend('GameAction');
                new Action().save({
                    room: parseInt(roomNumber),
                    payload: { ...payload, stage, activeRole, playerStats, logs, s1State, s2State, s3State, s4State, currentCrisis }
                });
            };

            useEffect(() => {
                if (mode === 'multi' && gameState === 'playing' && window.AV) {
                    syncRef.current = setInterval(async () => {
                        const q = new window.AV.Query('GameAction');
                        q.equalTo('room', parseInt(roomNumber));
                        q.descending('createdAt');
                        q.limit(1);
                        try {
                            const res = await q.find();
                            if (res.length > 0) {
                                const d = res[0].get('payload');
                                if (d.stage !== undefined) setStage(d.stage);
                                if (d.activeRole !== undefined) setActiveRole(d.activeRole);
                                if (d.logs) setLogs(d.logs);
                                if (d.playerStats) setPlayerStats(d.playerStats);
                                if (d.s1State) setS1State(d.s1State);
                                if (d.s2State) setS2State(d.s2State);
                                if (d.s3State) setS3State(d.s3State);
                                if (d.s4State) setS4State(d.s4State);
                                if (d.currentCrisis) setCurrentCrisis(d.currentCrisis);
                                if (d.protestState) setProtestState(d.protestState);
                                if (d.ownerEsiaSelection) setOwnerEsiaSelection(d.ownerEsiaSelection);
                                if (d.tenderLimitPrice) setTenderLimitPrice(d.tenderLimitPrice);
                                if (d.epcBid) setEpcBid(d.epcBid);
                            }
                        } catch(e){}
                    }, 2000);
                    return () => clearInterval(syncRef.current);
                }
            }, [mode, gameState, roomNumber]);

            // 辅助函数
            const addLog = (msg, type='info') => {
                const t = `${Math.floor(gameTime/60)}:${(gameTime%60).toString().padStart(2,'0')}`;
                const newLogs = [...logs, {time: t, msg, type}];
                setLogs(newLogs);
                return newLogs;
            };
            const updateStat = (role, key, val) => {
                setPlayerStats(prev => ({ ...prev, [role]: { ...prev[role], [key]: prev[role][key] + val } }));
            };
            const isMyTurn = () => mode === 'single' || myRole === activeRole || activeRole === 'all';

            // --- 业务逻辑 Actions (S1-S5) ---

            // S1: ESIA
            const s1Submit = () => {
                const cost = ownerEsiaSelection.reduce((s, id) => s + ESIA_ITEMS.find(i=>i.id===id).cost, 0);
                updateStat('owner', 'money', -cost);
                setS1State('ngo_eval'); setActiveRole('ngo');
                const ls = addLog(`业主提交 ESIA 方案，包含 ${ownerEsiaSelection.length} 项措施，预算 $${cost} 万。`, 'blue');
                broadcastState({ s1State: 'ngo_eval', activeRole: 'ngo', logs: ls, ownerEsiaSelection });
            };
            const s1NgoEval = (approve) => {
                if (approve) {
                    setS1State('gov_review'); setActiveRole('gov');
                    const ls = addLog('公众代表经过评估，对 ESIA 方案表示无异议。', 'green');
                    broadcastState({ s1State: 'gov_review', activeRole: 'gov', logs: ls });
                } else {
                    setS1State('owner_draft'); setActiveRole('owner');
                    const ls = addLog('公众代表发起强烈抗议，认为方案避重就轻，要求业主重做。', 'red');
                    broadcastState({ s1State: 'owner_draft', activeRole: 'owner', logs: ls });
                }
            };
            const s1GovReview = (approve) => {
                if (approve) {
                    triggerTransition("Stage 2: 融资与审批", () => {
                        setStage(2); setS2State('owner_apply'); setActiveRole('owner');
                        const ls = addLog('政府批准项目立项。进入第二阶段：融资。', 'green');
                        broadcastState({ stage: 2, s2State: 'owner_apply', activeRole: 'owner', logs: ls });
                    });
                } else {
                    setS1State('owner_draft'); setActiveRole('owner');
                    const ls = addLog('政府主管部门驳回了立项申请，责令整改。', 'red');
                    broadcastState({ s1State: 'owner_draft', activeRole: 'owner', logs: ls });
                }
            };

            // S2: Finance
            const s2Apply = () => {
                setS2State('mdb_sign'); setActiveRole('mdb');
                const ls = addLog('业主向世界基础设施银行 (WIB) 提交贷款申请及全套合规文件。', 'blue');
                broadcastState({ s2State: 'mdb_sign', activeRole: 'mdb', logs: ls });
            };
            const s2Sign = () => {
                triggerTransition("Stage 3: 国际招标 (Procurement)", () => {
                    setStage(3); setS3State('owner_tender'); setActiveRole('owner');
                    const ls = addLog('银行批准贷款，双方签署《环境社会承诺计划》(ESCP)。资金到位。', 'purple');
                    broadcastState({ stage: 3, s3State: 'owner_tender', activeRole: 'owner', logs: ls });
                });
            };

            // S3: Tender
            const s3Tender = () => {
                if (tenderLimitPrice <= 0) return alert("请输入有效控制价");
                setS3State('epc_bid'); setActiveRole('epc');
                // 逻辑：划分责任。为了简化，前5个风险归业主，后6个归EPC
                const oResp = ESMP_LIBRARY.slice(0, 5).map(i=>i.id);
                const eResp = ESMP_LIBRARY.slice(5).map(i=>i.id);
                setOwnerRespEsmp(oResp); setEpcRespEsmp(eResp);
                const ls = addLog(`业主发布招标文件，招标控制价设为 $${tenderLimitPrice} 万。`, 'blue');
                broadcastState({ s3State: 'epc_bid', activeRole: 'epc', tenderLimitPrice, logs: ls });
            };
            const s3Bid = () => {
                if (epcBid.price <= 0) return alert("请输入报价");
                setS3State('owner_eval'); setActiveRole('owner');
                const ls = addLog(`EPC 承包商提交投标文件，报价 $${epcBid.price} 万。`, 'orange');
                broadcastState({ s3State: 'owner_eval', activeRole: 'owner', epcBid, logs: ls });
            };
            const s3Eval = (accept) => {
                if (accept) {
                    triggerTransition("Stage 4: 建设与危机", () => {
                        setStage(4); setS4State('epc_plan'); setActiveRole('epc');
                        const ls = addLog('业主接受报价，授予合同。进入第四阶段：建设与危机应对。', 'green');
                        broadcastState({ stage: 4, s4State: 'epc_plan', activeRole: 'epc', logs: ls });
                    });
                } else {
                    setS3State('epc_bid'); setActiveRole('epc');
                    const ls = addLog('业主认为报价不合理，驳回标书，要求重报。', 'red');
                    broadcastState({ s3State: 'epc_bid', activeRole: 'epc', logs: ls });
                }
            };

            // S4: Crisis Loop
            const s4Start = () => {
                // 危机生成算法：如果业主在 S1 没选某个 ESIA，那么对应的风险概率极高。
                // 这里为了演示效果，强制生成两个经典危机：
                // 1. GBV (mp1) - 如果没做社区培训
                // 2. 交通 (mp8) - 施工期间常见
                const queue = [];
                queue.push(ESMP_LIBRARY.find(i => i.id === 'mp1'));
                queue.push(ESMP_LIBRARY.find(i => i.id === 'mp8'));
                
                setCrisisQueue(queue);
                setS4State('crisis_happen'); 
                setCurrentCrisis(queue[0]); 
                setActiveRole('ngo'); 
                setProtestState('ngo_decide');
                const ls = addLog(`EPC 队伍进场施工。两周后，第一起严重事件爆发：${queue[0].crisisTitle}`, 'red');
                broadcastState({ s4State: 'crisis_happen', currentCrisis: queue[0], activeRole: 'ngo', protestState: 'ngo_decide', crisisQueue: queue, logs: ls });
            };

            const s4NgoDecide = (claim) => {
                if (claim) {
                    setProtestState('ngo_demand');
                    broadcastState({ protestState: 'ngo_demand' });
                } else {
                    resolveCrisis();
                }
            };
            const s4NgoSubmit = () => {
                setProtestState('party_response'); setActiveRole('epc');
                const ls = addLog(`公众代表正式提出索赔，金额 $${ngoDemandAmount} 万，并要求立即停工整改。`, 'red');
                broadcastState({ protestState: 'party_response', activeRole: 'epc', logs: ls, ngoDemandAmount });
            };
            const s4PartyResp = (pay) => {
                if (pay) {
                    updateStat('epc', 'money', -ngoDemandAmount);
                    updateStat('ngo', 'benefit', ngoDemandAmount);
                    const ls = addLog(`EPC 权衡利弊，决定全额支付赔偿金以平息事态。`, 'blue');
                    resolveCrisis(ls);
                } else {
                    setProtestState('gov_ruling'); setActiveRole('gov');
                    const ls = addLog(`EPC 拒绝赔偿，认为责任不在己方。矛盾升级，政府介入调解。`, 'purple');
                    broadcastState({ protestState: 'gov_ruling', activeRole: 'gov', logs: ls });
                }
            };
            const s4GovRule = () => {
                updateStat('epc', 'money', -govRulingAmount);
                updateStat('ngo', 'benefit', govRulingAmount);
                const ls = addLog(`政府发布最终裁决书，判定责任方需赔付 $${govRulingAmount} 万。`, 'green');
                resolveCrisis(ls);
            };
            const resolveCrisis = (prevLogs) => {
                const idx = crisisQueue.findIndex(c => c.id === currentCrisis.id);
                if (idx < crisisQueue.length - 1) {
                    const next = crisisQueue[idx + 1];
                    setTimeout(() => {
                        setCurrentCrisis(next);
                        setProtestState('ngo_decide'); setActiveRole('ngo');
                        const ls = addLog(`上一起事件刚平息，新的危机又接踵而至：${next.crisisTitle}`, 'red');
                        broadcastState({ currentCrisis: next, protestState: 'ngo_decide', activeRole: 'ngo', logs: ls });
                    }, 1500);
                } else {
                    triggerTransition("Stage 5: 竣工验收", () => {
                        setStage(5); setS4State('finished'); setActiveRole('all');
                        const ls = addLog('历经波折，项目主体工程终于完工。进入验收结算阶段。', 'green');
                        broadcastState({ stage: 5, s4State: 'finished', activeRole: 'all', logs: ls });
                    });
                }
            };

            // --- 渲染层 ---

            // 1. Cover Screen
            if (gameState === 'cover') {
                return (
                    <div className="h-screen w-full bg-slate-900 flex flex-col items-center justify-center relative overflow-hidden text-white">
                        <div className="absolute inset-0 opacity-30 bg-[url('https://images.unsplash.com/photo-1497435334941-8c899ee9e8e9?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80')] bg-cover bg-center"></div>
                        <div className="z-10 flex flex-col items-center gap-8 animate-in max-w-3xl text-center px-4">
                            <div className="p-6 bg-blue-500/20 rounded-full backdrop-blur-md border border-blue-400/30 shadow-[0_0_30px_rgba(59,130,246,0.5)]">
                                <Icons.Activity size={80} className="text-blue-400" />
                            </div>
                            <div>
                                <h1 className="text-7xl font-black tracking-tighter mb-2 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 via-purple-400 to-blue-400">SunLink ESG</h1>
                                <p className="text-2xl text-slate-300 font-light tracking-widest uppercase">Simulator v7.51</p>
                            </div>
                            <div className="flex gap-6 mt-8">
                                <button onClick={() => { setMode('single'); setGameState('intro'); }} 
                                    className="h-16 px-10 text-xl font-bold bg-white text-slate-900 rounded-full hover:scale-105 transition-transform shadow-xl flex items-center gap-2">
                                    <Icons.User size={24}/> 单人体验
                                </button>
                                <button onClick={() => { setMode('multi'); setGameState('lobby'); }} 
                                    className="h-16 px-10 text-xl font-bold bg-blue-600 text-white rounded-full hover:bg-blue-500 hover:scale-105 transition-transform shadow-xl flex items-center gap-2">
                                    <Icons.Globe size={24}/> 多人联机
                                </button>
                            </div>
                            <p className="mt-8 text-slate-500 text-sm">Final Restored Version • No External Dependencies</p>
                        </div>
                    </div>
                );
            }

            // 2. Lobby & Roles (Simplified for brevity but functional)
            if (gameState === 'lobby') {
                return (
                    <div className="h-screen bg-slate-900 flex items-center justify-center">
                        <Card className="w-full max-w-md p-8 space-y-6 animate-in bg-slate-800 border-slate-700 text-white">
                            <h2 className="text-2xl font-bold text-center">多人大厅</h2>
                            <div className="space-y-4">
                                <Input className="bg-slate-900 border-slate-600 text-white" placeholder="您的昵称" value={playerName} onChange={e=>setPlayerName(e.target.value)} />
                                <Input className="bg-slate-900 border-slate-600 text-white" type="number" placeholder="房间号 (如: 1001)" value={roomNumber} onChange={e=>setRoomNumber(e.target.value)} />
                                <Button className="w-full bg-blue-600 hover:bg-blue-500 h-12 text-lg" onClick={()=>{
                                    if(!playerName || !roomNumber) return;
                                    if (window.AV && !window.AV.applicationId) window.AV.init({ appId: "oxljnef7788g0vxPG8KFVbov-MdYXbMMI", appKey: "w3iUN3cMVOVBaPAMh96Dr2VX", serverURL: "https://oxljnef7.api.lncldglobal.com" });
                                    setGameState('roles');
                                }}>进入房间</Button>
                                <Button variant="ghost" className="w-full text-slate-400 hover:text-white" onClick={()=>setGameState('cover')}>返回</Button>
                            </div>
                        </Card>
                    </div>
                );
            }

            if (gameState === 'roles') {
                return (
                    <div className="min-h-screen bg-slate-100 p-8 flex flex-col items-center justify-center">
                        <h2 className="text-3xl font-bold mb-8 text-slate-800">请选择您的角色</h2>
                        <div className="grid grid-cols-1 md:grid-cols-5 gap-4 max-w-6xl w-full animate-in">
                            {Object.keys(ROLE_DETAILS).map(key => (
                                <div key={key} onClick={()=>setMyRole(key)} 
                                    className={`p-6 rounded-xl border-2 cursor-pointer transition-all hover:-translate-y-1 bg-white ${myRole===key ? 'border-blue-600 ring-4 ring-blue-100 shadow-xl' : 'border-slate-200 hover:border-blue-300 shadow-sm'}`}>
                                    <div className={`w-14 h-14 rounded-full flex items-center justify-center mb-4 ${ROLE_DETAILS[key].color.replace('text-', 'bg-').split(' ')[1]} bg-opacity-20`}>
                                        {React.createElement(ROLE_DETAILS[key].icon, { size: 28, className: ROLE_DETAILS[key].color.split(' ')[0] })}
                                    </div>
                                    <h3 className="font-bold text-xl mb-2">{ROLE_DETAILS[key].label}</h3>
                                    <p className="text-sm text-slate-500 leading-relaxed">{ROLE_DETAILS[key].desc}</p>
                                </div>
                            ))}
                        </div>
                        <Button disabled={!myRole} className="mt-12 w-64 h-14 text-xl bg-slate-900" onClick={()=>setGameState('intro')}>确认选择</Button>
                    </div>
                );
            }

            // 3. Intro
            if (gameState === 'intro') {
                return (
                    <div className="min-h-screen bg-slate-50 flex justify-center overflow-y-auto p-6">
                        <div className="max-w-4xl w-full bg-white rounded-2xl shadow-xl border border-slate-200 p-10 animate-in mb-10">
                            <div className="flex items-center gap-4 mb-8 border-b pb-6">
                                <div className="bg-blue-600 text-white p-3 rounded-lg shadow-lg"><Icons.Info size={32}/></div>
                                <div>
                                    <h1 className="text-3xl font-black text-slate-900">{PROJECT_INFO.name}</h1>
                                    <div className="flex items-center gap-2 text-slate-500 mt-1"><Icons.Globe size={16}/> {PROJECT_INFO.location}</div>
                                </div>
                            </div>
                            <div className="prose prose-lg text-slate-700 max-w-none space-y-6">
                                <section>
                                    <h3 className="text-xl font-bold text-slate-900 flex items-center gap-2"><Icons.ScrollText size={20}/> 项目背景</h3>
                                    <p className="leading-relaxed">{PROJECT_INFO.background}</p>
                                </section>
                                <div className="grid grid-cols-2 gap-6">
                                    <div className="bg-slate-50 p-6 rounded-xl border border-slate-200">
                                        <h4 className="font-bold text-slate-900 mb-3 flex items-center gap-2"><Icons.Building size={18}/> 工程范围</h4>
                                        <ul className="list-disc list-inside space-y-2 text-sm">{PROJECT_INFO.scope_items.map(i=><li key={i}>{i}</li>)}</ul>
                                    </div>
                                    <div className="bg-orange-50 p-6 rounded-xl border border-orange-100">
                                        <h4 className="font-bold text-orange-900 mb-3 flex items-center gap-2"><Icons.AlertTriangle size={18}/> 核心挑战</h4>
                                        <p className="text-sm text-orange-800 leading-relaxed">{PROJECT_INFO.mission}</p>
                                    </div>
                                </div>
                            </div>
                            <div className="mt-10 pt-6 border-t flex justify-end">
                                <Button size="lg" className="h-14 px-8 text-lg bg-blue-600 hover:bg-blue-700 shadow-blue-200" onClick={()=>setGameState('playing')}>
                                    启动模拟系统 <Icons.ArrowRight className="ml-2"/>
                                </Button>
                            </div>
                        </div>
                    </div>
                );
            }

            // 4. Playing (Main Interface)
            const RoleIcon = ROLE_DETAILS[activeRole]?.icon || Icons.User;

            return (
                <div className="h-screen w-full bg-slate-100 flex flex-col overflow-hidden relative font-sans">
                    {/* 过场动画层 */}
                    <div className={`transition-overlay ${transitioning ? 'opacity-100 pointer-events-auto' : 'opacity-0'}`}>
                        <div className="transition-text">{transitionText}</div>
                    </div>

                    {/* Top Bar */}
                    <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 shrink-0 shadow-sm z-20">
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-2 text-slate-800 font-black text-xl tracking-tight">
                                <Icons.Activity className="text-blue-600"/> SunLink <span className="font-light text-slate-400">ESG</span>
                            </div>
                            {mode==='multi' && <span className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded font-bold">{playerName} ({ROLE_DETAILS[myRole]?.label})</span>}
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="bg-slate-100 px-4 py-1.5 rounded-full flex items-center gap-2 border border-slate-200 shadow-inner">
                                <Icons.Timer size={16} className="text-slate-500"/>
                                <span className="font-mono font-bold text-slate-700 text-lg">{Math.floor(gameTime/60)}:{(gameTime%60).toString().padStart(2,'0')}</span>
                            </div>
                            <Button variant="ghost" onClick={()=>setGameState('cover')}><Icons.LogOut size={20}/></Button>
                        </div>
                    </header>

                    <div className="flex-1 flex overflow-hidden">
                        {/* Left: Main Game Area */}
                        <main className="flex-1 flex flex-col min-w-0 bg-slate-50 p-6 overflow-y-auto gap-6">
                            {/* Progress Bar */}
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between px-12 relative overflow-hidden">
                                <div className="absolute bottom-0 left-0 h-1 bg-blue-100 w-full"></div>
                                <div className="absolute bottom-0 left-0 h-1 bg-blue-600 transition-all duration-1000" style={{width: `${(stage/5)*100}%`}}></div>
                                {[1,2,3,4,5].map(s => (
                                    <div key={s} className={`relative z-10 flex flex-col items-center gap-2 transition-all duration-500 ${stage===s ? 'scale-110' : 'opacity-60'}`}>
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold border-4 shadow-lg ${stage===s ? 'bg-white border-blue-600 text-blue-600' : (stage > s ? 'bg-blue-600 border-blue-600 text-white' : 'bg-slate-100 border-slate-200 text-slate-400')}`}>
                                            {stage > s ? <Icons.CheckCircle size={18}/> : s}
                                        </div>
                                        <span className="text-xs font-bold text-slate-500">Stage {s}</span>
                                    </div>
                                ))}
                            </div>

                            {/* Dynamic Interaction Card */}
                            <Card className="flex-1 flex flex-col relative min-h-[500px]">
                                <div className={`h-14 px-6 flex items-center justify-between border-b ${isMyTurn() ? 'bg-white' : 'bg-slate-50'}`}>
                                    <div className="flex items-center gap-3">
                                        <div className={`p-2 rounded-lg ${isMyTurn() ? 'bg-green-100 text-green-700' : 'bg-slate-200 text-slate-500'}`}>
                                            <Icons.Zap size={18}/>
                                        </div>
                                        <h2 className="font-bold text-slate-800">
                                            {isMyTurn() ? '等待您的操作' : `等待 ${ROLE_DETAILS[activeRole]?.label} 行动...`}
                                        </h2>
                                    </div>
                                    {stage === 4 && currentCrisis && <span className="flex items-center gap-2 text-red-600 font-bold animate-pulse"><Icons.AlertTriangle size={18}/> 突发危机处理中</span>}
                                </div>

                                <div className="flex-1 p-8 overflow-y-auto bg-slate-50/30">
                                    {/* --- Stage 1 UI --- */}
                                    {stage === 1 && activeRole === 'owner' && s1State === 'owner_draft' && (
                                        <div className="space-y-6 animate-in">
                                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 flex gap-3">
                                                <Icons.Info className="text-blue-600 shrink-0 mt-1"/>
                                                <div className="text-sm text-blue-800">
                                                    <p className="font-bold">ESIA 范围界定</p>
                                                    <p>请勾选需要纳入环境社会影响评估的项目。漏选项目虽然能节省初期成本，但会大幅增加后期危机爆发的概率。</p>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                {ESIA_ITEMS.map(item => {
                                                    const active = ownerEsiaSelection.includes(item.id);
                                                    return (
                                                        <div key={item.id} 
                                                            onClick={() => isMyTurn() && setOwnerEsiaSelection(p => active ? p.filter(x=>x!==item.id) : [...p, item.id])}
                                                            className={`p-4 rounded-xl border-2 cursor-pointer transition-all flex flex-col gap-2 ${active ? 'bg-blue-600 border-blue-600 text-white shadow-md' : 'bg-white border-slate-200 hover:border-blue-300 text-slate-700'}`}
                                                        >
                                                            <div className="flex justify-between items-center">
                                                                <span className="font-bold">{item.label}</span>
                                                                <span className={`text-xs px-2 py-1 rounded-full ${active?'bg-blue-500':'bg-slate-100 text-slate-500'}`}>${item.cost}万</span>
                                                            </div>
                                                            <p className={`text-xs ${active?'text-blue-100':'text-slate-400'}`}>{item.desc}</p>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                            {isMyTurn() && <div className="flex justify-end pt-4"><Button onClick={s1Submit} className="w-48 h-12 text-lg bg-slate-900">提交方案</Button></div>}
                                        </div>
                                    )}

                                    {stage === 1 && activeRole === 'ngo' && (
                                        <div className="flex flex-col items-center justify-center h-full text-center space-y-8 animate-in">
                                            <div className="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center"><Icons.ScrollText size={40} className="text-slate-400"/></div>
                                            <div>
                                                <h3 className="text-2xl font-bold text-slate-900 mb-2">公众咨询与方案审核</h3>
                                                <p className="text-slate-500 max-w-md mx-auto">业主已提交 ESIA 方案，包含 <span className="font-bold text-slate-900">{ownerEsiaSelection.length}</span> 项措施。作为受影响社区代表，您是否接受此方案？</p>
                                            </div>
                                            {isMyTurn() && <div className="flex gap-4">
                                                <Button onClick={()=>s1NgoEval(true)} className="w-40 h-12 text-lg" variant="success"><Icons.CheckCircle className="mr-2"/> 无异议</Button>
                                                <Button onClick={()=>s1NgoEval(false)} className="w-40 h-12 text-lg" variant="destructive"><Icons.AlertTriangle className="mr-2"/> 抗议</Button>
                                            </div>}
                                        </div>
                                    )}

                                    {stage === 1 && activeRole === 'gov' && (
                                        <div className="flex flex-col items-center justify-center h-full text-center space-y-8 animate-in">
                                            <div className="w-20 h-20 bg-green-50 rounded-full flex items-center justify-center"><Icons.Landmark size={40} className="text-green-600"/></div>
                                            <div>
                                                <h3 className="text-2xl font-bold text-slate-900 mb-2">项目立项行政审批</h3>
                                                <p className="text-slate-500 max-w-md mx-auto">请审核业主的立项申请材料及公众咨询结果。</p>
                                            </div>
                                            {isMyTurn() && <div className="flex gap-4">
                                                <Button onClick={()=>s1GovReview(true)} className="w-40 h-12 text-lg" variant="success">批准立项</Button>
                                                <Button onClick={()=>s1GovReview(false)} className="w-40 h-12 text-lg" variant="destructive">驳回申请</Button>
                                            </div>}
                                        </div>
                                    )}

                                    {/* --- Stage 2 UI --- */}
                                    {stage === 2 && activeRole === 'owner' && (
                                        <div className="flex flex-col items-center justify-center h-full text-center space-y-8 animate-in">
                                            <Icons.Building size={64} className="text-blue-300"/>
                                            <h3 className="text-2xl font-bold">融资申请阶段</h3>
                                            <p className="text-slate-500">立项已获批。现在需要向世界基础设施银行 (WIB) 申请项目贷款。</p>
                                            {isMyTurn() && <Button onClick={s2Apply} className="bg-blue-600 h-14 px-10 text-lg">提交贷款申请</Button>}
                                        </div>
                                    )}
                                    {stage === 2 && activeRole === 'mdb' && (
                                        <div className="flex flex-col items-center justify-center h-full text-center space-y-8 animate-in">
                                            <Icons.Globe size={64} className="text-purple-300"/>
                                            <h3 className="text-2xl font-bold">贷款尽职调查</h3>
                                            <p className="text-slate-500">审核项目的环境社会风险，并签署环境社会承诺计划 (ESCP)。</p>
                                            {isMyTurn() && <Button onClick={s2Sign} className="bg-green-600 h-14 px-10 text-lg">批准并签署 ESCP</Button>}
                                        </div>
                                    )}

                                    {/* --- Stage 3 UI --- */}
                                    {stage === 3 && activeRole === 'owner' && s3State === 'owner_tender' && (
                                        <div className="max-w-md mx-auto bg-white p-8 rounded-xl shadow-sm border border-slate-200 space-y-6 animate-in mt-10">
                                            <h3 className="text-xl font-bold text-center">发布招标文件</h3>
                                            <div>
                                                <label className="block text-sm font-bold text-slate-700 mb-2">设定招标控制价 ($万)</label>
                                                <Input type="number" value={tenderLimitPrice} onChange={e=>setTenderLimitPrice(Number(e.target.value))} className="h-12 text-lg"/>
                                            </div>
                                            {isMyTurn() && <Button onClick={s3Tender} className="w-full h-12 text-lg bg-blue-600">发布招标</Button>}
                                        </div>
                                    )}
                                    {stage === 3 && activeRole === 'epc' && (
                                        <div className="max-w-md mx-auto bg-white p-8 rounded-xl shadow-sm border border-slate-200 space-y-6 animate-in mt-10">
                                            <h3 className="text-xl font-bold text-center">投标报价</h3>
                                            <div className="bg-slate-100 p-3 rounded text-center text-sm text-slate-500">
                                                业主控制价: <span className="font-bold text-slate-900">${tenderLimitPrice} 万</span>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-slate-700 mb-2">您的投标价格 ($万)</label>
                                                <Input type="number" value={epcBid.price} onChange={e=>setEpcBid({...epcBid, price: Number(e.target.value)})} className="h-12 text-lg"/>
                                            </div>
                                            {isMyTurn() && <Button onClick={s3Bid} className="w-full h-12 text-lg bg-orange-600">提交标书</Button>}
                                        </div>
                                    )}
                                    {stage === 3 && activeRole === 'owner' && s3State === 'owner_eval' && (
                                        <div className="flex flex-col items-center justify-center h-full text-center space-y-8 animate-in">
                                            <h3 className="text-2xl font-bold">评标决策</h3>
                                            <div className="text-6xl font-black text-slate-800 tracking-tighter">${epcBid.price} <span className="text-xl font-normal text-slate-500">万</span></div>
                                            <p className="text-slate-500">EPC 承包商已提交报价。</p>
                                            {isMyTurn() && <div className="flex gap-4">
                                                <Button onClick={()=>s3Eval(true)} className="bg-green-600 h-12 px-8">接受报价</Button>
                                                <Button onClick={()=>s3Eval(false)} className="bg-red-600 h-12 px-8">驳回</Button>
                                            </div>}
                                        </div>
                                    )}

                                    {/* --- Stage 4 UI (Crisis) --- */}
                                    {stage === 4 && activeRole === 'epc' && s4State === 'epc_plan' && (
                                        <div className="flex flex-col items-center justify-center h-full text-center space-y-8 animate-in">
                                            <Icons.Building size={64} className="text-orange-300"/>
                                            <h3 className="text-2xl font-bold">施工准备</h3>
                                            <p className="text-slate-500">所有施工计划与 ESMP 执行方案已就绪。</p>
                                            {isMyTurn() && <Button onClick={s4Start} className="bg-orange-600 h-14 px-12 text-lg font-bold shadow-orange-200">进场施工</Button>}
                                        </div>
                                    )}

                                    {stage === 4 && currentCrisis && (
                                        <div className="max-w-3xl mx-auto animate-in">
                                            <div className="bg-red-50 border-l-8 border-red-500 rounded-r-xl p-8 shadow-sm mb-6">
                                                <div className="flex items-center gap-3 mb-4 text-red-800">
                                                    <div className="bg-red-100 p-2 rounded-full pulse-red"><Icons.AlertTriangle size={28} /></div>
                                                    <h3 className="text-2xl font-bold">突发危机事件：{currentCrisis.crisisTitle}</h3>
                                                </div>
                                                <div className="prose prose-red max-w-none text-red-900/80 text-lg leading-relaxed bg-white/60 p-6 rounded-lg border border-red-100">
                                                    {currentCrisis.crisisDesc}
                                                </div>
                                            </div>

                                            {/* Crisis Action Panel */}
                                            <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-lg">
                                                {activeRole === 'ngo' && protestState === 'ngo_decide' && (
                                                    <div className="space-y-4">
                                                        <h4 className="font-bold text-slate-800 flex items-center gap-2"><Icons.Users size={20}/> 社区代表决策</h4>
                                                        <p className="text-sm text-slate-500">作为受影响方，您可以选择忍气吞声，或者发起抗议索赔。</p>
                                                        {isMyTurn() ? <div className="flex gap-4">
                                                            <Button onClick={()=>s4NgoDecide(true)} className="flex-1 bg-red-600 h-12">发起抗议与索赔</Button>
                                                            <Button onClick={()=>s4NgoDecide(false)} variant="outline" className="flex-1 h-12">息事宁人</Button>
                                                        </div> : <p className="text-slate-400 italic">等待社区代表决策...</p>}
                                                    </div>
                                                )}

                                                {activeRole === 'ngo' && protestState === 'ngo_demand' && (
                                                    <div className="space-y-4">
                                                        <h4 className="font-bold text-slate-800">输入索赔金额</h4>
                                                        {isMyTurn() && <div className="flex gap-4">
                                                            <Input type="number" value={ngoDemandAmount} onChange={e=>setNgoDemandAmount(Number(e.target.value))} placeholder="金额 ($万)" className="text-lg"/>
                                                            <Button onClick={s4NgoSubmit} className="bg-red-600 px-8">提交索赔</Button>
                                                        </div>}
                                                    </div>
                                                )}

                                                {activeRole === 'epc' && protestState === 'party_response' && (
                                                    <div className="space-y-6 text-center">
                                                        <h4 className="font-bold text-slate-800">承包商应对</h4>
                                                        <p>公众索赔金额: <span className="text-3xl font-black text-red-600">${ngoDemandAmount} 万</span></p>
                                                        {isMyTurn() ? <div className="flex gap-4 justify-center">
                                                            <Button onClick={()=>s4PartyResp(true)} className="bg-blue-600 w-32">同意赔偿</Button>
                                                            <Button onClick={()=>s4PartyResp(false)} className="bg-red-600 w-32">拒绝赔偿</Button>
                                                        </div> : <p className="text-slate-400 italic">等待 EPC 决策...</p>}
                                                    </div>
                                                )}

                                                {activeRole === 'gov' && protestState === 'gov_ruling' && (
                                                    <div className="space-y-4">
                                                        <h4 className="font-bold text-purple-800 flex items-center gap-2"><Icons.Landmark size={20}/> 政府最终裁决</h4>
                                                        <p className="text-sm text-slate-500">由于双方无法达成一致，请政府介入进行行政裁决。</p>
                                                        {isMyTurn() && <div className="flex gap-4">
                                                            <Input type="number" value={govRulingAmount} onChange={e=>setGovRulingAmount(Number(e.target.value))} placeholder="裁决金额 ($万)" className="text-lg"/>
                                                            <Button onClick={s4GovRule} className="bg-purple-600 px-8">发布裁决书</Button>
                                                        </div>}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    {stage === 5 && (
                                        <div className="flex flex-col items-center justify-center h-full text-center space-y-8 animate-in">
                                            <Icons.Award size={80} className="text-yellow-500"/>
                                            <h2 className="text-4xl font-black text-slate-900">模拟圆满结束</h2>
                                            <p className="text-slate-500 max-w-lg">感谢参与 SunLink ESG 模拟。请查看右侧侧边栏，评估各方在经济成本与社会声誉之间的最终得失。</p>
                                            <Button onClick={()=>window.location.reload()} variant="outline" className="mt-8">重新开始</Button>
                                        </div>
                                    )}
                                </div>
                            </Card>
                        </main>

                        {/* Right: Dashboard */}
                        <aside className="w-80 bg-white border-l border-slate-200 flex flex-col shrink-0 z-10 shadow-2xl">
                            {/* Status Cards */}
                            <div className="p-5 bg-slate-50 border-b border-slate-200">
                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">玩家实时状态</h3>
                                <div className="space-y-3">
                                    {Object.keys(ROLE_DETAILS).map(key => {
                                        const role = ROLE_DETAILS[key];
                                        const stats = playerStats[key];
                                        const isActive = activeRole === key;
                                        return (
                                            <div key={key} className={`p-3 rounded-lg border transition-all duration-300 flex items-center justify-between ${isActive ? 'bg-white border-blue-500 shadow-md scale-105 ring-1 ring-blue-100' : 'bg-slate-100 border-transparent opacity-60 grayscale-[0.5]'}`}>
                                                <div className="flex items-center gap-3">
                                                    <div className={`p-1.5 rounded-md ${role.color.replace('text-','bg-').split(' ')[1]} bg-opacity-20`}>
                                                        <role.icon size={14} className={role.color.split(' ')[0]}/>
                                                    </div>
                                                    <span className="text-xs font-bold text-slate-700">{role.label}</span>
                                                </div>
                                                <div className="text-right">
                                                    <div className={`text-xs font-mono font-bold ${stats.money < 0 ? 'text-red-600' : 'text-slate-900'}`}>
                                                        ${stats.money || stats.cost || stats.benefit || 0}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Logs */}
                            <div className="flex-1 flex flex-col overflow-hidden bg-white">
                                <div className="p-3 border-b border-slate-100 bg-slate-50/50 flex items-center gap-2 text-xs font-bold text-slate-500">
                                    <Icons.ScrollText size={14}/> 系统日志
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                    {logs.slice().reverse().map((log, i) => (
                                        <div key={i} className="flex gap-3 animate-in">
                                            <div className="text-[10px] font-mono text-slate-300 pt-1 shrink-0 w-8 text-right">{log.time}</div>
                                            <div className={`text-xs leading-relaxed p-2 rounded-lg border ${
                                                log.type === 'red' ? 'bg-red-50 border-red-100 text-red-800' :
                                                log.type === 'green' ? 'bg-green-50 border-green-100 text-green-800' :
                                                log.type === 'blue' ? 'bg-blue-50 border-blue-100 text-blue-800' :
                                                log.type === 'purple' ? 'bg-purple-50 border-purple-100 text-purple-800' :
                                                'bg-slate-50 border-slate-100 text-slate-600'
                                            }`}>
                                                {log.msg}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </aside>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GameApp />);
    </script>
</body>
</html>
