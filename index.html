<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SunLink ESG Simulator v7.51 (Fixed & Restored)</title>
    
    <!-- 核心依赖 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>

    <style>
        body { background-color: #0f172a; color: #1e293b; margin: 0; overflow: hidden; font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        /* 动画定义 */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
        
        /* 滚动条 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* 玻璃拟态 */
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==================================================================================
        // 1. 核心修复：内置稳健的图标系统 (彻底解决 Object 报错)
        // ==================================================================================
        const createIcon = (path) => ({ size = 24, className = "", ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d={path} />
            </svg>
        );

        const Icons = {
            Activity: createIcon("M22 12h-4l-3 9L9 3l-3 9H2"),
            User: createIcon("M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2 M12 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z"),
            Users: createIcon("M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M9 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z M22 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75"),
            Building2: createIcon("M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2 M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2 M10 6h4 M10 10h4 M10 14h4 M10 18h4"),
            Landmark: createIcon("M3 22v-8a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v8 M6 12l-3-9h18l-3 9 M12 7v5"),
            Globe: createIcon("M21.54 15H17a2 2 0 0 0-2 2v4.54 M7 3.34V5a3 3 0 0 0 3 3a2 2 0 0 1 2 2c0 1.1.9 2 2 2a2 2 0 0 0 2-2c0-1.1.9-2 2-2h3.17 M11 21.95V18a2 2 0 0 0-2-2a2 2 0 0 1-2-2v-1a2 2 0 0 0-2-2H2.05 M21.5 12a9.5 9.5 0 1 1-19 0 9.5 9.5 0 0 1 19 0Z"),
            Zap: createIcon("M13 2L3 14h9l-1 8 10-12h-9l1-8z"),
            Timer: createIcon("M10 2h4 M12 14v-4 M4 13a8 8 0 0 1 8-7 8 8 0 1 1-8 7"),
            ScrollText: createIcon("M15 12h-5 M15 8h-5 M19 17V5a2 2 0 0 0-2-2H4h10v12a2 2 0 0 1-2 2h-2H4a2 2 0 0 0-2 2v2c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2Z"),
            AlertTriangle: createIcon("M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z M12 9v4 M12 17h.01"),
            CheckCircle: createIcon("M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4L12 14.01l-3-3"),
            ArrowRight: createIcon("M5 12h14 M12 5l7 7-7 7"),
            Info: createIcon("M12 16v-4 M12 8h.01 M22 12A10 10 0 1 1 12 2a10 10 0 0 1 10 10Z"),
            LogOut: createIcon("M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9"),
            Award: createIcon("m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-5.444-3.695-5.444 3.695a.5.5 0 0 1-.81-.47l1.515-8.526 M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a2 2 0 0 1-2 2H10a2 2 0 0 1-2-2v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7Z"),
            Network: createIcon("M16 11a5 5 0 0 1-5 5 5 5 0 0 1-5-5 M7 17a5 5 0 0 0 10 0 M8 2h8 M12 12v8 M12 2v2 M5 20l3 1 M19 20l-3 1"),
            Target: createIcon("M2 12a10 10 0 1 0 20 0 10 10 0 1 0-20 0z M12 12a5 5 0 1 0 0-10 5 5 0 0 0 0 10z M12 12h.01")
        };

        // ==================================================================================
        // 2. 完整保留的 v7.51 游戏数据
        // ==================================================================================
        const PROJECT_INFO = {
            name: "SunLink 光伏+输变电项目",
            location: "A国（虚构发展中国家）- 北部干旱荒漠与“绿洲”湿地保护区交界",
            scope_items: ["新建 100MW 光伏电站", "配套 80km 132kV 输电线路", "扩建现有变电站"],
            timeline: "计划工期 24 个月",
            background: "A国正面临严重的能源危机，政府引入国际能源巨头 GreenGen 投资建设该国最大的光伏电站。然而项目选址充满争议：虽然避开了耕地，但紧邻濒危物种“长尾沙鸡”的繁殖地，且项目用水可能影响当地原住民部落的唯一水源。",
            challenge: "这是一场多方博弈。在资金有限、工期紧迫且国际 NGO 高度关注的背景下，各方需在经济利益、环境合规与社会稳定之间寻找极其脆弱的平衡点。"
        };

        const ESIA_ITEMS = [
            { id: 'b1', label: '水土保持方案', cost: 5 }, { id: 'b2', label: '施工噪音控制', cost: 5 }, 
            { id: 'b3', label: '固体废弃物处理', cost: 10 }, { id: 'b4', label: '粉尘与空气监测', cost: 5 }, 
            { id: 'b5', label: '社区交通安全计划', cost: 10 }, { id: 'b6', label: '土地征用补偿机制', cost: 20 }, 
            { id: 'b7', label: '文化遗产勘测', cost: 5 }, { id: 'a1', label: '生物多样性专项评估', cost: 20 }, 
            { id: 'a2', label: '原住民知情同意(FPIC)', cost: 10 }, { id: 'a3', label: '全生命周期碳足迹', cost: 20 }, 
        ];

        const ESMP_LIBRARY = [
            { id: 'mp1', label: 'GBV 防范行动计划', cost: 20, crisisTitle: "暗夜哭声", crisisDesc: "夜幕降临，多名妇女报告遭到身穿项目制服工人的言语骚扰。谣言疯传，愤怒的丈夫们聚集在工地门口，扬言要烧毁工棚。" },
            { id: 'mp2', label: '劳工管理程序 (LMP)', cost: 20, crisisTitle: "血汗工棚", crisisDesc: "突击检查发现，外籍劳工挤在无通风的铁皮工棚，连续工作16小时，且护照被扣押。劳工发起罢工，媒体蜂拥而至。" },
            { id: 'mp3', label: '移民安置计划 (RAP)', cost: 20, crisisTitle: "看不见的邻居", crisisDesc: "推土机强制拆除了边缘地带的简易棚屋，导致二十多个无地契家庭流离失所。他们阻断了进场道路，高举“我们要家园”的横幅。" },
            { id: 'mp4', label: '安保人员管理 (SMP)', cost: 20, crisisTitle: "过度防卫", crisisDesc: "安保人员放狗咬伤了捡拾废料的村民，血腥照片在社交媒体病毒式传播，国际人权组织发表谴责声明。" },
            { id: 'mp5', label: '危废管理计划', cost: 20, crisisTitle: "黑色渗漏", crisisDesc: "废机油未做防渗处理，暴雨后流入下游灌溉渠，导致大片秧苗枯死。愤怒的农民切断了项目水源。" },
            { id: 'mp6', label: '生物多样性管理 (BMP)', cost: 20, crisisTitle: "带血的羽毛", crisisDesc: "运输卡车为了抄近道，碾压了濒危物种“长尾沙鸡”的巢穴。环保组织现场直播了破碎的鸟蛋，引发全球抵制浪潮。" },
            { id: 'mp7', label: '水资源管理计划', cost: 20, crisisTitle: "干涸的井", crisisDesc: "项目私打深井抽水，导致下游古井干涸，村民试图砸毁水泵，与工人发生肢体冲突。" },
            { id: 'mp8', label: '交通管理计划', cost: 20, crisisTitle: "夺命尘土", crisisDesc: "超速运输车撞死耕牛后逃逸，险些伤及放学儿童。村民在公路上堆放石块，彻底封锁了交通。" },
            { id: 'mp9', label: '职业健康安全 (OHS)', cost: 20, crisisTitle: "高空坠落", crisisDesc: "一名工人未系安全带从塔架坠落致残，现场竟无安全网。工友拒绝复工，要求巨额赔偿与安全保障。" },
            { id: 'mp10', label: '文化遗产管理 (CHMP)', cost: 20, crisisTitle: "祖灵的愤怒", crisisDesc: "挖掘机挖出古墓后试图连夜掩埋，被村民发现。村民认为此举惊扰了祖灵，要求举行昂贵的净化仪式并停工。" },
            { id: 'mp11', label: '利益相关方参与 (SEP)', cost: 20, crisisTitle: "被遗忘的声音", crisisDesc: "高压线距离小学仅50米，事前未告知家长。家长们担心辐射，封锁了学校并向政府请愿。" },
        ];

        const ROLES = {
            owner: { label: "业主", name: "GreenGen", icon: Icons.User, color: "blue" },
            gov: { label: "政府", name: "能源部", icon: Icons.Landmark, color: "green" },
            mdb: { label: "银行", name: "WIB银行", icon: Icons.Globe, color: "purple" },
            epc: { label: "EPC", name: "GIP工程", icon: Icons.Building2, color: "orange" },
            ngo: { label: "公众", name: "社区代表", icon: Icons.Users, color: "red" }
        };

        const STAGE_TITLES = {
            1: "Stage 1: 环境社会评估 (ESIA)",
            2: "Stage 2: 融资与审批",
            3: "Stage 3: 招投标 (Procurement)",
            4: "Stage 4: 建设与危机应对",
            5: "Stage 5: 项目竣工与验收"
        };

        // ==================================================================================
        // 3. 基础 UI 组件
        // ==================================================================================
        const Button = ({ onClick, children, className = "", variant = "primary", disabled = false }) => {
            const baseClass = "px-4 py-2 rounded font-bold transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 shadow-lg shadow-blue-500/30",
                danger: "bg-red-600 text-white hover:bg-red-700 shadow-lg shadow-red-500/30",
                success: "bg-green-600 text-white hover:bg-green-700 shadow-lg shadow-green-500/30",
                outline: "border-2 border-slate-300 text-slate-700 hover:bg-slate-100",
                ghost: "text-slate-500 hover:bg-slate-100"
            };
            return <button onClick={onClick} disabled={disabled} className={`${baseClass} ${variants[variant]} ${className}`}>{children}</button>;
        };

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden ${className}`}>{children}</div>
        );

        // ==================================================================================
        // 4. 游戏主逻辑
        // ==================================================================================
        const SunLinkSim = () => {
            // 全局状态
            const [view, setView] = useState('cover');
            const [mode, setMode] = useState('single');
            const [myRole, setMyRole] = useState(null);
            
            // 游戏进程数据
            const [stage, setStage] = useState(1);
            const [activeRole, setActiveRole] = useState('owner');
            const [stats, setStats] = useState({
                owner: { money: 500, reputation: 100 }, gov: { cost: 0, reputation: 100 },
                mdb: { cost: 0, reputation: 100 }, epc: { money: 200, reputation: 100 },
                ngo: { benefit: 50, reputation: 100 }
            });
            const [logs, setLogs] = useState([{ t: '0:00', msg: '系统初始化完成。SunLink 模拟器 v7.51 就绪。', type: 'info' }]);
            const [gameTime, setGameTime] = useState(0);

            // 过场动画状态 (Restored Feature)
            const [showTransition, setShowTransition] = useState(false);
            const [transitionText, setTransitionText] = useState("");

            // 详细业务状态
            const [s1State, setS1State] = useState('owner_draft');
            const [ownerEsia, setOwnerEsia] = useState([]);
            const [s2State, setS2State] = useState('idle');
            const [s3State, setS3State] = useState('idle');
            const [tenderPrice, setTenderPrice] = useState(0);
            const [epcBidPrice, setEpcBidPrice] = useState(0);
            const [s4State, setS4State] = useState('idle');
            const [crisisQueue, setCrisisQueue] = useState([]);
            const [currCrisis, setCurrCrisis] = useState(null);
            const [protestState, setProtestState] = useState('idle');
            const [demandAmt, setDemandAmt] = useState(0);
            const [rulingAmt, setRulingAmt] = useState(0);

            // 多人联机
            const [roomNum, setRoomNum] = useState('');
            const [pName, setPName] = useState('');
            const syncRef = useRef(null);

            // 计时器
            useEffect(() => {
                let t;
                if (view === 'game') t = setInterval(() => setGameTime(p => p + 1), 1000);
                return () => clearInterval(t);
            }, [view]);

            // 触发转场动画
            const triggerTransition = (nextStage, cb) => {
                setTransitionText(STAGE_TITLES[nextStage]);
                setShowTransition(true);
                setTimeout(() => {
                    setStage(nextStage);
                    if(cb) cb();
                    setTimeout(() => setShowTransition(false), 1500);
                }, 1000);
            };

            // 日志与同步
            const log = (msg, type = 'info') => {
                const t = `${Math.floor(gameTime / 60)}:${(gameTime % 60).toString().padStart(2, '0')}`;
                const newLog = { t, msg, type };
                setLogs(prev => [...prev, newLog]);
                return [...logs, newLog];
            };

            const modStat = (r, k, v) => setStats(p => ({ ...p, [r]: { ...p[r], [k]: p[r][k] + v } }));

            // LeanCloud Sync (简化版)
            const broadcast = (data) => {
                if (mode !== 'multi' || !window.AV) return;
                const Action = window.AV.Object.extend('GameAction');
                new Action().save({ room: parseInt(roomNum), payload: { ...data, stage, activeRole, stats, logs } });
            };

            useEffect(() => {
                if (mode === 'multi' && view === 'game' && window.AV) {
                    syncRef.current = setInterval(async () => {
                        const q = new window.AV.Query('GameAction');
                        q.equalTo('room', parseInt(roomNum));
                        q.descending('createdAt');
                        q.limit(1);
                        try {
                            const res = await q.find();
                            if (res.length) {
                                const d = res[0].get('payload');
                                if (d.stage) setStage(d.stage);
                                if (d.activeRole) setActiveRole(d.activeRole);
                                if (d.s1State) setS1State(d.s1State);
                                if (d.s2State) setS2State(d.s2State);
                                if (d.s3State) setS3State(d.s3State);
                                if (d.s4State) setS4State(d.s4State);
                                if (d.currCrisis) setCurrCrisis(d.currCrisis);
                                if (d.protestState) setProtestState(d.protestState);
                            }
                        } catch (e) {}
                    }, 2000);
                    return () => clearInterval(syncRef.current);
                }
            }, [mode, view, roomNum]);

            // --- 业务逻辑函数 ---
            const actS1Submit = () => {
                const cost = ownerEsia.reduce((a, b) => a + ESIA_ITEMS.find(i => i.id === b).cost, 0);
                modStat('owner', 'money', -cost);
                setS1State('ngo_eval'); setActiveRole('ngo');
                const ls = log(`业主提交 ESIA 方案，包含 ${ownerEsia.length} 项，花费 $${cost} 万。`, 'blue');
                broadcast({ s1State: 'ngo_eval', activeRole: 'ngo', logs: ls, ownerEsia });
            };
            const actS1Ngo = (ok) => {
                if (ok) {
                    setS1State('gov_review'); setActiveRole('gov');
                    log('公众无异议。', 'green');
                    broadcast({ s1State: 'gov_review', activeRole: 'gov' });
                } else {
                    setS1State('owner_draft'); setActiveRole('owner');
                    log('公众抗议 ESIA 方案，要求重做。', 'red');
                    broadcast({ s1State: 'owner_draft', activeRole: 'owner' });
                }
            };
            const actS1Gov = (ok) => {
                if (ok) {
                    triggerTransition(2, () => {
                        setS2State('owner_apply'); setActiveRole('owner');
                        log('政府批准立项。进入 S2 融资。', 'green');
                    });
                    broadcast({ stage: 2, s2State: 'owner_apply', activeRole: 'owner' });
                } else {
                    setS1State('owner_draft'); setActiveRole('owner');
                    log('政府驳回立项。', 'red');
                    broadcast({ s1State: 'owner_draft', activeRole: 'owner' });
                }
            };

            const actS2Apply = () => {
                setS2State('mdb_sign'); setActiveRole('mdb');
                log('业主申请贷款。', 'blue');
                broadcast({ s2State: 'mdb_sign', activeRole: 'mdb' });
            };
            const actS2Sign = () => {
                triggerTransition(3, () => {
                    setS3State('owner_tender'); setActiveRole('owner');
                    log('银行签署协议。进入 S3 招标。', 'purple');
                });
                broadcast({ stage: 3, s3State: 'owner_tender', activeRole: 'owner' });
            };

            const actS3Tender = () => {
                setS3State('epc_bid'); setActiveRole('epc');
                log(`业主发标，控制价 $${tenderPrice} 万。`, 'blue');
                broadcast({ s3State: 'epc_bid', activeRole: 'epc', tenderPrice });
            };
            const actS3Bid = () => {
                setS3State('owner_eval'); setActiveRole('owner');
                log(`EPC 报价 $${epcBidPrice} 万。`, 'orange');
                broadcast({ s3State: 'owner_eval', activeRole: 'owner', epcBidPrice });
            };
            const actS3Eval = (ok) => {
                if (ok) {
                    triggerTransition(4, () => {
                        setS4State('epc_plan'); setActiveRole('epc');
                        log('合同签订。进入 S4 建设。', 'green');
                    });
                    broadcast({ stage: 4, s4State: 'epc_plan', activeRole: 'epc' });
                } else {
                    setS3State('epc_bid'); setActiveRole('epc');
                    log('业主驳回报价。', 'red');
                    broadcast({ s3State: 'epc_bid', activeRole: 'epc' });
                }
            };

            const actS4Start = () => {
                // 生成危机队列：强制包含未被ESIA覆盖的风险 + 随机风险
                const q = [ESMP_LIBRARY[0], ESMP_LIBRARY[5]]; // 示例：GBV 和 生物多样性
                setCrisisQueue(q);
                setCurrCrisis(q[0]);
                setS4State('crisis'); setActiveRole('ngo'); setProtestState('ngo_decide');
                log(`EPC 进场。突发危机：${q[0].crisisTitle}`, 'red');
                broadcast({ s4State: 'crisis', activeRole: 'ngo', protestState: 'ngo_decide', currCrisis: q[0] });
            };
            const actS4NgoDecide = (claim) => {
                if (claim) {
                    setProtestState('ngo_demand');
                    broadcast({ protestState: 'ngo_demand' });
                } else resolveCrisis();
            };
            const actS4NgoSubmit = () => {
                setProtestState('party_resp'); setActiveRole('epc');
                log(`公众索赔 $${demandAmt} 万。`, 'red');
                broadcast({ protestState: 'party_resp', activeRole: 'epc', demandAmt });
            };
            const actS4PartyResp = (pay) => {
                if (pay) {
                    modStat('epc', 'money', -demandAmt); modStat('ngo', 'benefit', demandAmt);
                    log('EPC 支付赔偿。', 'blue');
                    resolveCrisis();
                } else {
                    setProtestState('gov_rule'); setActiveRole('gov');
                    log('EPC 拒绝，政府介入。', 'purple');
                    broadcast({ protestState: 'gov_rule', activeRole: 'gov' });
                }
            };
            const actS4GovRule = () => {
                modStat('epc', 'money', -rulingAmt); modStat('ngo', 'benefit', rulingAmt);
                log(`政府裁决赔偿 $${rulingAmt} 万。`, 'green');
                resolveCrisis();
            };
            const resolveCrisis = () => {
                const idx = crisisQueue.findIndex(c => c.id === currCrisis.id);
                if (idx < crisisQueue.length - 1) {
                    const next = crisisQueue[idx + 1];
                    setCurrCrisis(next);
                    setProtestState('ngo_decide'); setActiveRole('ngo');
                    log(`新危机爆发：${next.crisisTitle}`, 'red');
                    broadcast({ currCrisis: next, protestState: 'ngo_decide', activeRole: 'ngo' });
                } else {
                    triggerTransition(5, () => {
                        setActiveRole('all');
                        log('所有危机解决，项目竣工。', 'green');
                    });
                    broadcast({ stage: 5, activeRole: 'all' });
                }
            };

            // --- 渲染部分 ---

            // 1. 封面
            if (view === 'cover') return (
                <div className="h-screen bg-slate-900 flex items-center justify-center relative overflow-hidden">
                    <div className="absolute inset-0 opacity-20 bg-[url('https://images.unsplash.com/photo-1497435334941-8c899ee9e8e9?auto=format&fit=crop&w=1920')] bg-cover bg-center" />
                    <div className="z-10 text-center space-y-8 animate-fade-in">
                        <div className="flex justify-center"><div className="p-4 bg-blue-500/20 rounded-full backdrop-blur"><Icons.Activity size={64} className="text-blue-400" /></div></div>
                        <h1 className="text-6xl font-black text-white tracking-tight">SunLink ESG <span className="text-blue-500">Simulator</span></h1>
                        <p className="text-slate-400 text-lg">v7.51 (Final Stable)</p>
                        <div className="flex gap-4 justify-center">
                            <Button onClick={() => { setMode('single'); setView('intro'); }} className="h-12 px-8 text-lg">单人体验</Button>
                            <Button onClick={() => { setMode('multi'); setView('lobby'); }} className="h-12 px-8 text-lg" variant="primary">多人联机</Button>
                        </div>
                    </div>
                </div>
            );

            // 2. 大厅
            if (view === 'lobby') return (
                <div className="h-screen bg-slate-900 flex items-center justify-center">
                    <Card className="w-96 p-6 space-y-4 animate-slide-up">
                        <h2 className="text-xl font-bold text-center">加入房间</h2>
                        <input className="w-full p-2 border rounded" placeholder="昵称" value={pName} onChange={e => setPName(e.target.value)} />
                        <input className="w-full p-2 border rounded" placeholder="房间号" type="number" value={roomNum} onChange={e => setRoomNum(e.target.value)} />
                        <Button onClick={() => {
                            if (!pName || !roomNum) return;
                            if (window.AV && !window.AV.applicationId) window.AV.init({ appId: "oxljnef7788g0vxPG8KFVbov-MdYXbMMI", appKey: "w3iUN3cMVOVBaPAMh96Dr2VX", serverURL: "https://oxljnef7.api.lncldglobal.com" });
                            setView('roles');
                        }} className="w-full">下一步</Button>
                        <Button onClick={() => setView('cover')} variant="ghost" className="w-full">返回</Button>
                    </Card>
                </div>
            );

            // 3. 选角
            if (view === 'roles') return (
                <div className="h-screen bg-slate-100 p-8 flex flex-col items-center">
                    <h2 className="text-3xl font-bold mb-8">选择角色</h2>
                    <div className="grid grid-cols-5 gap-4 w-full max-w-6xl">
                        {Object.keys(ROLES).map(k => {
                            const RoleIcon = ROLES[k].icon;
                            return (
                                <div key={k} onClick={() => setMyRole(k)} className={`p-6 bg-white rounded-xl border-2 cursor-pointer transition-all hover:scale-105 ${myRole === k ? 'border-blue-500 shadow-xl' : 'border-transparent hover:border-slate-300'}`}>
                                    <div className={`w-12 h-12 rounded-full bg-${ROLES[k].color}-100 flex items-center justify-center mb-4`}><RoleIcon className={`text-${ROLES[k].color}-600`} /></div>
                                    <h3 className="font-bold text-lg">{ROLES[k].label}</h3>
                                    <p className="text-sm text-slate-500">{ROLES[k].name}</p>
                                </div>
                            );
                        })}
                    </div>
                    <Button disabled={!myRole} onClick={() => setView('intro')} className="mt-8 h-12 px-12 text-lg">确认选择</Button>
                </div>
            );

            // 4. Intro
            if (view === 'intro') return (
                <div className="h-screen bg-slate-50 p-8 overflow-auto flex justify-center">
                    <div className="max-w-4xl w-full space-y-8 animate-slide-up pb-10">
                        <div className="flex items-center gap-4 border-b pb-4">
                            <Icons.Info size={40} className="text-blue-600" />
                            <div>
                                <h1 className="text-3xl font-black text-slate-900">{PROJECT_INFO.name}</h1>
                                <p className="text-slate-500 flex items-center gap-2"><Icons.Globe size={16} /> {PROJECT_INFO.location}</p>
                            </div>
                        </div>
                        <div className="bg-white p-8 rounded-xl shadow-sm space-y-6 text-slate-700 leading-relaxed">
                            <div><h3 className="font-bold text-slate-900 mb-2">项目背景</h3><p>{PROJECT_INFO.background}</p></div>
                            <div className="grid grid-cols-2 gap-6">
                                <div className="bg-blue-50 p-4 rounded">
                                    <h3 className="font-bold text-blue-800 mb-2">工程范围</h3>
                                    <ul className="list-disc list-inside text-sm text-blue-700 space-y-1">{PROJECT_INFO.scope_items.map(i => <li key={i}>{i}</li>)}</ul>
                                </div>
                                <div className="bg-orange-50 p-4 rounded">
                                    <h3 className="font-bold text-orange-800 mb-2">核心挑战</h3>
                                    <p className="text-sm text-orange-700">{PROJECT_INFO.challenge}</p>
                                </div>
                            </div>
                        </div>
                        <Button onClick={() => setView('game')} className="w-full h-16 text-xl shadow-xl">进入模拟系统 <Icons.ArrowRight className="ml-2" /></Button>
                    </div>
                </div>
            );

            // 5. 游戏主界面
            return (
                <div className="h-screen w-full bg-slate-100 flex flex-col relative overflow-hidden">
                    {/* 过场动画层 (v7.51 特有) */}
                    {showTransition && (
                        <div className="absolute inset-0 z-50 bg-black flex items-center justify-center animate-fade-in">
                            <h1 className="text-4xl font-black text-white tracking-widest animate-slide-up">{transitionText}</h1>
                        </div>
                    )}

                    {/* 顶栏 */}
                    <header className="h-16 bg-white border-b px-6 flex items-center justify-between shrink-0">
                        <div className="flex items-center gap-4 font-bold text-slate-800">
                            <Icons.Activity className="text-blue-600" /> SunLink ESG
                            {mode === 'multi' && <span className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">{pName} ({ROLES[myRole]?.label})</span>}
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="bg-slate-100 px-3 py-1 rounded flex items-center gap-2 text-slate-600 font-mono"><Icons.Timer size={16} /> {Math.floor(gameTime / 60)}:{(gameTime % 60).toString().padStart(2, '0')}</div>
                            <Button variant="ghost" onClick={() => setView('cover')}><Icons.LogOut size={20} /></Button>
                        </div>
                    </header>

                    <div className="flex-1 flex overflow-hidden">
                        {/* 左侧：操作区 */}
                        <main className="flex-1 p-6 overflow-y-auto flex flex-col gap-6">
                            {/* 进度条 */}
                            <div className="bg-white p-4 rounded-xl shadow-sm flex justify-between px-8">
                                {[1, 2, 3, 4, 5].map(s => (
                                    <div key={s} className={`flex flex-col items-center ${stage === s ? 'text-blue-600 font-bold scale-110 transition-transform' : 'text-slate-300'}`}>
                                        <div className={`w-8 h-8 rounded-full border-2 flex items-center justify-center mb-1 ${stage === s ? 'border-blue-600 bg-blue-50' : 'border-slate-200'}`}>{stage > s ? <Icons.CheckCircle size={16} /> : s}</div>
                                        <span className="text-xs">S{s}</span>
                                    </div>
                                ))}
                            </div>

                            {/* 主卡片 */}
                            <Card className="flex-1 flex flex-col relative min-h-[400px]">
                                <div className={`absolute top-0 left-0 w-full h-1 ${mode === 'single' || myRole === activeRole ? 'bg-green-500' : 'bg-slate-200'}`} />
                                <div className="p-4 border-b flex justify-between items-center bg-slate-50/50">
                                    <h2 className="font-bold text-lg flex items-center gap-2">
                                        <Icons.Zap className={mode === 'single' || myRole === activeRole ? "text-green-600" : "text-slate-400"} />
                                        {stage === 4 && currCrisis ? "危机处理中" : `当前阶段：${STAGE_TITLES[stage].split(':')[1]}`}
                                    </h2>
                                    <span className="text-xs text-slate-500">当前行动方: {ROLES[activeRole].label}</span>
                                </div>

                                <div className="flex-1 p-8 overflow-y-auto bg-white">
                                    {/* S1 内容 */}
                                    {stage === 1 && activeRole === 'owner' && s1State === 'owner_draft' && (
                                        <div className="space-y-6 animate-slide-up">
                                            <div className="bg-blue-50 p-4 rounded text-blue-800 text-sm"><Icons.Info className="inline mr-1" size={14} /> 请勾选要纳入 ESIA 报告的评估项目。这将影响初始成本与后续风险。</div>
                                            <div className="grid grid-cols-2 gap-3">
                                                {ESIA_ITEMS.map(i => (
                                                    <div key={i.id} onClick={() => (mode === 'single' || myRole === 'owner') && setOwnerEsia(p => p.includes(i.id) ? p.filter(x => x !== i.id) : [...p, i.id])}
                                                        className={`p-3 rounded border cursor-pointer flex justify-between ${ownerEsia.includes(i.id) ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white hover:bg-slate-50'}`}>
                                                        <span className="text-sm">{i.label}</span><span className="text-xs opacity-80">${i.cost}</span>
                                                    </div>
                                                ))}
                                            </div>
                                            {(mode === 'single' || myRole === 'owner') && <div className="flex justify-end"><Button onClick={actS1Submit}>提交方案</Button></div>}
                                        </div>
                                    )}
                                    {stage === 1 && activeRole === 'ngo' && (
                                        <div className="text-center space-y-6 animate-slide-up">
                                            <Icons.ScrollText size={64} className="mx-auto text-slate-300" />
                                            <h3 className="text-xl font-bold">公众评议</h3>
                                            <p>业主提交了 ESIA 方案，总预算 ${ownerEsia.reduce((a, b) => a + ESIA_ITEMS.find(i => i.id === b).cost, 0)} 万。社区是否满意？</p>
                                            {(mode === 'single' || myRole === 'ngo') && <div className="flex justify-center gap-4"><Button variant="success" onClick={() => actS1Ngo(true)}>无异议</Button><Button variant="danger" onClick={() => actS1Ngo(false)}>抗议</Button></div>}
                                        </div>
                                    )}
                                    {stage === 1 && activeRole === 'gov' && (
                                        <div className="text-center space-y-6 animate-slide-up">
                                            <Icons.Landmark size={64} className="mx-auto text-slate-300" />
                                            <h3 className="text-xl font-bold">行政审批</h3>
                                            <p>请审核业主的立项申请材料。</p>
                                            {(mode === 'single' || myRole === 'gov') && <div className="flex justify-center gap-4"><Button variant="success" onClick={() => actS1Gov(true)}>批准立项</Button><Button variant="danger" onClick={() => actS1Gov(false)}>驳回</Button></div>}
                                        </div>
                                    )}

                                    {/* S2 内容 */}
                                    {stage === 2 && activeRole === 'owner' && (
                                        <div className="text-center py-10 animate-slide-up"><Icons.Building2 size={64} className="mx-auto text-blue-300 mb-4" /><p className="mb-6">立项已获批。现在需要向世界银行申请贷款。</p>{(mode === 'single' || myRole === 'owner') && <Button onClick={actS2Apply}>申请贷款</Button>}</div>
                                    )}
                                    {stage === 2 && activeRole === 'mdb' && (
                                        <div className="text-center py-10 animate-slide-up"><Icons.Globe size={64} className="mx-auto text-purple-300 mb-4" /><p className="mb-6">审核项目的环境社会承诺计划 (ESCP)。</p>{(mode === 'single' || myRole === 'mdb') && <Button onClick={actS2Sign} variant="success">签署协议</Button>}</div>
                                    )}

                                    {/* S3 内容 */}
                                    {stage === 3 && activeRole === 'owner' && s3State === 'owner_tender' && (
                                        <div className="max-w-md mx-auto space-y-4 animate-slide-up"><h3 className="text-center font-bold">设定招标控制价</h3><input type="number" className="w-full p-3 border rounded text-lg" placeholder="金额 ($万)" onChange={e => setTenderPrice(Number(e.target.value))} />{(mode === 'single' || myRole === 'owner') && <Button className="w-full" onClick={actS3Tender}>发布招标文件</Button>}</div>
                                    )}
                                    {stage === 3 && activeRole === 'epc' && (
                                        <div className="max-w-md mx-auto space-y-4 animate-slide-up"><h3 className="text-center font-bold">提交投标文件</h3><div className="text-center text-sm text-slate-500">控制价: ${tenderPrice}</div><input type="number" className="w-full p-3 border rounded text-lg" placeholder="报价 ($万)" onChange={e => setEpcBidPrice(Number(e.target.value))} />{(mode === 'single' || myRole === 'epc') && <Button className="w-full" variant="primary" onClick={actS3Bid}>投标</Button>}</div>
                                    )}
                                    {stage === 3 && activeRole === 'owner' && s3State === 'owner_eval' && (
                                        <div className="text-center space-y-6 animate-slide-up"><h3 className="text-xl font-bold">评标</h3><p className="text-2xl font-black">${epcBidPrice} 万</p>{(mode === 'single' || myRole === 'owner') && <div className="flex justify-center gap-4"><Button variant="success" onClick={() => actS3Eval(true)}>接受报价</Button><Button variant="danger" onClick={() => actS3Eval(false)}>驳回</Button></div>}</div>
                                    )}

                                    {/* S4 内容 */}
                                    {stage === 4 && activeRole === 'epc' && s4State === 'epc_plan' && (
                                        <div className="text-center py-10 animate-slide-up"><Icons.Building2 size={64} className="mx-auto text-orange-300 mb-4" /><h3 className="text-xl font-bold mb-2">施工准备就绪</h3><p className="mb-6">人员设备已集结，准备进场。</p>{(mode === 'single' || myRole === 'epc') && <Button onClick={actS4Start} variant="primary">进场施工</Button>}</div>
                                    )}
                                    {stage === 4 && currCrisis && (
                                        <div className="bg-red-50 border-l-4 border-red-500 p-6 rounded-r-lg animate-slide-up">
                                            <div className="flex items-center gap-2 text-red-800 font-bold text-xl mb-4"><Icons.AlertTriangle /> {currCrisis.crisisTitle}</div>
                                            <p className="text-red-900 mb-6 leading-relaxed">{currCrisis.crisisDesc}</p>
                                            {activeRole === 'ngo' && protestState === 'ngo_decide' && (
                                                <div className="border-t border-red-200 pt-4">
                                                    <p className="mb-4 font-bold text-red-800">社区行动决策：</p>
                                                    {(mode === 'single' || myRole === 'ngo') && <div className="flex gap-4"><Button variant="danger" onClick={() => actS4NgoDecide(true)}>发起索赔</Button><Button variant="outline" onClick={() => actS4NgoDecide(false)}>息事宁人</Button></div>}
                                                </div>
                                            )}
                                            {activeRole === 'ngo' && protestState === 'ngo_demand' && (
                                                <div className="flex gap-2 mt-4">{(mode === 'single' || myRole === 'ngo') && <><input type="number" className="border p-2 rounded w-32" placeholder="索赔额" onChange={e => setDemandAmt(Number(e.target.value))} /><Button variant="danger" onClick={actS4NgoSubmit}>提交</Button></>}</div>
                                            )}
                                            {activeRole === 'epc' && protestState === 'party_resp' && (
                                                <div className="mt-4 space-y-4"><p>索赔金额: <span className="font-bold">${demandAmt}万</span></p>{(mode === 'single' || myRole === 'epc') && <div className="flex gap-4"><Button variant="primary" onClick={() => actS4PartyResp(true)}>同意赔偿</Button><Button variant="danger" onClick={() => actS4PartyResp(false)}>拒绝</Button></div>}</div>
                                            )}
                                            {activeRole === 'gov' && protestState === 'gov_rule' && (
                                                <div className="mt-4 flex gap-2">{(mode === 'single' || myRole === 'gov') && <><input type="number" className="border p-2 rounded w-32" placeholder="裁决额" onChange={e => setRulingAmt(Number(e.target.value))} /><Button variant="success" onClick={actS4GovRule}>裁决</Button></>}</div>
                                            )}
                                        </div>
                                    )}
                                    {stage === 5 && (
                                        <div className="text-center py-12 animate-slide-up"><Icons.Award size={80} className="mx-auto text-yellow-500 mb-6" /><h2 className="text-4xl font-black mb-4">模拟结束</h2><p>项目已竣工。请查看右侧各方最终得分。</p><Button onClick={() => window.location.reload()} className="mt-8" variant="outline">重新开始</Button></div>
                                    )}
                                </div>
                            </Card>
                        </main>

                        {/* 右侧：信息栏 */}
                        <aside className="w-80 bg-white border-l flex flex-col shadow-xl z-10">
                            <div className="p-4 border-b bg-slate-50">
                                <h3 className="text-xs font-bold text-slate-400 uppercase mb-3">各方状态</h3>
                                <div className="space-y-3">
                                    {Object.keys(ROLES).map(k => (
                                        <div key={k} className={`flex items-center justify-between p-2 rounded ${activeRole === k ? 'bg-white shadow ring-1 ring-blue-200' : 'opacity-70'}`}>
                                            <div className="flex items-center gap-2">
                                                <div className={`p-1 rounded bg-${ROLES[k].color}-100 text-${ROLES[k].color}-600`}><ROLES[k].icon size={14} /></div>
                                                <span className="text-sm font-bold">{ROLES[k].label}</span>
                                            </div>
                                            <span className="text-xs font-mono font-bold">${stats[k].money || stats[k].cost || stats[k].benefit || 0}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="flex-1 flex flex-col overflow-hidden">
                                <div className="p-3 border-b text-xs font-bold text-slate-500 flex items-center gap-2"><Icons.ScrollText size={14} /> 事件日志</div>
                                <div className="flex-1 overflow-y-auto p-3 space-y-2 bg-slate-50">
                                    {logs.slice().reverse().map((l, i) => (
                                        <div key={i} className={`text-xs p-2 rounded border-l-2 bg-white ${l.type === 'red' ? 'border-red-500 text-red-800' : l.type === 'green' ? 'border-green-500 text-green-800' : l.type === 'purple' ? 'border-purple-500 text-purple-800' : 'border-blue-400 text-slate-600'}`}>
                                            <span className="opacity-50 mr-1">[{l.t}]</span>{l.msg}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </aside>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SunLinkSim />);
    </script>
</body>
</html>
