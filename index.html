<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SunLink ESG Simulator v9.0 (Full Restoration)</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LeanCloud SDK -->
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>

    <!-- Lucide Icons (Load library ONLY) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInTop { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
        .slide-in-from-top-5 { animation: slideInTop 0.5s ease-out forwards; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        body { -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-slate-900 text-slate-800 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // ==========================================
        // 1. 核心修复: 自定义 Icon 组件 (防崩溃版)
        // ==========================================
        const Icon = ({ name, size = 24, className = "" }) => {
            // 将 kebab-case 转换为 PascalCase 以匹配 lucide.icons 对象键名
            const camelCase = name.replace(/-([a-z])/g, (g) => g[1].toUpperCase());
            const PascalCase = camelCase.charAt(0).toUpperCase() + camelCase.slice(1);
            
            // 从全局 window.lucide 对象获取图标数据
            const iconData = window.lucide && window.lucide.icons ? window.lucide.icons[PascalCase] : null;

            // 如果找不到图标，渲染占位符，避免崩溃
            if (!iconData) return <span className={`inline-block bg-gray-300 rounded-sm ${className}`} style={{width:size, height:size}} />;

            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={`lucide lucide-${name} ${className}`}
                    dangerouslySetInnerHTML={{ __html: iconData.map(child => {
                        const [tag, attrs] = child;
                        const attrStr = Object.entries(attrs).map(([k, v]) => `${k}="${v}"`).join(' ');
                        return `<${tag} ${attrStr} />`;
                    }).join('') }}
                />
            );
        };

        // 图标映射组件 (保留原来的调用方式)
        const Activity = p => <Icon name="activity" {...p} />;
        const User = p => <Icon name="user" {...p} />;
        const Building2 = p => <Icon name="building-2" {...p} />;
        const Landmark = p => <Icon name="landmark" {...p} />;
        const Globe = p => <Icon name="globe" {...p} />;
        const Users = p => <Icon name="users" {...p} />;
        const ArrowRight = p => <Icon name="arrow-right" {...p} />;
        const FileText = p => <Icon name="file-text" {...p} />;
        const CheckCircle2 = p => <Icon name="check-circle-2" {...p} />;
        const MapPin = p => <Icon name="map-pin" {...p} />;
        const Banknote = p => <Icon name="banknote" {...p} />;
        const Clock = p => <Icon name="clock" {...p} />;
        const ShieldAlert = p => <Icon name="shield-alert" {...p} />;
        const AlertTriangle = p => <Icon name="alert-triangle" {...p} />;
        const Timer = p => <Icon name="timer" {...p} />;
        const Gavel = p => <Icon name="gavel" {...p} />;
        const BookOpen = p => <Icon name="book-open" {...p} />;
        const Reply = p => <Icon name="reply" {...p} />;
        const ClipboardCheck = p => <Icon name="clipboard-check" {...p} />;
        const Award = p => <Icon name="award" {...p} />;
        const Megaphone = p => <Icon name="megaphone" {...p} />;
        const Handshake = p => <Icon name="handshake" {...p} />;
        const Eye = p => <Icon name="eye" {...p} />;
        const Zap = p => <Icon name="zap" {...p} />;
        const HardHat = p => <Icon name="hard-hat" {...p} />;
        const ListChecks = p => <Icon name="list-checks" {...p} />;
        const PieChart = p => <Icon name="pie-chart" {...p} />;
        const BarChart3 = p => <Icon name="bar-chart-3" {...p} />;
        const ScrollText = p => <Icon name="scroll-text" {...p} />;
        const Target = p => <Icon name="target" {...p} />;
        const LogIn = p => <Icon name="log-in" {...p} />;
        const Users2 = p => <Icon name="users-2" {...p} />;
        const Loader2 = p => <Icon name="loader-2" {...p} />;
        const Network = p => <Icon name="network" {...p} />;
        const UserPlus = p => <Icon name="user-plus" {...p} />;
        const ArrowBigRight = p => <Icon name="arrow-big-right" {...p} />;

        // ==========================================
        // 2. 基础 UI 组件
        // ==========================================
        const Card = ({ className, children }) => <div className={`bg-white rounded-lg border text-card-foreground shadow-sm ${className}`}>{children}</div>;
        const CardHeader = ({ className, children }) => <div className={`flex flex-col space-y-1.5 p-6 ${className}`}>{children}</div>;
        const CardTitle = ({ className, children }) => <h3 className={`text-2xl font-semibold leading-none tracking-tight ${className}`}>{children}</h3>;
        const CardContent = ({ className, children }) => <div className={`p-6 pt-0 ${className}`}>{children}</div>;
        const Button = ({ className, variant="default", size="default", children, onClick, disabled }) => {
            const baseStyle = "inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 cursor-pointer select-none";
            const variants = {
                default: "bg-slate-900 text-white hover:bg-slate-900/90 shadow",
                destructive: "bg-red-500 text-white hover:bg-red-600 shadow",
                outline: "border border-slate-200 bg-white hover:bg-slate-100 hover:text-slate-900",
                secondary: "bg-slate-100 text-slate-900 hover:bg-slate-200",
                ghost: "hover:bg-slate-100 hover:text-slate-900",
                link: "text-slate-900 underline-offset-4 hover:underline"
            };
            const sizes = {
                default: "h-10 px-4 py-2",
                sm: "h-9 rounded-md px-3",
                lg: "h-11 rounded-md px-8 text-base",
                icon: "h-10 w-10"
            };
            return <button className={`${baseStyle} ${variants[variant] || variants.default} ${sizes[size] || sizes.default} ${className}`} onClick={onClick} disabled={disabled}>{children}</button>;
        };
        const Badge = ({ className, variant="default", children }) => {
            const base = "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2";
            const variants = {
                default: "border-transparent bg-slate-900 text-white hover:bg-slate-900/80",
                secondary: "border-transparent bg-slate-100 text-slate-900 hover:bg-slate-100/80",
                destructive: "border-transparent bg-red-500 text-white hover:bg-red-500/80",
                outline: "text-slate-950"
            };
            return <div className={`${base} ${variants[variant] || variants.default} ${className}`}>{children}</div>;
        };
        const Input = (props) => <input {...props} className={`flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 ${props.className}`} />;
        const Textarea = (props) => <textarea {...props} className={`flex min-h-[80px] w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm ring-offset-background placeholder:text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 ${props.className}`} />;
        const Checkbox = ({ checked, onCheckedChange, disabled, className }) => (
            <input type="checkbox" checked={checked} onChange={(e) => onCheckedChange(e.target.checked)} disabled={disabled} className={`h-4 w-4 rounded border-gray-300 text-slate-900 focus:ring-slate-500 ${className}`} />
        );
        
        const Progress = ({ value, className }) => (
            <div className={`h-2 w-full bg-slate-200 rounded-full overflow-hidden ${className}`}>
                <div className="h-full bg-slate-900 transition-all duration-500" style={{ width: `${value}%` }} />
            </div>
        );

        // ==========================================
        // 3. 数据常量 (恢复完整版数据)
        // ==========================================
        const PROJECT_INFO = {
          name: "SunLink 光伏+输变电项目", 
          location: "A国 (虚构发展中国家) - 北部干旱荒漠与'绿洲'湿地保护区的交界地带",
          scope_items: [
            "新建一座 100 MW 光伏电站",
            "配套建设约 80 km、132kV 输电线路，接入国家主干电网",
            "扩建一座现有变电站，新增 132/220kV 主变及相关设备"
          ],
          timeline: "计划并网发电时间：24个月 (游戏中1分钟代表1个月)",
          stages_visual: [
            { id: 1, title: "立项审批", task: "开展环境社会影响评价 (ESIA)", color: "bg-blue-50 border-blue-200 text-blue-800" },
            { id: 2, title: "项目融资", task: "签订环境社会承诺计划 (ESCP)", color: "bg-indigo-50 border-indigo-200 text-indigo-800" },
            { id: 3, title: "EPC合同谈判", task: "编制环境社会管理计划 (ESMP) 与合同设计", color: "bg-violet-50 border-violet-200 text-violet-800" }, 
            { id: 4, title: "项目建设", task: "执行环境社会管理计划 (ESMP)", color: "bg-orange-50 border-orange-200 text-orange-800" },
            { id: 5, title: "验收评价", task: "竣工验收与ESG后评价", color: "bg-emerald-50 border-emerald-200 text-emerald-800" }
          ],
          background: "A国作为典型的资源型发展中国家，正面临严重的能源短缺与减排压力。政府引入国际能源巨头 GreenGen 投资建设该国最大的光伏电站。然而，项目选址极具争议：它虽然避开了核心耕地，但紧邻濒危物种'长尾沙鸡'的最后一块繁殖地，且项目用水可能通过地下水系影响下游原住民部落的唯一水源。",
          mission: "这是一场多方博弈。在资金有限、工期紧迫、且国际NGO高度关注的背景下，各方需在经济利益、环境合规与社会稳定之间寻找极其脆弱的平衡点。任何一方的激进决策都可能导致项目停摆。"
        };

        const ROLE_DETAILS = {
          owner: { 
              label: "业主", 
              desc: "投资方 GreenGen 集团 (跨国能源巨头)", 
              task: "你需要对总部的财务报表负责，首要目标是控制投资和按期并网发电。虽然你知道ESG很重要，但同时也意味着昂贵的成本。",
              icon: User,
              color: "text-blue-600 bg-blue-50 border-blue-200"
          },
          gov: { 
              label: "政府", 
              desc: "A国能源与环境部 (监管者)", 
              task: "你处于夹缝之中。一方面，你需要这个项目带来的电力和税收政绩；另一方面，你必须依据法律监管环境问题，否则会被国际社会指责甚至引发国内动荡。你的审批权是你最大的筹码。",
              icon: Landmark,
              color: "text-green-600 bg-green-50 border-green-200"
          },
          mdb: { 
              label: "多边开发银行", 
              desc: "世界基础设施银行 (WIB) (贷款方)", 
              task: "你为项目提供关键的低息贷款，遵循世界银行《环境社会框架》（ESF），期望通过项目促进当地经济社会发展并支持当地能力建设。你的《环境社会标准》（ESS）是项目的紧箍咒，你并不直接管理项目建设，但如果项目出现丑闻，声誉风险是你无法接受的。",
              icon: Globe,
              color: "text-purple-600 bg-purple-50 border-purple-200"
          },
          epc: { 
              label: "EPC承包商", 
              desc: "GIP国际工程公司 (总包方)", 
              task: "你是项目的总承包商。你的目标是争取对自己有利的合同条件，在合同谈判阶段与业主划分ESG责任，并在报价中考虑自己需要负责的环境社会管理计划（ESMP）。建设阶段按合同办事，落实ESMP会增加成本，但也需要考虑企业声誉的影响。",
              icon: Building2,
              color: "text-orange-600 bg-orange-50 border-orange-200"
          },
          ngo: { 
              label: "公众", 
              desc: "当地受影响社区及NGO (监督者)", 
              task: "你们资源最少，但声音最大。你们不反对项目，但反对以牺牲环境为代价的发展，希望社区从中获益，担心生态环境破坏。如果诉求得不到满足，你们会抗议、甚至阻工。",
              icon: Users,
              color: "text-red-600 bg-red-50 border-red-200"
          }
        };
        
        const ROLE_ORDER = ['owner', 'gov', 'mdb', 'epc', 'ngo'];

        const ESIA_ITEMS = [
          { id: 'b1', label: '水土保持方案', cost: 5, desc: "防止建设期间的水土流失" }, 
          { id: 'b2', label: '施工噪音控制', cost: 5, desc: "设置隔音屏障，限制夜间施工" }, 
          { id: 'b3', label: '固体废弃物处理', cost: 10, desc: "分类收集和处理施工垃圾" },
          { id: 'b4', label: '粉尘与空气监测', cost: 5, desc: "定期洒水，覆盖裸露土方" }, 
          { id: 'b5', label: '社区交通安全计划', cost: 10, desc: "设置交通标志，聘请协管员" },
          { id: 'b6', label: '土地征用补偿机制', cost: 20, desc: "按市场价补偿，并提供生计恢复支持" }, 
          { id: 'b7', label: '文化遗产勘测', cost: 5, desc: "施工前进行地下文物勘探" }, 
          { id: 'a1', label: '生物多样性专项评估', cost: 20, desc: "针对'长尾沙鸡'等濒危物种的详细调查" }, 
          { id: 'a2', label: '原住民知情同意(FPIC)', cost: 10, desc: "确保原住民充分理解项目并自愿同意" },
          { id: 'a3', label: '全生命周期碳足迹', cost: 20, desc: "评估项目从建设到拆除的碳排放" }, 
        ];

        // 恢复完整的 11 个 ESMP 危机事件
        const ESMP_LIBRARY = [
          { id: 'mp1', label: '基于性别的暴力/性剥削和虐待行动计划 (GBV/SEA/SH)', cost: 20, crisisTitle: "暗夜哭声", crisisDesc: "夜幕降临，工地附近的村落不再宁静。多名妇女报告称，在往返集市的途中遭到身穿项目制服工人的言语骚扰甚至肢体拉扯。谣言在村里疯传，愤怒的丈夫和父亲们聚集在工地门口，挥舞着棍棒，要求交出肇事者。当地长老警告：如果不能保障女性安全，他们将切断工地水源。" },
          { id: 'mp2', label: '劳工管理程序 (LMP)', cost: 20, crisisTitle: "血汗工棚", crisisDesc: "为赶在雨季前完成地基工程，项目部强制实行'两班倒'制度。突击检查发现，几十名外籍劳工挤在没有通风设备的铁皮工棚里，连续工作超过16小时且无加班费，护照被扣押。一名劳工在高温下晕倒后被拒绝送医，引发了激烈的罢工抗议，国际人权观察组织已经介入调查。" },
          { id: 'mp3', label: '移民安置行动计划 (RAP)', cost: 20, crisisTitle: "看不见的邻居", crisisDesc: "在项目征地红线边缘，居住着一群没有土地所有权的经济移民。推土机在清理场地时，强制拆除了他们的简易棚屋，导致二十多个家庭流离失所。这些人举着'我们也是人'的标语，在通往工地的必经之路上搭起帐篷，阻断了所有运输车辆，导致混凝土搅拌车在路上凝固。" },
          { id: 'mp4', label: '安全保卫人员管理计划 (SMP)', cost: 20, crisisTitle: "过度防卫", crisisDesc: "几名当地村民试图进入工地废料堆捡拾废弃的金属边角料。受雇的私人安保公司人员（缺乏人权培训的前雇佣兵）放狗撕咬并使用警棍殴打村民，导致两人重伤。照片在社交媒体上病毒式传播，标题是'跨国公司雇凶伤人'，激起了全国性的反感。" },
          { id: 'mp5', label: '废物与危险废物管理计划', cost: 20, crisisTitle: "黑色渗漏", crisisDesc: "施工机械更换下来的废机油和液压油被随意堆放在未做防渗处理的土坑中。一场暴雨过后，黑色的油污溢出，顺着地势流入了下游的农田灌溉渠。农民们发现秧苗枯死，井水泛着油花，要求巨额赔偿并立即停工治理。" },
          { id: 'mp6', label: '生物多样性管理计划 (BMP)', cost: 20, crisisTitle: "带血的羽毛", crisisDesc: "正值濒危物种'长尾沙鸡'的繁殖季。一辆重型运输卡车为了抄近道，擅自驶入保护区边缘的草场，碾压了多处隐蔽在草丛中的巢穴，破碎的鸟蛋和带血的羽毛触目惊心。环保NGO带着记者在现场进行直播，指控项目方犯下了'生态屠杀'罪行。" },
          { id: 'mp7', label: '水资源管理计划', cost: 20, crisisTitle: "干涸的井", crisisDesc: "项目部为了清洗光伏板和抑制扬尘，为了节约成本，擅自在工地内打深井抽取地下水。几个月后，下游村庄依靠了几百年的古井水位急剧下降甚至干涸。愤怒的村民冲进工地，试图砸毁水泵设施，高喊'水是我们的生命'。" },
          { id: 'mp8', label: '交通管理计划', cost: 20, crisisTitle: "夺命尘土", crisisDesc: "重型运输车辆日夜穿梭在狭窄的乡村土路上，既没有减速也没有洒水降尘。扬起的漫天尘土让路边的庄稼减产，晾晒的衣服变黑。更糟糕的是，一辆超速的运桩车在校门口撞死了一头耕牛后逃逸，险些伤及放学的儿童，引发了村民的暴动。" },
          { id: 'mp9', label: '职业健康与安全计划 (OHS)', cost: 20, crisisTitle: "高空坠落", crisisDesc: "在输电线路铁塔组立过程中，一名年轻工人在未系安全带的情况下在20米高空作业，不慎踩空坠落致残。调查发现，现场不仅没有安全网，连基本的安全帽都配备不足。工友们拒绝复工，家属抬着伤者堵在项目部经理办公室门口。" },
          { id: 'mp10', label: '文化遗产管理计划 (CHMP)', cost: 20, crisisTitle: "祖灵的愤怒", crisisDesc: "挖掘机在平整变电站用地时，意外挖出了一处未被记录的古代部族墓葬群。施工方为了不耽误工期，试图连夜将骨殖和陪葬陶罐掩埋到别处。此事被路过的村民发现，认为这惊扰了祖灵，将给村庄带来灾祸，全村人点起火把围困了工地。" },
          { id: 'mp11', label: '利益相关方参与计划 (SEP)', cost: 20, crisisTitle: "被遗忘的声音", crisisDesc: "由于地形原因，项目方微调了输电线路走向，铁塔距离一所小学仅50米。但项目方认为这在技术规范内，未及时告知学校和家长。直到基坑开挖，家长们才惊恐地发现高压线将跨越操场，纷纷把孩子接回家并封锁了学校大门抗议。" },
        ];

        const INITIAL_STATES = {
          owner: { money: 500, reputation: 100, label: '业主' },
          gov: { cost: 0, reputation: 100, label: '政府' },
          mdb: { cost: 0, reputation: 100, label: '多边开发银行' },
          epc: { money: 200, reputation: 100, label: 'EPC承包商' },
          ngo: { benefit: 50, reputation: 100, label: '公众' }
        };

        // ==========================================
        // 4. 页面组件与游戏逻辑
        // ==========================================

        const ProjectIntroView = ({ onStart, mode, assignedRole }) => {
            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 overflow-y-auto pb-10">
                    <div className="max-w-5xl mx-auto p-6 md:p-12">
                        <div className="mb-8 animate-in slide-in-from-top-5 duration-700">
                            <div className="flex items-center gap-3 mb-4">
                                 <Activity size={32} className="text-blue-600"/>
                                 <Badge variant="outline" className="text-sm px-3 py-1 border-blue-200 text-blue-700 bg-blue-50">Project Background</Badge>
                            </div>
                            <h1 className="text-4xl md:text-5xl font-black text-slate-900 mb-4 leading-tight tracking-tight">{PROJECT_INFO.name}</h1>
                            <div className="flex flex-wrap gap-4 text-sm text-slate-500 font-medium">
                                <div className="flex items-center gap-1"><MapPin size={16}/> {PROJECT_INFO.location}</div>
                                <div className="flex items-center gap-2 text-orange-700 font-bold bg-orange-50 px-3 py-1 rounded border border-orange-200 shadow-sm">
                                    <Clock size={16}/> {PROJECT_INFO.timeline}
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                             <Card className="md:col-span-2 border-0 shadow-lg bg-white overflow-hidden">
                                <div className="h-2 bg-blue-500"></div>
                                <CardHeader>
                                    <CardTitle className="flex items-center gap-2 text-xl"><FileText className="text-blue-500"/> 项目背景与挑战</CardTitle>
                                </CardHeader>
                                <CardContent className="space-y-4 text-slate-600 leading-relaxed">
                                    <p>{PROJECT_INFO.background}</p>
                                    <div className="p-4 bg-slate-50 rounded-lg border border-slate-100 italic text-slate-700">
                                        <span className="font-bold text-blue-600 not-italic block mb-2">核心任务:</span>
                                        "{PROJECT_INFO.mission}"
                                    </div>
                                </CardContent>
                             </Card>

                             <div className="space-y-6">
                                <Card className="border-0 shadow-md bg-blue-600 text-white">
                                    <CardHeader>
                                        <CardTitle className="text-lg flex items-center gap-2"><Target size={20}/> 项目建设内容</CardTitle>
                                    </CardHeader>
                                    <CardContent>
                                        <ul className="space-y-2 text-sm text-blue-50">
                                            {PROJECT_INFO.scope_items.map((item, i) => (
                                                <li key={i} className="flex items-start gap-2">
                                                    <span className="mt-1 w-1.5 h-1.5 bg-blue-300 rounded-full shrink-0"></span>
                                                    <span>{item}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </CardContent>
                                </Card>
                             </div>
                        </div>
                        
                        <div className="flex justify-center">
                             <Button size="lg" onClick={onStart} className="h-14 px-8 text-lg bg-slate-900 hover:bg-slate-800 text-white shadow-xl hover:shadow-2xl transition-all rounded-full flex items-center gap-2 animate-bounce">
                                下一步：查看角色档案 <ArrowRight size={20}/>
                             </Button>
                        </div>
                        
                        <div className="text-center text-slate-400 text-xs mt-8">
                            {mode === 'multi' && assignedRole ? `当前身份: ${INITIAL_STATES[assignedRole].label}` : "单机模式"}
                        </div>
                    </div>
                </div>
            );
        };

        const RoleDetailView = ({ onStartGame, isGameRunning, onBackToGame }) => {
            return (
                <div className="min-h-screen bg-slate-100 font-sans p-4 md:p-8 overflow-y-auto">
                    <div className="max-w-6xl mx-auto">
                        <div className="flex items-center justify-between mb-8">
                             <div>
                                <h1 className="text-3xl font-black text-slate-800">角色档案</h1>
                             </div>
                             {isGameRunning ? (
                                 <Button onClick={onBackToGame} variant="outline" className="border-slate-300 bg-white hover:bg-slate-50 text-slate-700">
                                    <Reply className="mr-2" size={16}/> 返回游戏
                                 </Button>
                             ) : (
                                 <Button onClick={onStartGame} size="lg" className="bg-green-600 hover:bg-green-700 text-white shadow-lg">
                                    <Zap className="mr-2" size={16}/> 进入游戏
                                 </Button>
                             )}
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                             {Object.keys(ROLE_DETAILS).map(key => {
                                 const role = ROLE_DETAILS[key];
                                 const IconC = role.icon;
                                 return (
                                     <Card key={key} className="border-0 shadow-md overflow-hidden hover:shadow-xl transition-all duration-300 group">
                                         <div className={`h-2 ${role.color.split(' ')[0].replace('text','bg')}`}></div>
                                         <CardHeader className="pb-2">
                                             <div className="flex justify-between items-start">
                                                 <div className={`p-2 rounded-lg ${role.color} bg-opacity-20`}>
                                                     <IconC size={24} className={role.color.split(' ')[0]}/>
                                                 </div>
                                                 <Badge variant="outline" className="text-slate-400">{role.label}</Badge>
                                             </div>
                                             <CardTitle className="text-xl mt-4">{role.label}</CardTitle>
                                             <div className="text-sm font-medium text-slate-500">{role.desc}</div>
                                         </CardHeader>
                                         <CardContent className="text-sm text-slate-600 space-y-4">
                                             <div className="bg-slate-50 p-3 rounded border border-slate-100">
                                                 <span className="font-bold text-slate-800 block mb-1">核心诉求:</span>
                                                 {role.task}
                                             </div>
                                         </CardContent>
                                     </Card>
                                 )
                             })}
                        </div>
                    </div>
                </div>
            )
        };

        // ==========================================
        // 5. 游戏核心容器 (逻辑层)
        // ==========================================

        const GameEntryWrapper = ({ children }) => {
            const [sdkReady, setSdkReady] = useState(false);
            const [appState, setAppState] = useState('cover'); 
            const [mode, setMode] = useState('single'); 
            const [roomNumber, setRoomNumber] = useState(''); 
            const [playerName, setPlayerName] = useState('');
            const [lobbyStatus, setLobbyStatus] = useState('login'); 
            const [roomPlayers, setRoomPlayers] = useState([]);
            const [myRole, setMyRole] = useState(null);
            
            // Ref for polling interval
            const pollingRef = useRef(null);

            useEffect(() => {
                if (window.AV && !sdkReady) {
                     try {
                         if (!window.AV.applicationId) {
                            window.AV.init({
                                appId: "oxljnef7788g0vxPG8KFVbov-MdYXbMMI",
                                appKey: "w3iUN3cMVOVBaPAMh96Dr2VX",
                                serverURL: "https://oxljnef7.api.lncldglobal.com" 
                             });
                         }
                         setSdkReady(true);
                    } catch(e) { console.error(e); setSdkReady(true); } 
                }
            }, []);

            // 大厅轮询逻辑 (Lobby Polling)
            useEffect(() => {
                if (lobbyStatus !== 'waiting' || !roomNumber || !sdkReady) {
                    if (pollingRef.current) clearInterval(pollingRef.current);
                    return;
                }
                const AV = window.AV;
                const rNum = parseInt(roomNumber);
                
                const poll = async () => {
                    try {
                        // 拉取玩家列表
                        const pQuery = new AV.Query('GamePlayer');
                        pQuery.equalTo('room', rNum);
                        pQuery.ascending('createdAt');
                        const players = await pQuery.find();
                        setRoomPlayers(players.map(p => ({
                            name: p.get('name'),
                            role: p.get('role'),
                            id: p.id
                        })));

                        // 检查游戏是否开始 (检查是否有 SYNC_STATE_FULL 动作)
                        const aQuery = new AV.Query('GameAction');
                        aQuery.equalTo('room', rNum);
                        aQuery.equalTo('type', 'SYNC_STATE_FULL');
                        aQuery.descending('createdAt');
                        const latestAction = await aQuery.first();
                        if (latestAction) {
                            const payload = latestAction.get('payload');
                            if (payload && payload.stage >= 1) {
                                setAppState('playing');
                            }
                        }
                    } catch (e) { console.warn(e); }
                };

                poll();
                pollingRef.current = setInterval(poll, 2000); 
                return () => clearInterval(pollingRef.current);
            }, [lobbyStatus, roomNumber, sdkReady]);

            const enterRoomReal = async () => {
                if (!sdkReady) return;
                const AV = window.AV;
                const rNum = parseInt(roomNumber); 
                if (!playerName.trim() || isNaN(rNum)) return alert("请输入有效信息");

                try {
                    setLobbyStatus('waiting');
                    const query = new AV.Query('GamePlayer');
                    query.equalTo('room', rNum); 
                    const existingPlayers = await query.find(); 
                    const existingMe = existingPlayers.find(p => p.get('name') === playerName);
                    if (existingMe) setMyRole(existingMe.get('role')); 
                    setRoomPlayers(existingPlayers.map(p => ({ name: p.get('name'), role: p.get('role') })));
                } catch (error) {
                    console.error(error); setLobbyStatus('login');
                }
            };

            const selectRole = async (roleToSelect) => {
                if (!sdkReady) return;
                const AV = window.AV;
                if (myRole) return; 
                try {
                    const GamePlayer = AV.Object.extend('GamePlayer');
                    const player = new GamePlayer();
                    player.set('room', parseInt(roomNumber));
                    player.set('name', playerName);
                    player.set('role', roleToSelect);
                    const acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); player.setACL(acl);
                    await player.save();
                    setMyRole(roleToSelect);
                } catch (e) { alert("角色可能已被占用"); }
            };

            const startGame = async () => {
                if (myRole === 'owner' && mode === 'multi') {
                    try {
                       const AV = window.AV;
                       const Action = AV.Object.extend('GameAction');
                       const act = new Action();
                       act.set('room', parseInt(roomNumber));
                       act.set('type', 'SYNC_STATE_FULL');
                       act.set('payload', { 
                           stage: 1, 
                           activeRole: 'owner', 
                           s1State: 'owner_draft',
                           logs: [{msg: '游戏开始，进入立项审批阶段。', type: 'info', time: '00:00'}]
                       });
                       await act.save();
                    } catch (e) {}
                }
                setAppState('playing');
            };

            if (!sdkReady) return <div className="min-h-screen bg-slate-900 flex items-center justify-center text-white">初始化云服务...</div>;

            // --- 渲染逻辑 ---

            if (appState === 'cover') {
                return (
                  <div className="min-h-screen flex flex-col items-center justify-center bg-slate-900 text-white p-8">
                      <div className="mb-8 animate-in slide-in-from-top-5">
                          <Activity size={64} className="mx-auto text-blue-500 mb-4"/>
                          <h1 className="text-5xl font-black text-center tracking-tighter">SunLink ESG <br/><span className="text-blue-500">Simulator</span></h1>
                      </div>
                      <div className="flex gap-6">
                          <Button size="lg" className="bg-blue-600 h-16 text-xl px-8 shadow-[0_0_20px_rgba(37,99,235,0.5)] hover:shadow-[0_0_40px_rgba(37,99,235,0.7)] transition-all" onClick={() => { setMode('single'); setAppState('single_intro'); }}>单机体验</Button>
                          <Button size="lg" className="bg-purple-600 h-16 text-xl px-8 shadow-[0_0_20px_rgba(147,51,234,0.5)] hover:shadow-[0_0_40px_rgba(147,51,234,0.7)] transition-all" onClick={() => { setMode('multi'); setAppState('multi_lobby'); }}>多人联机</Button>
                      </div>
                  </div>
                );
            }
            
            if (appState === 'single_intro') return <div className="h-screen w-screen bg-slate-900 flex flex-col overflow-hidden">{React.cloneElement(children, { assignedRole: null, mode: 'single', initialViewMode: 'intro', onExit: () => setAppState('cover') })}</div>;
            if (appState === 'multi_intro') return <div className="h-screen w-screen bg-slate-900 flex flex-col overflow-hidden">{React.cloneElement(children, { assignedRole: myRole, mode: 'multi', initialViewMode: 'intro_only', onNext: () => setAppState('multi_roles'), onExit: () => setAppState('cover') })}</div>;
            if (appState === 'multi_roles') return <div className="h-screen w-screen bg-slate-900 flex flex-col overflow-hidden">{React.cloneElement(children, { assignedRole: myRole, mode: 'multi', initialViewMode: 'roles_only', onNext: startGame, onExit: () => setAppState('cover') })}</div>;

            if (appState === 'multi_lobby') {
                if (lobbyStatus === 'login') {
                    return (
                      <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                          <Card className="w-full max-w-md bg-white/95 backdrop-blur">
                              <CardHeader><CardTitle className="text-center">多人大厅</CardTitle></CardHeader>
                              <CardContent className="space-y-4">
                                  <Input placeholder="您的昵称" value={playerName} onChange={e=>setPlayerName(e.target.value)} className="h-12 text-lg"/>
                                  <Input type="number" placeholder="房间号 (1-999)" value={roomNumber} onChange={e=>setRoomNumber(e.target.value)} className="h-12 text-lg"/>
                                  <Button className="w-full h-12 text-lg bg-purple-600 hover:bg-purple-700" onClick={enterRoomReal}>进入房间</Button>
                                  <Button variant="ghost" className="w-full" onClick={()=>setAppState('cover')}>返回</Button>
                              </CardContent>
                          </Card>
                      </div>
                    )
                }
                return (
                   <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                      <Card className="w-full max-w-5xl bg-white/95 backdrop-blur min-h-[500px]">
                         <CardHeader className="text-center border-b"><CardTitle className="text-2xl">房间 #{roomNumber} - 选择您的角色</CardTitle></CardHeader>
                         <CardContent className="p-8">
                             <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                                {ROLE_ORDER.map((role) => {
                                   const player = roomPlayers.find(p => p.role === role);
                                   const isMe = myRole === role;
                                   const RoleIcon = INITIAL_STATES[role].icon || User;
                                   return (
                                      <div key={role} onClick={() => !player && selectRole(role)} 
                                           className={`relative p-4 border-2 rounded-xl text-center cursor-pointer h-48 flex flex-col items-center justify-center transition-all duration-200 
                                           ${player ? 'bg-slate-100 border-slate-200 opacity-60' : 'bg-white border-slate-200 hover:border-purple-500 hover:shadow-lg hover:-translate-y-1'} 
                                           ${isMe ? 'ring-4 ring-purple-500 ring-offset-2 border-purple-500 bg-purple-50 opacity-100' : ''}`}>
                                         <div className={`p-3 rounded-full mb-3 ${player ? 'bg-slate-300' : isMe ? 'bg-purple-500 text-white' : 'bg-slate-100 text-slate-600'}`}>
                                            <RoleIcon size={32}/>
                                         </div>
                                         <div className="font-bold text-lg mb-1">{INITIAL_STATES[role].label}</div>
                                         {player ? <Badge variant="secondary" className="mt-2">{player.name}</Badge> : <span className="text-xs text-slate-400 mt-2">点击选择</span>}
                                         {isMe && <div className="absolute top-2 right-2 text-purple-600"><CheckCircle2 size={20}/></div>}
                                      </div>
                                   )
                                })}
                             </div>
                             <div className="mt-12 flex justify-center">
                                {myRole ? 
                                    <Button className="w-64 h-16 text-xl bg-green-600 hover:bg-green-700 shadow-lg animate-pulse" onClick={() => setAppState('multi_intro')}>
                                        我是 {INITIAL_STATES[myRole].label}，准备就绪！
                                    </Button> 
                                    : <div className="text-slate-400 italic">请点击上方卡片选择一个角色...</div>
                                }
                             </div>
                         </CardContent>
                      </Card>
                   </div>
                );
            }

            if (appState === 'playing') {
               return React.cloneElement(children, { assignedRole: myRole, mode: mode, roomNumber: roomNumber, playerList: roomPlayers, initialViewMode: 'game', onExit: () => setAppState('cover')});
            }
            return null;
        };

        const TransitionOverlay = ({ isVisible, stageTitle, onComplete }) => {
            useEffect(() => {
                if (isVisible) {
                    const timer = setTimeout(onComplete, 2000);
                    return () => clearTimeout(timer);
                }
            }, [isVisible]); 

            if (!isVisible) return null;

            return (
                <div className="absolute inset-0 z-[100] bg-black/95 flex flex-col items-center justify-center text-white animate-in fade-in duration-300">
                    <div className="flex items-center gap-4 mb-6">
                        <Loader2 size={48} className="animate-spin text-blue-500"/>
                        <h2 className="text-4xl font-bold tracking-tight">阶段切换中...</h2>
                    </div>
                    <div className="text-2xl text-blue-400 font-mono animate-pulse">{stageTitle}</div>
                </div>
            );
        };

        // ==========================================
        // 6. 主游戏逻辑组件 (SunLinkESGSimV9)
        // ==========================================
        
        function SunLinkESGSimV9({ assignedRole, mode, onExit, onNext, roomNumber, playerList, initialViewMode }) {
            const [viewMode, setViewMode] = useState('intro'); 
            
            // --- 全局状态 ---
            const [stage, setStage] = useState(1);
            const [activeRole, setActiveRole] = useState('owner');
            const [logs, setLogs] = useState([]);
            const [playerState, setPlayerState] = useState(INITIAL_STATES); // 包含资金、声誉等
            
            // --- Stage 1: 立项审批 ---
            const [s1State, setS1State] = useState('owner_draft'); // owner_draft -> ngo_eval -> gov_review
            const [ownerEsiaSelection, setOwnerEsiaSelection] = useState([]);
            const [ngoRequirements, setNgoRequirements] = useState([]);

            // --- Stage 2: 项目融资 ---
            const [s2State, setS2State] = useState('idle'); // owner_apply -> mdb_risk -> owner_escp
            const [riskLevel, setRiskLevel] = useState(null); // Low, Medium, High
            const [escpTerms, setEscpTerms] = useState([]);

            // --- Stage 3: 合同谈判 ---
            const [s3State, setS3State] = useState('idle'); // owner_tender -> epc_bid -> owner_award
            const [ownerRespEsmp, setOwnerRespEsmp] = useState([]); // Owner 保留的 ESMP
            const [epcBidPrice, setEpcBidPrice] = useState(1000);

            // --- Stage 4: 建设与危机 ---
            const [s4State, setS4State] = useState('idle'); // construction -> crisis_happening -> resolved
            const [currentCrisis, setCurrentCrisis] = useState(null);
            const [crisisHistory, setCrisisHistory] = useState([]);

            // --- 系统控制 ---
            const [isTransitioning, setIsTransitioning] = useState(false);
            const [transitionContext, setTransitionContext] = useState({});
            const pollingRef = useRef(null);

            useEffect(() => {
                if (initialViewMode) setViewMode(initialViewMode);
                if (mode === 'single' && !initialViewMode) setViewMode('intro');
            }, [mode, initialViewMode]);

            // ==========================================
            // 同步核心 (Sync Core)
            // ==========================================
            useEffect(() => {
                if (mode !== 'multi' || !roomNumber) return;
                const AV = window.AV;

                const applyState = (data) => {
                    if(!data) return;
                    if(data.stage !== undefined) setStage(data.stage);
                    if(data.activeRole !== undefined) setActiveRole(data.activeRole);
                    if(data.logs !== undefined) setLogs(data.logs);
                    if(data.playerState !== undefined) setPlayerState(data.playerState);
                    
                    // S1
                    if(data.s1State !== undefined) setS1State(data.s1State);
                    if(data.ownerEsiaSelection !== undefined) setOwnerEsiaSelection(data.ownerEsiaSelection);
                    if(data.ngoRequirements !== undefined) setNgoRequirements(data.ngoRequirements);
                    
                    // S2
                    if(data.s2State !== undefined) setS2State(data.s2State);
                    if(data.riskLevel !== undefined) setRiskLevel(data.riskLevel);
                    
                    // S3
                    if(data.s3State !== undefined) setS3State(data.s3State);
                    if(data.epcBidPrice !== undefined) setEpcBidPrice(data.epcBidPrice);

                    // S4
                    if(data.s4State !== undefined) setS4State(data.s4State);
                    if(data.currentCrisis !== undefined) setCurrentCrisis(data.currentCrisis);
                };

                const pollState = async () => {
                    try {
                        const q = new AV.Query('GameAction');
                        q.equalTo('room', parseInt(roomNumber));
                        q.equalTo('type', 'SYNC_STATE_FULL');
                        q.descending('createdAt');
                        const latestAction = await q.first();
                        if (latestAction) applyState(latestAction.get('payload'));
                    } catch (e) {}
                };
                pollState();
                pollingRef.current = setInterval(pollState, 1500); // 1.5s 心跳同步
                return () => clearInterval(pollingRef.current);
            }, [mode, roomNumber]);

            const syncToCloud = (overrides) => {
                if (mode !== 'multi') return;
                const AV = window.AV;
                const Action = AV.Object.extend('GameAction');
                const act = new Action();
                
                const payload = {
                    stage: overrides.stage !== undefined ? overrides.stage : stage,
                    activeRole: overrides.activeRole !== undefined ? overrides.activeRole : activeRole,
                    logs: overrides.logs !== undefined ? overrides.logs : logs,
                    playerState: overrides.playerState !== undefined ? overrides.playerState : playerState,
                    
                    s1State: overrides.s1State !== undefined ? overrides.s1State : s1State,
                    ownerEsiaSelection: overrides.ownerEsiaSelection !== undefined ? overrides.ownerEsiaSelection : ownerEsiaSelection,
                    ngoRequirements: overrides.ngoRequirements !== undefined ? overrides.ngoRequirements : ngoRequirements,
                    
                    s2State: overrides.s2State !== undefined ? overrides.s2State : s2State,
                    riskLevel: overrides.riskLevel !== undefined ? overrides.riskLevel : riskLevel,
                    
                    s3State: overrides.s3State !== undefined ? overrides.s3State : s3State,
                    epcBidPrice: overrides.epcBidPrice !== undefined ? overrides.epcBidPrice : epcBidPrice,

                    s4State: overrides.s4State !== undefined ? overrides.s4State : s4State,
                    currentCrisis: overrides.currentCrisis !== undefined ? overrides.currentCrisis : currentCrisis
                };

                act.set('room', parseInt(roomNumber));
                act.set('type', 'SYNC_STATE_FULL');
                act.set('payload', payload);
                act.save();
            };

            // ---------------------------
            // 逻辑辅助函数
            // ---------------------------
            const addLog = (msg, type='info') => {
                const timeStr = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                const newLogs = [...logs, {msg, type, time: timeStr}];
                setLogs(newLogs);
                return newLogs;
            };

            const updateStat = (role, key, delta) => {
                const newState = { ...playerState, [role]: { ...playerState[role], [key]: playerState[role][key] + delta } };
                setPlayerState(newState);
                return newState;
            };

            const triggerStageTransition = (target, title) => {
                setIsTransitioning(true);
                setTransitionContext({ target, title });
            };

            const completeTransition = () => {
                setIsTransitioning(false);
                const newStage = transitionContext.target;
                let newActiveRole = activeRole;
                let newLogs = logs;
                
                // 初始化下一阶段的状态
                if (newStage === 2) {
                    newActiveRole = 'owner';
                    setS2State('owner_apply');
                    newLogs = addLog(">>> 进入阶段2：项目融资。请业主申请贷款。", 'blue');
                } else if (newStage === 3) {
                    newActiveRole = 'owner';
                    setS3State('owner_tender');
                    newLogs = addLog(">>> 进入阶段3：合同谈判。请业主发布招标文件。", 'purple');
                } else if (newStage === 4) {
                    newActiveRole = 'epc';
                    setS4State('construction');
                    newLogs = addLog(">>> 进入阶段4：项目建设。模拟开始。", 'orange');
                    // 自动触发第一个危机演示
                    setTimeout(() => startCrisisLoop(newLogs), 1000);
                    if(mode === 'multi') syncToCloud({ stage: newStage, activeRole: newActiveRole, logs: newLogs, s4State: 'construction' });
                    setStage(newStage);
                    setActiveRole(newActiveRole);
                    return;
                } else if (newStage === 5) {
                    newActiveRole = 'all';
                    newLogs = addLog(">>> 项目结束。进入验收阶段。", 'green');
                }

                setStage(newStage);
                setActiveRole(newActiveRole);
                if (mode === 'multi') syncToCloud({ stage: newStage, activeRole: newActiveRole, logs: newLogs });
            };

            const startCrisisLoop = (currentLogs) => {
                const crisis = ESMP_LIBRARY[0]; // Demo: Trigger GBV Crisis
                setStage(4);
                setS4State('crisis_happening');
                setCurrentCrisis(crisis);
                setActiveRole('epc');
                const logsWithCrisis = [...currentLogs, {msg: `!!! 突发危机：[${crisis.crisisTitle}] ${crisis.crisisDesc}`, type: 'red', time: '紧急'}];
                setLogs(logsWithCrisis);
                if(mode === 'multi') syncToCloud({ stage: 4, s4State: 'crisis_happening', activeRole: 'epc', currentCrisis: crisis, logs: logsWithCrisis });
            };

            // ---------------------------
            // 业务逻辑处理 (Handlers)
            // ---------------------------

            // --- Stage 1 ---
            const handleS1OwnerSubmit = () => {
                if(ownerEsiaSelection.length === 0) return alert("请至少选择一项！");
                const cost = ownerEsiaSelection.length * 5;
                const newState = updateStat('owner', 'money', -cost);
                const newLogs = addLog(`业主提交ESIA方案（${ownerEsiaSelection.length}项），花费$${cost}。等待公众评估。`, 'blue');
                setS1State('ngo_eval');
                setActiveRole('ngo');
                if (mode === 'multi') syncToCloud({ playerState: newState, logs: newLogs, s1State: 'ngo_eval', activeRole: 'ngo' });
            };

            const handleS1NgoEval = (protest) => {
                let newLogs;
                let newState = playerState;
                const reqs = protest ? ESIA_ITEMS.filter(i => !ownerEsiaSelection.includes(i.id)).slice(0, 3).map(i=>i.id) : [];
                setNgoRequirements(reqs);
                
                if (protest) {
                    newState = updateStat('ngo', 'reputation', 10); // NGO 获得声望
                    newLogs = addLog(`公众对方案不满发起抗议！要求补充 ${reqs.length} 项评估。`, 'red');
                } else {
                    newLogs = addLog(`公众对方案无异议。等待政府审批。`, 'green');
                }
                setS1State('gov_review');
                setActiveRole('gov');
                if (mode === 'multi') syncToCloud({ playerState: newState, logs: newLogs, s1State: 'gov_review', activeRole: 'gov', ngoRequirements: reqs });
            };

            const handleS1GovReview = (approve) => {
                let newLogs;
                if (approve) {
                    newLogs = addLog("政府批准立项！进入融资阶段。", "green");
                    if(mode === 'multi') syncToCloud({ logs: newLogs }); // 触发转换
                    triggerStageTransition(2, "立项通过 -> 项目融资");
                } else {
                    newLogs = addLog("政府驳回立项，要求业主修改方案。", "red");
                    setS1State('owner_draft');
                    setActiveRole('owner');
                    if(mode === 'multi') syncToCloud({ logs: newLogs, s1State: 'owner_draft', activeRole: 'owner' });
                }
            };

            // --- Stage 2 ---
            const handleS2OwnerApply = () => {
                const newLogs = addLog("业主向世界基础设施银行(WIB)提交 $1500万 贷款申请。", "blue");
                setS2State('mdb_risk');
                setActiveRole('mdb');
                if(mode === 'multi') syncToCloud({ logs: newLogs, s2State: 'mdb_risk', activeRole: 'mdb' });
            };

            const handleS2MdbRisk = (level) => {
                setRiskLevel(level);
                const newLogs = addLog(`银行完成风险评估：等级为 [${level}]。`, "purple");
                // 简化：直接通过并进入下一阶段
                if(mode === 'multi') syncToCloud({ logs: newLogs, riskLevel: level });
                triggerStageTransition(3, "融资完成 -> 合同谈判");
            };

            // --- Stage 3 ---
            const handleS3OwnerTender = () => {
                const newLogs = addLog("业主发布 EPC 招标文件，并附带 ESMP 要求。", "blue");
                setS3State('epc_bid');
                setActiveRole('epc');
                if(mode === 'multi') syncToCloud({ logs: newLogs, s3State: 'epc_bid', activeRole: 'epc' });
            };

            const handleS3EpcBid = () => {
                const bid = 1200;
                setEpcBidPrice(bid);
                const newLogs = addLog(`EPC 承包商提交报价：$${bid} 万。`, "orange");
                setS3State('owner_award');
                setActiveRole('owner');
                if(mode === 'multi') syncToCloud({ logs: newLogs, s3State: 'owner_award', activeRole: 'owner', epcBidPrice: bid });
            };

            const handleS3OwnerAward = () => {
                const newLogs = addLog("业主授标，双方签署合同。准备开工。", "green");
                if(mode === 'multi') syncToCloud({ logs: newLogs });
                triggerStageTransition(4, "合同签署 -> 项目建设");
            };

            // --- Stage 4 (Crisis) ---
            const handleS4EpcSolve = (method) => {
                let newState = playerState;
                let newLogs;
                
                if (method === 'fix') {
                    const cost = 20;
                    newState = updateStat('epc', 'money', -cost);
                    newState = updateStat('epc', 'reputation', 5);
                    newLogs = addLog(`EPC 花费 $${cost} 妥善解决了危机。危机解除。`, "green");
                } else {
                    newState = updateStat('owner', 'reputation', -20);
                    newState = updateStat('gov', 'reputation', -10);
                    newLogs = addLog("EPC 选择忽视/强硬压制。危机升级！业主与政府声誉受损。", "red");
                }
                
                setS4State('resolved');
                setActiveRole('owner'); // 交还给 Owner 结束演示
                if(mode === 'multi') syncToCloud({ playerState: newState, logs: newLogs, s4State: 'resolved', activeRole: 'owner' });
                
                // 演示结束逻辑
                setTimeout(() => triggerStageTransition(5, "建设完成 -> 验收"), 2000);
            };

            // ---------------------------
            // 视图渲染 (Render Helpers)
            // ---------------------------
            const renderTopBar = () => (
                <div className="h-14 bg-white border-b flex justify-between items-center px-4 shadow-sm relative z-20 shrink-0">
                  <div className="flex items-center gap-2 font-bold text-lg text-slate-800"><Activity className="text-blue-600"/> SunLink Sim v9.0</div>
                  <div className="flex items-center gap-4">
                      <div className="text-xs bg-slate-100 px-3 py-1 rounded-full border border-slate-200 hidden md:block">
                          <span className="font-bold text-slate-500 mr-2">MODE:</span> 
                          <span className="text-blue-600 uppercase">{mode}</span>
                          <span className="mx-2 text-slate-300">|</span>
                          <span className="font-bold text-slate-500 mr-2">ROLE:</span> 
                          <span className="text-purple-600 font-bold">{assignedRole ? INITIAL_STATES[assignedRole].label : 'Guest'}</span>
                          {roomNumber && <><span className="mx-2 text-slate-300">|</span>ROOM: {roomNumber}</>}
                      </div>
                      <Button variant="outline" size="sm" onClick={() => setViewMode(viewMode==='roles'?'game':'roles')}>
                          {viewMode==='roles' ? "返回游戏" : "查看档案"} 
                      </Button>
                  </div>
                </div>
            );

            const isMyTurn = mode === 'single' || activeRole === assignedRole;

            // --- Root Render ---
            if (viewMode === 'intro') return <ProjectIntroView onStart={()=>setViewMode('roles')} mode={mode} assignedRole={assignedRole} />;
            if (viewMode === 'roles') return <RoleDetailView onStartGame={() => {
                setViewMode('game');
                if (mode==='single' && stage===1) triggerStageTransition(1, "游戏开始：立项审批");
                else onNext();
            }} isGameRunning={stage>1} onBackToGame={()=>setViewMode('game')} />;

            return (
                <div className="h-full w-full bg-slate-100 flex flex-col font-sans relative h-screen overflow-hidden">
                  {renderTopBar()}
                  <TransitionOverlay isVisible={isTransitioning} stageTitle={transitionContext.title} onComplete={completeTransition} />
                  
                  <div className="flex flex-1 overflow-hidden">
                      {/* LEFT PANEL: Dashboard */}
                      <div className="w-1/3 min-w-[320px] max-w-[400px] bg-white border-r flex flex-col z-10 shadow-xl">
                          {/* Progress Header */}
                          <div className="p-4 bg-slate-50 border-b">
                              <div className="flex justify-between items-end mb-2">
                                  <div className="text-sm font-bold text-slate-500 uppercase">Stage {stage}/5</div>
                                  <Badge className={`${INITIAL_STATES[activeRole].color} px-3 py-1`}>{INITIAL_STATES[activeRole].label} Turn</Badge>
                              </div>
                              <Progress value={(stage/5)*100} className="h-3 bg-slate-200" />
                              <div className="mt-4 grid grid-cols-2 gap-3">
                                  <div className="p-3 bg-blue-50 rounded border border-blue-100">
                                      <div className="text-xs text-blue-400 font-bold uppercase">Owner Funds</div>
                                      <div className="text-lg font-mono font-bold text-blue-700">${playerState.owner.money}</div>
                                  </div>
                                  <div className="p-3 bg-orange-50 rounded border border-orange-100">
                                      <div className="text-xs text-orange-400 font-bold uppercase">EPC Funds</div>
                                      <div className="text-lg font-mono font-bold text-orange-700">${playerState.epc.money}</div>
                                  </div>
                                  <div className="p-3 bg-green-50 rounded border border-green-100">
                                      <div className="text-xs text-green-600 font-bold uppercase">Gov Reputation</div>
                                      <div className="text-lg font-mono font-bold text-green-800">{playerState.gov.reputation}</div>
                                  </div>
                                  <div className="p-3 bg-red-50 rounded border border-red-100">
                                      <div className="text-xs text-red-500 font-bold uppercase">Public Support</div>
                                      <div className="text-lg font-mono font-bold text-red-700">{playerState.ngo.benefit}</div>
                                  </div>
                              </div>
                          </div>
                          
                          {/* Logs Area */}
                          <div className="flex-1 flex flex-col min-h-0 bg-slate-100/50">
                              <div className="py-2 px-4 bg-white border-b text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                  <ScrollText size={14}/> Action Log
                              </div>
                              <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                  {logs.length === 0 && <div className="text-center text-slate-400 mt-10 italic">等待游戏开始...</div>}
                                  {logs.slice().reverse().map((l, i) => (
                                      <div key={i} className={`p-3 rounded-lg border shadow-sm text-sm animate-in slide-in-from-left-2 
                                          ${l.type==='red'?'bg-red-50 border-red-200 text-red-800':
                                            l.type==='green'?'bg-green-50 border-green-200 text-green-800':
                                            l.type==='blue'?'bg-blue-50 border-blue-200 text-blue-800':
                                            l.type==='purple'?'bg-purple-50 border-purple-200 text-purple-800':
                                            l.type==='orange'?'bg-orange-50 border-orange-200 text-orange-800':
                                            'bg-white border-slate-200 text-slate-700'}`}>
                                          <div className="text-[10px] font-mono opacity-50 mb-1">{l.time}</div>
                                          {l.msg}
                                      </div>
                                  ))}
                              </div>
                          </div>
                      </div>

                      {/* RIGHT PANEL: Game Stage Area */}
                      <div className="flex-1 bg-slate-100 flex flex-col relative overflow-hidden">
                          {/* Background Watermark */}
                          <div className="absolute inset-0 flex items-center justify-center opacity-[0.03] pointer-events-none">
                              <Activity size={400} />
                          </div>

                          <div className="flex-1 overflow-y-auto p-8 flex flex-col items-center">
                            {isMyTurn ? (
                                <Card className="w-full max-w-3xl shadow-2xl animate-in slide-in-from-top-5 bg-white/90 backdrop-blur border-0 ring-1 ring-slate-200">
                                    {/* Active Role Header */}
                                    <div className={`h-2 w-full ${INITIAL_STATES[activeRole].color.split(' ')[0].replace('text','bg')}`}></div>
                                    <CardHeader className="border-b bg-slate-50/50 pb-4">
                                        <div className="flex items-center gap-4">
                                            <div className={`p-3 rounded-xl ${INITIAL_STATES[activeRole].color} bg-opacity-10 shadow-inner`}>
                                                {activeRole === 'owner' && <User size={32} />}
                                                {activeRole === 'gov' && <Landmark size={32} />}
                                                {activeRole === 'epc' && <Building2 size={32} />}
                                                {activeRole === 'ngo' && <Users size={32} />}
                                                {activeRole === 'mdb' && <Globe size={32} />}
                                            </div>
                                            <div>
                                                <CardTitle className="text-2xl">轮到你了: {INITIAL_STATES[activeRole].label}</CardTitle>
                                                <div className="text-sm text-slate-500 mt-1 font-medium">{INITIAL_STATES[activeRole].task}</div>
                                            </div>
                                        </div>
                                    </CardHeader>
                                    <CardContent className="p-8 min-h-[400px]">
                                        
                                        {/* === S1 Logic === */}
                                        {stage === 1 && activeRole === 'owner' && (
                                            <div className="space-y-6">
                                                <div className="bg-blue-50 p-4 rounded-lg text-blue-800 text-sm border border-blue-100">
                                                    <h4 className="font-bold mb-2 flex items-center gap-2"><FileText size={16}/> 任务: 制定 ESIA 方案</h4>
                                                    <p>为了获得立项，你需要提交环境社会影响评价 (ESIA) 方案。选的项目越多，成本越高，但越容易通过审批。</p>
                                                </div>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-[400px] overflow-y-auto p-1">
                                                    {ESIA_ITEMS.map(item => (
                                                        <div key={item.id} 
                                                             onClick={() => {
                                                                 if(ownerEsiaSelection.includes(item.id)) setOwnerEsiaSelection(ownerEsiaSelection.filter(i=>i!==item.id));
                                                                 else setOwnerEsiaSelection([...ownerEsiaSelection, item.id]);
                                                             }}
                                                             className={`p-4 border-2 rounded-xl cursor-pointer transition-all duration-200 group relative ${ownerEsiaSelection.includes(item.id)?'bg-blue-600 border-blue-600 text-white shadow-lg transform scale-[1.02]':'bg-white border-slate-200 hover:border-blue-300 hover:bg-slate-50'}`}>
                                                            <div className="flex justify-between items-center mb-1">
                                                                <span className="font-bold">{item.label}</span>
                                                                <Badge variant="secondary" className={ownerEsiaSelection.includes(item.id)?'bg-white/20 text-white':'bg-slate-100'}>${item.cost}</Badge>
                                                            </div>
                                                            <div className={`text-xs ${ownerEsiaSelection.includes(item.id)?'text-blue-100':'text-slate-400'}`}>{item.desc}</div>
                                                            {ownerEsiaSelection.includes(item.id) && <div className="absolute top-2 right-2"><CheckCircle2 size={16}/></div>}
                                                        </div>
                                                    ))}
                                                </div>
                                                <div className="pt-4 border-t flex justify-between items-center">
                                                    <div className="text-sm text-slate-500">已选: <span className="font-bold text-slate-900">{ownerEsiaSelection.length}</span> 项 | 总花费: <span className="font-bold text-red-600">${ownerEsiaSelection.length * 5}</span></div>
                                                    <Button size="lg" className="w-48 shadow-xl bg-blue-600 hover:bg-blue-700" onClick={handleS1OwnerSubmit}>提交方案</Button>
                                                </div>
                                            </div>
                                        )}

                                        {stage === 1 && activeRole === 'ngo' && (
                                            <div className="space-y-6">
                                                <div className="text-center mb-6">
                                                    <h3 className="text-xl font-bold mb-2">业主提交了方案，请审查</h3>
                                                    <p className="text-slate-500 text-sm">如果方案缺失关键项目，你可以选择抗议，但这会延迟项目。</p>
                                                </div>
                                                <div className="bg-slate-50 p-6 rounded-xl border border-slate-200">
                                                    <h4 className="font-bold text-slate-700 mb-4 border-b pb-2">方案内容 ({ownerEsiaSelection.length}项):</h4>
                                                    <div className="flex flex-wrap gap-2">
                                                        {ownerEsiaSelection.length > 0 ? ownerEsiaSelection.map(id => (
                                                            <Badge key={id} variant="secondary" className="px-3 py-1 text-sm bg-white border">{ESIA_ITEMS.find(i=>i.id===id).label}</Badge>
                                                        )) : <span className="text-red-500 italic">未选择任何项目 (极度危险)</span>}
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-6 mt-8">
                                                    <Button variant="destructive" className="h-20 text-lg shadow-lg hover:scale-[1.02] transition-transform" onClick={()=>handleS1NgoEval(true)}>
                                                        <div className="flex flex-col items-center">
                                                            <span className="flex items-center gap-2"><Megaphone size={20}/> 发起抗议</span>
                                                            <span className="text-xs font-normal opacity-80 mt-1">声望 +10, 阻碍项目</span>
                                                        </div>
                                                    </Button>
                                                    <Button className="h-20 text-lg bg-green-600 hover:bg-green-700 shadow-lg hover:scale-[1.02] transition-transform" onClick={()=>handleS1NgoEval(false)}>
                                                        <div className="flex flex-col items-center">
                                                            <span className="flex items-center gap-2"><CheckCircle2 size={20}/> 无异议</span>
                                                            <span className="text-xs font-normal opacity-80 mt-1">项目继续推进</span>
                                                        </div>
                                                    </Button>
                                                </div>
                                            </div>
                                        )}

                                        {stage === 1 && activeRole === 'gov' && (
                                            <div className="space-y-6">
                                                <div className="text-center">
                                                    <h3 className="text-xl font-bold">最终裁决权</h3>
                                                    <p className="text-slate-500">综合业主方案与公众意见，决定项目命运。</p>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div className="p-4 bg-white border rounded-lg shadow-sm">
                                                        <div className="text-xs font-bold text-slate-400 uppercase mb-1">Owner Proposal</div>
                                                        <div className="text-2xl font-bold text-blue-600">{ownerEsiaSelection.length} <span className="text-sm text-slate-500 font-normal">项措施</span></div>
                                                    </div>
                                                    <div className="p-4 bg-white border rounded-lg shadow-sm">
                                                        <div className="text-xs font-bold text-slate-400 uppercase mb-1">Public Sentiment</div>
                                                        {ngoRequirements.length > 0 ? 
                                                            <div className="text-red-600 font-bold flex items-center gap-2"><AlertTriangle size={20}/> 强烈抗议</div> : 
                                                            <div className="text-green-600 font-bold flex items-center gap-2"><CheckCircle2 size={20}/> 支持项目</div>
                                                        }
                                                    </div>
                                                </div>
                                                {ngoRequirements.length > 0 && (
                                                    <div className="bg-red-50 border border-red-100 p-4 rounded text-sm text-red-800">
                                                        <span className="font-bold">公众核心诉求:</span> {ngoRequirements.map(id=>ESIA_ITEMS.find(i=>i.id===id).label).join(', ')}
                                                    </div>
                                                )}
                                                <div className="flex gap-4 mt-4">
                                                    <Button className="flex-1 h-14 bg-green-600 hover:bg-green-700 text-lg shadow-md" onClick={()=>handleS1GovReview(true)}>批准立项 (Approve)</Button>
                                                    <Button className="flex-1 h-14 bg-red-600 hover:bg-red-700 text-lg shadow-md" onClick={()=>handleS1GovReview(false)}>驳回重改 (Reject)</Button>
                                                </div>
                                            </div>
                                        )}

                                        {/* === S2 Logic === */}
                                        {stage === 2 && activeRole === 'owner' && (
                                            <div className="flex flex-col items-center justify-center h-full py-10 space-y-8">
                                                <div className="relative">
                                                    <div className="absolute inset-0 bg-blue-400 blur-xl opacity-20 rounded-full"></div>
                                                    <Banknote size={80} className="text-blue-600 relative z-10"/>
                                                </div>
                                                <div className="text-center max-w-md">
                                                    <h3 className="text-2xl font-bold mb-2">项目资金缺口</h3>
                                                    <p className="text-slate-600">立项已获批。为了启动建设，你需要向世界基础设施银行 (WIB) 申请 <span className="font-bold text-slate-900">$1500 万</span> 专项贷款。</p>
                                                </div>
                                                <Button size="lg" className="w-64 h-14 text-lg bg-blue-600 shadow-xl hover:scale-105 transition-transform" onClick={handleS2OwnerApply}>
                                                    提交贷款申请
                                                </Button>
                                            </div>
                                        )}

                                        {stage === 2 && activeRole === 'mdb' && (
                                            <div className="space-y-6">
                                                <div className="bg-purple-50 p-4 rounded border border-purple-100 text-purple-900 text-sm">
                                                    <h4 className="font-bold mb-2 flex items-center gap-2"><ShieldAlert size={16}/> 风险评估任务</h4>
                                                    <p>作为银行，必须依据《环境社会框架》(ESF) 对项目进行风险分级。风险越高，对业主的监管要求(ESCP)越严苛。</p>
                                                </div>
                                                <div className="grid grid-cols-3 gap-4 h-40">
                                                    <Button variant="destructive" className="h-full flex flex-col items-center justify-center gap-2 hover:bg-red-600" onClick={()=>handleS2MdbRisk('High')}>
                                                        <AlertTriangle size={32}/>
                                                        <span className="text-lg font-bold">高风险 (High)</span>
                                                        <span className="text-xs font-normal opacity-80">生态敏感区/原住民</span>
                                                    </Button>
                                                    <Button className="h-full bg-yellow-500 hover:bg-yellow-600 text-slate-900 flex flex-col items-center justify-center gap-2" onClick={()=>handleS2MdbRisk('Substantial')}>
                                                        <Activity size={32}/>
                                                        <span className="text-lg font-bold">中风险 (Substantial)</span>
                                                        <span className="text-xs font-normal opacity-80">常规污染/劳工问题</span>
                                                    </Button>
                                                    <Button className="h-full bg-green-600 hover:bg-green-700 flex flex-col items-center justify-center gap-2" onClick={()=>handleS2MdbRisk('Low')}>
                                                        <CheckCircle2 size={32}/>
                                                        <span className="text-lg font-bold">低风险 (Low)</span>
                                                        <span className="text-xs font-normal opacity-80">影响微乎其微</span>
                                                    </Button>
                                                </div>
                                            </div>
                                        )}

                                        {/* === S3 Logic === */}
                                        {stage === 3 && activeRole === 'owner' && (
                                            <div className="space-y-8 text-center py-8">
                                                <div className="mx-auto bg-slate-100 p-4 rounded-full w-20 h-20 flex items-center justify-center mb-4">
                                                    <Gavel size={40} className="text-slate-600"/>
                                                </div>
                                                <h3 className="text-2xl font-bold">启动 EPC 招标</h3>
                                                <p className="text-slate-600 max-w-lg mx-auto">资金已到位。现在需要选择总承包商(EPC)。你将在招标文件中附带 ESMP (环境社会管理计划) 要求，这将直接影响承包商的报价。</p>
                                                <Button size="lg" className="w-64 h-14 text-lg" onClick={handleS3OwnerTender}>发布招标文件</Button>
                                            </div>
                                        )}

                                        {stage === 3 && activeRole === 'epc' && (
                                            <div className="space-y-6">
                                                <div className="bg-orange-50 p-5 rounded-xl border border-orange-100">
                                                    <h4 className="text-orange-800 font-bold mb-4">招标文件分析:</h4>
                                                    <div className="space-y-2 text-sm text-orange-900">
                                                        <div className="flex justify-between"><span>预估工程成本:</span> <span>$1000 万</span></div>
                                                        <div className="flex justify-between"><span>ESMP 合规成本:</span> <span>$150 万</span></div>
                                                        <div className="flex justify-between border-t border-orange-200 pt-2 font-bold"><span>建议最低报价:</span> <span>$1150 万</span></div>
                                                    </div>
                                                </div>
                                                <div className="text-center">
                                                    <p className="mb-4 text-slate-600">为了中标并保持利润，你需要制定策略。报价过高可能丢标，过低可能导致后期无力执行ESMP。</p>
                                                    <div className="inline-block p-4 bg-slate-800 text-white rounded-lg font-mono text-2xl mb-6">
                                                        你的最终报价: <span className="text-green-400">$1200 万</span>
                                                    </div>
                                                    <br/>
                                                    <Button className="w-full h-14 text-lg bg-orange-600 hover:bg-orange-700" onClick={handleS3EpcBid}>提交投标文件</Button>
                                                </div>
                                            </div>
                                        )}

                                        {/* === S4 Logic (Crisis) === */}
                                        {stage === 4 && currentCrisis && activeRole === 'epc' && (
                                            <div className="absolute inset-0 z-50 bg-white flex flex-col items-center justify-center p-8 animate-in zoom-in-95 duration-300">
                                                <div className="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mb-6 animate-bounce">
                                                    <AlertTriangle size={48} className="text-red-600"/>
                                                </div>
                                                <h2 className="text-4xl font-black text-slate-900 mb-2">危机爆发!</h2>
                                                <div className="text-xl font-bold text-red-600 mb-6">{currentCrisis.crisisTitle}</div>
                                                <p className="text-lg text-slate-600 text-center max-w-xl mb-10 leading-relaxed">
                                                    {currentCrisis.crisisDesc}
                                                </p>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                                                    <Button className="h-24 text-lg bg-green-600 hover:bg-green-700 shadow-xl hover:-translate-y-1 transition-all" onClick={()=>handleS4EpcSolve('fix')}>
                                                        <div className="text-left w-full px-4">
                                                            <div className="font-bold text-xl mb-1">立刻整改 (Fix)</div>
                                                            <div className="text-sm opacity-80 font-normal">花费 $20，声誉 +5</div>
                                                        </div>
                                                    </Button>
                                                    <Button variant="destructive" className="h-24 text-lg shadow-xl hover:-translate-y-1 transition-all" onClick={()=>handleS4EpcSolve('ignore')}>
                                                        <div className="text-left w-full px-4">
                                                            <div className="font-bold text-xl mb-1">强行压制 (Suppress)</div>
                                                            <div className="text-sm opacity-80 font-normal">花费 $0，业主声誉 -20</div>
                                                        </div>
                                                    </Button>
                                                </div>
                                            </div>
                                        )}

                                        {/* === S5 Logic (End) === */}
                                        {stage === 5 && (
                                            <div className="flex flex-col items-center justify-center h-full text-center py-10">
                                                <Award size={80} className="text-yellow-500 mb-6 animate-pulse"/>
                                                <h2 className="text-3xl font-bold mb-2">模拟结束</h2>
                                                <p className="text-slate-500 mb-8">感谢参与 SunLink ESG 模拟演练。</p>
                                                <div className="grid grid-cols-2 gap-4 text-left w-full max-w-md bg-slate-50 p-6 rounded-xl">
                                                    <div className="text-sm text-slate-500">最终业主资金:</div>
                                                    <div className="font-mono font-bold text-right">${playerState.owner.money}</div>
                                                    <div className="text-sm text-slate-500">最终政府声誉:</div>
                                                    <div className="font-mono font-bold text-right">{playerState.gov.reputation}</div>
                                                </div>
                                                <Button className="mt-8" variant="outline" onClick={() => window.location.reload()}>重新开始</Button>
                                            </div>
                                        )}

                                    </CardContent>
                                </Card>
                            ) : (
                                <div className="flex flex-col items-center justify-center h-full mt-20 opacity-60">
                                    <div className="relative">
                                        <div className="absolute inset-0 bg-slate-200 rounded-full animate-ping opacity-75"></div>
                                        <Loader2 size={64} className="text-slate-400 animate-spin relative z-10"/>
                                    </div>
                                    <h2 className="text-2xl font-bold text-slate-600 mt-8">等待 {INITIAL_STATES[activeRole].label} 操作...</h2>
                                    <p className="text-slate-400 mt-2">请关注左侧日志更新</p>
                                </div>
                            )}
                          </div>
                      </div>
                  </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GameEntryWrapper><SunLinkESGSimV9 /></GameEntryWrapper>);
    </script>
</body>
</html>
