<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SunLink ESG Simulator - TJU - Final Complete</title>
    
    <!-- 1. 核心依赖库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', system-ui, sans-serif; }
        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 滚动条 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        
        /* 加载遮罩 */
        #loading-mask { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; transition: opacity 0.5s; }
    </style>
</head>
<body>
    <div id="loading-mask">
        <div class="text-2xl font-bold mb-2">SunLink ESG Simulator</div>
        <div class="text-sm text-slate-400">正在连接云端服务...</div>
    </div>
    <div id="root"></div>

    <script type="text/babel">
        /********************************************************************************
         * 1. 配置与初始化
         ********************************************************************************/
        const { useState, useEffect, useRef, useMemo } = React;
        const { 
            Activity, User, Users, Landmark, Globe, Building2, 
            ArrowRight, CheckCircle2, Crown, Loader2, FileText, 
            MapPin, ShieldAlert, Zap, Clock, Banknote, AlertTriangle,
            ScrollText, Info, LogIn
        } = window.lucideReact;

        // --- LeanCloud Key (测试用，实际生产请换成自己的) ---
        const AV_APP_ID = "oxljnef7788g0vxPG8KFVbov-MdYXbMMI";
        const AV_APP_KEY = "w3iUN3cMVOVBaPAMh96Dr2VX";
        const AV_SERVER_URL = "https://oxljnef7.api.lncldglobal.com";

        // --- 静态游戏数据 ---
        const PROJECT_INFO = {
            title: "SunLink 光伏+输变电项目",
            loc: "A国 (虚构发展中国家)",
            desc: "在干旱荒漠与湿地保护区交界处，建设一座100MW光伏电站及80km输电线路。项目面临濒危物种'长尾沙鸡'保护、原住民水权争议及复杂的政治博弈。",
        };

        const ROLE_META = {
            owner: { label: "业主", color: "text-blue-400 border-blue-600 bg-blue-900/20", icon: User, task: "控制投资，确保按期并网。" },
            gov: { label: "政府", color: "text-green-400 border-green-600 bg-green-900/20", icon: Landmark, task: "监管合规，平衡政绩。" },
            mdb: { label: "银行", color: "text-purple-400 border-purple-600 bg-purple-900/20", icon: Globe, task: "提供贷款，监督ESS标准。" },
            epc: { label: "EPC", color: "text-orange-400 border-orange-600 bg-orange-900/20", icon: Building2, task: "工程实施，处理危机。" },
            ngo: { label: "公众", color: "text-red-400 border-red-600 bg-red-900/20", icon: Users, task: "监督环保，维护权益。" }
        };

        const ESIA_ITEMS = [
            { id: 'b1', label: '水土保持方案', cost: 5 }, { id: 'b2', label: '施工噪音控制', cost: 5 }, 
            { id: 'b3', label: '固废处理计划', cost: 10 }, { id: 'b6', label: '征地补偿机制', cost: 20 }, 
            { id: 'a1', label: '生物多样性评估', cost: 20 }, { id: 'a2', label: '原住民FPIC', cost: 10 }
        ];

        /********************************************************************************
         * 2. 自定义 Hooks (处理云端同步)
         ********************************************************************************/
        
        // Hook 1: 大厅同步 (处理玩家进入、选角、开始信号)
        function useLobbySync(room, playerName) {
            const [players, setPlayers] = useState([]);
            const [gameStarted, setGameStarted] = useState(false);

            useEffect(() => {
                if (!room || !window.AV) return;
                const AV = window.AV;

                const fetchLobby = async () => {
                    try {
                        // 1. 获取玩家列表
                        const pQuery = new AV.Query('GamePlayer');
                        pQuery.equalTo('room', parseInt(room));
                        pQuery.ascending('createdAt');
                        const resPlayers = await pQuery.find();
                        const mappedPlayers = resPlayers.map(p => ({
                            id: p.id,
                            name: p.get('name'),
                            role: p.get('role')
                        }));
                        setPlayers(mappedPlayers);

                        // 2. 检查是否有开始信号
                        const aQuery = new AV.Query('GameAction');
                        aQuery.equalTo('room', parseInt(room));
                        aQuery.equalTo('type', 'START_GAME');
                        const startSig = await aQuery.first();
                        if (startSig) setGameStarted(true);

                    } catch (e) { console.warn("Lobby Sync Error:", e); }
                };

                // 立即执行一次，然后轮询
                fetchLobby();
                const timer = setInterval(fetchLobby, 2000);
                return () => clearInterval(timer);
            }, [room]);

            const selectRole = async (roleKey) => {
                const AV = window.AV;
                const Player = AV.Object.extend('GamePlayer');
                const p = new Player();
                p.set('room', parseInt(room));
                p.set('name', playerName);
                p.set('role', roleKey);
                await p.save();
            };

            const hostStartGame = async () => {
                const AV = window.AV;
                const Action = AV.Object.extend('GameAction');
                const act = new Action();
                act.set('room', parseInt(room));
                act.set('type', 'START_GAME');
                act.set('payload', { timestamp: Date.now() }); // 这里的payload是空的，只作为信号
                await act.save();
            };

            return { players, selectRole, hostStartGame, gameStarted };
        }

        // Hook 2: 游戏状态同步 (处理复杂游戏数据流)
        function useGameSync(room, role, onStateUpdate) {
            useEffect(() => {
                const AV = window.AV;
                let lastId = null;

                const pollGameAction = async () => {
                    try {
                        const q = new AV.Query('GameAction');
                        q.equalTo('room', parseInt(room));
                        q.equalTo('type', 'SYNC_STATE'); // 只监听全量状态同步
                        q.descending('createdAt');
                        q.limit(1);
                        const latestAction = await q.first();

                        if (latestAction && latestAction.id !== lastId) {
                            lastId = latestAction.id;
                            const payload = latestAction.get('payload');
                            onStateUpdate(payload); // 回调更新本地React状态
                        }
                    } catch (e) { console.error("Game Sync Error", e); }
                };

                const timer = setInterval(pollGameAction, 1500); // 1.5秒刷新一次
                return () => clearInterval(timer);
            }, [room]);

            // 发送状态到云端
            const broadcastState = async (newStatePayload) => {
                try {
                    const AV = window.AV;
                    const Action = AV.Object.extend('GameAction');
                    const act = new Action();
                    act.set('room', parseInt(room));
                    act.set('type', 'SYNC_STATE');
                    act.set('payload', newStatePayload);
                    await act.save();
                } catch (e) { console.error("Broadcast Error", e); }
            };

            return broadcastState;
        }


        /********************************************************************************
         * 3. 视图组件 (Views)
         ********************************************************************************/

        // 视图1：登录
        function ViewLogin({ onNext }) {
            const [room, setRoom] = useState('1');
            const [name, setName] = useState('');

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-slate-900 relative overflow-hidden">
                    <div className="absolute inset-0 opacity-20 bg-[url('https://images.unsplash.com/photo-1497366216548-37526070297c?auto=format&fit=crop&w=1600&q=80')] bg-cover bg-center"></div>
                    <div className="z-10 w-full max-w-md space-y-8 animate-in">
                        <div className="text-center">
                            <div className="mx-auto w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mb-4 shadow-lg shadow-blue-500/30">
                                <Activity className="text-white w-8 h-8" />
                            </div>
                            <h1 className="text-4xl font-black text-white tracking-tight">SunLink ESG</h1>
                            <p className="text-slate-400 mt-2">多人互动仿真平台</p>
                        </div>

                        <div className="bg-slate-800/80 backdrop-blur p-6 rounded-2xl border border-slate-700 shadow-2xl space-y-4">
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase ml-1">游戏昵称</label>
                                <input type="text" value={name} onChange={e=>setName(e.target.value)} className="w-full mt-1 bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors" placeholder="例如: Player1" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase ml-1">房间号</label>
                                <input type="number" value={room} onChange={e=>setRoom(e.target.value)} className="w-full mt-1 bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white font-mono text-lg tracking-widest text-center focus:outline-none focus:border-blue-500 transition-colors" />
                            </div>
                            <button onClick={() => name && onNext(room, name)} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg shadow-blue-600/20 flex items-center justify-center gap-2 mt-2">
                                进入大厅 <ArrowRight size={18}/>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // 视图2：项目简介
        function ViewIntro({ onNext }) {
            return (
                <div className="min-h-screen bg-slate-950 p-6 flex flex-col items-center overflow-y-auto">
                    <div className="w-full max-w-4xl animate-in space-y-6 pb-10">
                        <header className="flex items-center gap-3 pb-6 border-b border-slate-800">
                            <FileText className="text-blue-500" />
                            <h2 className="text-xl font-bold text-white">项目背景档案</h2>
                        </header>
                        
                        <div className="grid md:grid-cols-2 gap-6">
                            <div className="space-y-6">
                                <div className="text-4xl font-black text-white leading-tight">{PROJECT_INFO.title}</div>
                                <div className="flex flex-wrap gap-3">
                                    <span className="px-3 py-1 rounded-full bg-slate-800 text-slate-300 text-sm flex items-center gap-1"><MapPin size={14}/> {PROJECT_INFO.loc}</span>
                                    <span className="px-3 py-1 rounded-full bg-slate-800 text-slate-300 text-sm flex items-center gap-1"><Zap size={14}/> 100MW 光伏</span>
                                </div>
                                <p className="text-slate-400 leading-relaxed text-lg">{PROJECT_INFO.desc}</p>
                            </div>
                            
                            <div className="bg-slate-900 rounded-2xl p-6 border border-slate-800">
                                <h3 className="text-white font-bold mb-4 flex items-center gap-2"><ShieldAlert size={18} className="text-yellow-500"/> 核心挑战</h3>
                                <ul className="space-y-3">
                                    <li className="flex gap-3 text-slate-400 text-sm"><div className="w-1.5 h-1.5 rounded-full bg-red-500 mt-1.5 shrink-0"></div><span>濒危物种'长尾沙鸡'繁殖地紧邻项目红线。</span></li>
                                    <li className="flex gap-3 text-slate-400 text-sm"><div className="w-1.5 h-1.5 rounded-full bg-orange-500 mt-1.5 shrink-0"></div><span>当地原住民对地下水开采极其敏感。</span></li>
                                    <li className="flex gap-3 text-slate-400 text-sm"><div className="w-1.5 h-1.5 rounded-full bg-purple-500 mt-1.5 shrink-0"></div><span>多边开发银行(MDB)启用了最严格的ESS标准。</span></li>
                                </ul>
                            </div>
                        </div>

                        <div className="flex justify-end pt-8">
                             <button onClick={onNext} className="bg-slate-100 hover:bg-white text-slate-900 px-8 py-3 rounded-full font-bold transition-all flex items-center gap-2">下一步：查看角色 <ArrowRight size={18}/></button>
                        </div>
                    </div>
                </div>
            )
        }

        // 视图3：角色档案
        function ViewProfiles({ onNext }) {
            return (
                <div className="min-h-screen bg-slate-950 p-6 overflow-y-auto">
                    <div className="max-w-5xl mx-auto animate-in space-y-6 pb-10">
                        <header className="flex justify-between items-center pb-6 border-b border-slate-800">
                            <div className="flex items-center gap-3">
                                <Users className="text-blue-500" />
                                <h2 className="text-xl font-bold text-white">利益相关方档案</h2>
                            </div>
                            <button onClick={onNext} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold text-sm transition-all flex items-center gap-2">进入选角大厅 <ArrowRight size={16}/></button>
                        </header>

                        <div className="grid md:grid-cols-3 gap-4">
                            {Object.entries(ROLE_META).map(([key, role]) => (
                                <div key={key} className={`p-5 rounded-xl border bg-slate-900/50 ${role.color.replace('text-', 'border-').replace('bg-', '')} border-opacity-30`}>
                                    <div className="flex items-center gap-3 mb-3">
                                        <role.icon size={24} className={role.color.split(' ')[0]} />
                                        <span className="text-lg font-bold text-white">{role.label}</span>
                                    </div>
                                    <p className="text-slate-300 text-sm leading-relaxed min-h-[40px]">{role.task}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )
        }

        // 视图4：选角大厅
        function ViewLobby({ room, name, onStartGame }) {
            const [myRole, setMyRole] = useState(null);
            const { players, selectRole, hostStartGame, gameStarted } = useLobbySync(room, name);

            useEffect(() => {
                if (gameStarted && myRole) {
                    onStartGame(myRole);
                }
            }, [gameStarted, myRole, onStartGame]);

            const handleSelect = async (roleKey) => {
                if (myRole) return; 
                if (players.find(p => p.role === roleKey)) { alert("该角色已被抢占！"); return; }
                await selectRole(roleKey);
                setMyRole(roleKey);
            };

            return (
                <div className="min-h-screen bg-slate-950 p-4 flex flex-col items-center justify-center">
                    <div className="w-full max-w-4xl bg-slate-900 border border-slate-800 rounded-2xl shadow-2xl p-6 md:p-10 animate-in">
                        <div className="text-center mb-8">
                            <h2 className="text-2xl font-bold text-white flex items-center justify-center gap-2">
                                <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> 房间 #{room} - 实时大厅
                            </h2>
                            <p className="text-slate-400 mt-2">当前在线: {players.length} 人 | 身份先到先得</p>
                        </div>

                        <div className="grid grid-cols-2 md:grid-cols-5 gap-3 mb-10">
                            {Object.entries(ROLE_META).map(([key, meta]) => {
                                const player = players.find(p => p.role === key);
                                const isTaken = !!player;
                                const isMe = player?.name === name;
                                
                                return (
                                    <button key={key} onClick={() => handleSelect(key)} disabled={isTaken}
                                        className={`relative p-4 rounded-xl border-2 transition-all flex flex-col items-center gap-3 h-40 justify-center
                                            ${isTaken ? (isMe ? 'border-green-500 bg-green-900/20' : 'border-slate-800 bg-slate-900 opacity-50 cursor-not-allowed') : 'border-slate-700 bg-slate-800 hover:border-blue-500 hover:bg-slate-700 cursor-pointer'}
                                        `}
                                    >
                                        <meta.icon size={28} className={isTaken ? 'text-slate-500' : 'text-blue-400'} />
                                        <div className="font-bold text-white">{meta.label}</div>
                                        {isTaken ? <div className="absolute bottom-3 left-0 right-0 text-center"><span className="bg-slate-800 text-slate-300 text-xs px-2 py-1 rounded-full border border-slate-600 truncate max-w-[90%] inline-block">{player.name} {isMe && "(我)"}</span></div> : <div className="text-xs text-slate-500">点击入座</div>}
                                    </button>
                                )
                            })}
                        </div>

                        <div className="border-t border-slate-800 pt-6 flex flex-col items-center gap-4">
                            {myRole === 'owner' ? (
                                <div className="w-full max-w-md space-y-2 text-center">
                                    <button onClick={hostStartGame} className="w-full bg-green-600 hover:bg-green-500 text-white text-lg font-bold py-4 rounded-xl shadow-lg shadow-green-600/20 animate-pulse flex items-center justify-center gap-2"><Crown size={20} fill="currentColor" /> 房主确认：开始游戏</button>
                                    <p className="text-xs text-slate-500">作为业主，点击后所有人同步开始。</p>
                                </div>
                            ) : (
                                <div className="text-slate-400 flex items-center gap-3 bg-slate-800/50 px-6 py-3 rounded-full">
                                    {myRole ? <><Loader2 className="animate-spin text-blue-500" /> 等待房主启动游戏...</> : <span>请先选择一个角色入座</span>}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // 视图5：主游戏逻辑 (SunLinkGame)
        function SunLinkGame({ role, room }) {
            // --- 游戏状态 ---
            const [stage, setStage] = useState(1);
            const [activeRole, setActiveRole] = useState('owner'); // 当前谁在操作
            const [logs, setLogs] = useState([{time:'00:00', msg:'游戏开始。进入Stage1: 立项审批。', type:'info'}]);
            const [playerState, setPlayerState] = useState({
                owner: { money: 500, rep: 100 }, gov: { money: 0, rep: 100 },
                mdb: { money: 0, rep: 100 }, epc: { money: 200, rep: 100 }, ngo: { money: 50, rep: 100 }
            });

            // Stage 1 Data
            const [ownerEsia, setOwnerEsia] = useState([]); // 业主暂存
            const [submittedEsia, setSubmittedEsia] = useState([]); // 业主已提交
            const [govMandates, setGovMandates] = useState([]); // 政府要求
            const [ngoProtests, setNgoProtests] = useState([]); // NGO抗议

            // 初始化房主状态
            useEffect(() => {
                if (role === 'owner') {
                    // 房主负责写入初始状态
                    broadcast({ stage: 1, activeRole: 'owner' });
                }
            }, []);

            // 同步 Hook
            const broadcastState = useGameSync(room, role, (remoteState) => {
                // 接收远程状态并覆盖本地
                if (remoteState.stage) setStage(remoteState.stage);
                if (remoteState.activeRole) setActiveRole(remoteState.activeRole);
                if (remoteState.logs) setLogs(remoteState.logs);
                if (remoteState.playerState) setPlayerState(remoteState.playerState);
                if (remoteState.submittedEsia) setSubmittedEsia(remoteState.submittedEsia);
                if (remoteState.govMandates) setGovMandates(remoteState.govMandates);
                if (remoteState.ngoProtests) setNgoProtests(remoteState.ngoProtests);
            });

            // 辅助：发送状态封装
            const broadcast = (overrides) => {
                const newState = {
                    stage, activeRole, logs, playerState,
                    submittedEsia, govMandates, ngoProtests,
                    ...overrides
                };
                broadcastState(newState);
            };

            const addLog = (msg, type='info') => {
                const t = new Date();
                const timeStr = `${t.getHours()}:${t.getMinutes()}:${t.getSeconds()}`;
                const newLogs = [{time: timeStr, msg, type}, ...logs].slice(0, 50);
                setLogs(newLogs);
                return newLogs;
            };

            // --- 业务逻辑 ---
            
            // S1: 业主提交方案
            const s1OwnerSubmit = () => {
                if (ownerEsia.length === 0) return alert("请至少选择一项");
                const cost = ownerEsia.reduce((a, b) => a + ESIA_ITEMS.find(i=>i.id===b).cost, 0);
                const nextState = {...playerState, owner: {...playerState.owner, money: playerState.owner.money - cost}};
                
                const l = addLog(`业主提交了ESIA方案，包含${ownerEsia.length}项评价。`, 'blue');
                setSubmittedEsia(ownerEsia);
                setActiveRole('ngo'); // 轮到NGO
                broadcast({ logs: l, playerState: nextState, submittedEsia: ownerEsia, activeRole: 'ngo' });
            };

            // S1: NGO 评价
            const s1NgoAction = (isProtest) => {
                let l;
                if (isProtest) {
                    l = addLog("公众对方案表示不满，发起抗议！", "red");
                    setNgoProtests(['generic_protest']);
                } else {
                    l = addLog("公众对方案无异议。", "green");
                }
                setActiveRole('gov');
                broadcast({ logs: l, activeRole: 'gov', ngoProtests: isProtest ? ['protest'] : [] });
            };

            // S1: 政府审批
            const s1GovAction = (isApprove) => {
                let l, nextStage, nextRole;
                if (isApprove) {
                    l = addLog("政府批准了项目立项！进入 Stage 2: 融资。", "green");
                    nextStage = 2; 
                    nextRole = 'owner';
                } else {
                    l = addLog("政府驳回了立项申请，要求整改。", "red");
                    nextStage = 1; 
                    nextRole = 'owner'; // 打回给业主
                    // 为了简化逻辑，驳回后清空提交，重来
                    broadcast({ logs: l, activeRole: 'owner', submittedEsia: [] });
                    return;
                }
                setStage(nextStage);
                setActiveRole(nextRole);
                broadcast({ logs: l, stage: nextStage, activeRole: nextRole });
            };

            // S2 简易逻辑 (演示连通性)
            const s2OwnerApply = () => {
                const l = addLog("业主向银行申请融资...", "blue");
                broadcast({ logs: l, activeRole: 'mdb' });
            };

            const s2MdbApprove = () => {
                const l = addLog("银行批准贷款协议。进入 Stage 3: 招标。", "green");
                broadcast({ logs: l, stage: 3, activeRole: 'owner' });
            };

            // 通用：跳过阶段 (调试用)
            const debugSkip = () => {
                const next = stage + 1;
                const l = addLog(`系统强制跳转到 Stage ${next}`, "purple");
                setStage(next);
                broadcast({ stage: next, logs: l });
            };

            // --- 渲染部分 ---
            const isMyTurn = activeRole === role;

            return (
                <div className="min-h-screen bg-slate-900 text-white flex flex-col">
                    {/* 顶部栏 */}
                    <div className="h-14 bg-slate-950 border-b border-slate-800 flex items-center px-6 justify-between shrink-0">
                        <div className="flex items-center gap-3 font-bold text-lg">
                            <Activity className="text-blue-500"/> SunLink ESG 
                            <span className="bg-blue-900 text-blue-200 text-xs px-2 py-0.5 rounded ml-2">Stage {stage}</span>
                        </div>
                        <div className="flex items-center gap-4 text-sm">
                            <span className="text-slate-400">房间: {room}</span>
                            <span className={`px-3 py-1 rounded-full border ${ROLE_META[role].color}`}>我: {ROLE_META[role].label}</span>
                        </div>
                    </div>

                    <div className="flex-1 flex overflow-hidden">
                        {/* 左侧：角色状态区 */}
                        <div className="w-64 bg-slate-900 border-r border-slate-800 flex flex-col overflow-y-auto p-4 gap-4 hidden md:flex">
                            <div className="text-xs font-bold text-slate-500 uppercase">当前状态</div>
                            {Object.entries(ROLE_META).map(([r, meta]) => (
                                <div key={r} className={`p-3 rounded-lg border ${r === activeRole ? 'bg-slate-800 border-blue-500 ring-1 ring-blue-500' : 'bg-slate-900 border-slate-800'} transition-all`}>
                                    <div className="flex items-center justify-between mb-2">
                                        <div className="flex items-center gap-2 font-bold text-sm">
                                            <meta.icon size={16} className={meta.color.split(' ')[0]}/> {meta.label}
                                        </div>
                                        {r === activeRole && <span className="text-[10px] bg-blue-600 text-white px-1.5 rounded animate-pulse">行动中</span>}
                                    </div>
                                    <div className="flex justify-between text-xs text-slate-400">
                                        <span>资金: ${playerState[r]?.money || 0}</span>
                                        <span>声誉: {playerState[r]?.rep || 0}</span>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* 中间：操作面板 */}
                        <div className="flex-1 bg-slate-800 p-6 flex flex-col items-center justify-center relative overflow-y-auto">
                            {/* 遮罩：非回合显示等待 */}
                            {!isMyTurn && (
                                <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-sm z-10 flex flex-col items-center justify-center text-slate-400">
                                    <Loader2 size={48} className="animate-spin text-blue-500 mb-4"/>
                                    <p className="text-lg">等待 {ROLE_META[activeRole].label} 操作...</p>
                                </div>
                            )}

                            <div className="w-full max-w-2xl bg-slate-900 border border-slate-700 rounded-xl p-8 shadow-2xl">
                                <h2 className="text-2xl font-bold mb-6 border-b border-slate-800 pb-4 flex items-center gap-2">
                                    <Zap className="text-yellow-500"/> 
                                    {stage===1 ? "Stage 1: 立项审批" : stage===2 ? "Stage 2: 项目融资" : `Stage ${stage}: 项目执行`}
                                </h2>

                                {/* S1 内容 */}
                                {stage === 1 && (
                                    <div className="space-y-6">
                                        {role === 'owner' && activeRole === 'owner' && (
                                            <>
                                                <p className="text-slate-400">请选择要开展的 ESIA 评价项目：</p>
                                                <div className="grid grid-cols-2 gap-3">
                                                    {ESIA_ITEMS.map(i => (
                                                        <div key={i.id} onClick={() => {
                                                            if(ownerEsia.includes(i.id)) setOwnerEsia(ownerEsia.filter(x=>x!==i.id));
                                                            else setOwnerEsia([...ownerEsia, i.id]);
                                                        }} className={`p-3 rounded border cursor-pointer ${ownerEsia.includes(i.id)?'bg-blue-900/30 border-blue-500':'bg-slate-800 border-slate-700 hover:bg-slate-700'}`}>
                                                            <div className="font-bold text-sm">{i.label}</div>
                                                            <div className="text-xs text-slate-500">成本: ${i.cost}万</div>
                                                        </div>
                                                    ))}
                                                </div>
                                                <button onClick={s1OwnerSubmit} className="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded font-bold mt-4">提交方案</button>
                                            </>
                                        )}

                                        {role === 'ngo' && activeRole === 'ngo' && (
                                            <>
                                                <p className="text-slate-400">业主已提交方案。包含 {submittedEsia.length} 项评价。</p>
                                                <div className="flex gap-4 mt-4">
                                                    <button onClick={() => s1NgoAction(false)} className="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded">无异议</button>
                                                    <button onClick={() => s1NgoAction(true)} className="flex-1 py-3 bg-red-600 hover:bg-red-500 rounded">发起抗议</button>
                                                </div>
                                            </>
                                        )}

                                        {role === 'gov' && activeRole === 'gov' && (
                                            <>
                                                <p className="text-slate-400">请审批业主的立项申请。</p>
                                                <div className="bg-slate-800 p-3 rounded mb-4 text-sm text-slate-300">
                                                    NGO状态: {ngoProtests.length > 0 ? "⚠️ 已抗议" : "✅ 无异议"}
                                                </div>
                                                <div className="flex gap-4">
                                                    <button onClick={() => s1GovAction(true)} className="flex-1 py-3 bg-green-600 hover:bg-green-500 rounded">批准立项</button>
                                                    <button onClick={() => s1GovAction(false)} className="flex-1 py-3 bg-red-600 hover:bg-red-500 rounded">驳回整改</button>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                )}

                                {/* S2 内容 (简) */}
                                {stage === 2 && (
                                    <div className="space-y-6">
                                        {role === 'owner' && activeRole === 'owner' && (
                                            <button onClick={s2OwnerApply} className="w-full py-3 bg-blue-600 rounded font-bold">向银行申请贷款</button>
                                        )}
                                        {role === 'mdb' && activeRole === 'mdb' && (
                                            <button onClick={s2MdbApprove} className="w-full py-3 bg-purple-600 rounded font-bold">批准贷款协议</button>
                                        )}
                                    </div>
                                )}
                                
                                {stage > 2 && (
                                    <div className="text-center py-10 text-slate-500">
                                        后续阶段演示完毕。<br/>感谢测试多人同步功能。
                                        {isMyTurn && <button onClick={debugSkip} className="mt-4 px-4 py-2 bg-slate-700 rounded text-xs">Debug: Next Stage</button>}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* 右侧：日志栏 */}
                        <div className="w-72 bg-slate-950 border-l border-slate-800 p-4 flex flex-col">
                            <div className="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2"><ScrollText size={14}/> 游戏日志</div>
                            <div className="flex-1 overflow-y-auto space-y-3 pr-2">
                                {logs.map((l, i) => (
                                    <div key={i} className={`text-xs p-2 rounded border-l-2 ${l.type==='red'?'border-red-500 bg-red-900/10 text-red-200':l.type==='green'?'border-green-500 bg-green-900/10 text-green-200':'border-slate-500 bg-slate-900 text-slate-300'}`}>
                                        <div className="opacity-50 mb-1 font-mono">{l.time}</div>
                                        {l.msg}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        /********************************************************************************
         * 4. 根应用
         ********************************************************************************/
        function App() {
            // 简单路由：Login -> Intro -> Profiles -> Lobby -> Game
            const [route, setRoute] = useState('login'); 
            const [room, setRoom] = useState('');
            const [name, setName] = useState('');
            const [myRole, setMyRole] = useState(null);

            // 初始化LeanCloud
            useEffect(() => {
                if(window.AV && !window.AV.applicationId) {
                    window.AV.init({ appId: AV_APP_ID, appKey: AV_APP_KEY, serverURL: AV_SERVER_URL });
                    document.getElementById('loading-mask').style.opacity = 0;
                    setTimeout(() => document.getElementById('loading-mask').style.display = 'none', 500);
                }
            }, []);

            const nav = {
                toIntro: (r, n) => { setRoom(r); setName(n); setRoute('intro'); },
                toProfiles: () => setRoute('profiles'),
                toLobby: () => setRoute('lobby'),
                toGame: (role) => { setMyRole(role); setRoute('game'); }
            };

            switch(route) {
                case 'login': return <ViewLogin onNext={nav.toIntro} />;
                case 'intro': return <ViewIntro onNext={nav.toProfiles} />;
                case 'profiles': return <ViewProfiles onNext={nav.toLobby} />;
                case 'lobby': return <ViewLobby room={room} name={name} onStartGame={nav.toGame} />;
                case 'game': return <SunLinkGame room={room} role={myRole} />;
                default: return <div>Error</div>;
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
