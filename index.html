<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SunLink ESG Simulator v7.52 (Stable)</title>
    
    <!-- 1. 核心样式库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React 核心库 (使用更稳定的 CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel 编译器 -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. 图标库 -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 5. 后端服务 SDK -->
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>

    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; }
        #root { width: 100%; height: 100vh; overflow: hidden; }
        .loading-screen { display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; gap: 20px; }
        .error-box { background: #ef4444; color: white; padding: 20px; border-radius: 8px; max-width: 80%; word-break: break-all; }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading-screen">
            <div class="text-2xl font-bold">正在加载资源...</div>
            <div class="text-sm text-slate-400">如果长时间停留在此页面，请检查网络或按 F12 查看控制台错误。</div>
        </div>
    </div>

    <script type="text/babel">
        // --- 错误边界处理 (防止白屏) ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="loading-screen">
                            <h1 className="text-2xl font-bold">程序发生错误</h1>
                            <div className="error-box">
                                {this.state.error.toString()}
                            </div>
                            <button onClick={() => window.location.reload()} className="px-4 py-2 bg-white text-black rounded mt-4">刷新页面</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const { useState, useEffect, useRef } = React;

        // --- 尝试获取图标，如果失败则使用占位符 ---
        const Icons = window.lucide || {};
        const { 
          User, Building2, Landmark, Globe, Users, Activity, 
          ArrowRight, FileText, CheckCircle2, MapPin, 
          Banknote, Clock, ShieldAlert, AlertTriangle,
          Timer, Gavel, BookOpen, Reply,
          ClipboardCheck, Award, Megaphone, Handshake, Eye,
          Zap, HardHat, ListChecks,
          PieChart, BarChart3, ScrollText, Target, Scale,
          LogIn, Users2, Loader2, Network,
          UserPlus, ArrowBigRight, Info
        } = Icons;

        // 如果图标加载失败的备用组件
        const FallbackIcon = () => <span>?</span>;
        const SafeIcon = (IconComponent) => IconComponent || FallbackIcon;

        // --- UI 组件 ---
        const Button = ({ className, variant, size, children, ...props }) => {
            const base = "inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none disabled:opacity-50 disabled:pointer-events-none ring-offset-background";
            const variants = {
                default: "bg-slate-900 text-white hover:bg-slate-800",
                destructive: "bg-red-500 text-white hover:bg-red-600",
                outline: "border border-input hover:bg-accent hover:text-accent-foreground",
                secondary: "bg-secondary text-secondary-foreground hover:bg-secondary/80",
                ghost: "hover:bg-accent hover:text-accent-foreground",
            };
            return <button className={`${base} ${variants[variant || "default"]} ${className || ""} h-10 px-4 py-2`} {...props}>{children}</button>;
        };

        const Card = ({ className, children }) => <div className={`rounded-lg border bg-card text-card-foreground shadow-sm bg-white text-slate-900 ${className}`}>{children}</div>;
        const CardHeader = ({ className, children }) => <div className={`flex flex-col space-y-1.5 p-6 ${className}`}>{children}</div>;
        const CardTitle = ({ className, children }) => <h3 className={`text-2xl font-semibold leading-none tracking-tight ${className}`}>{children}</h3>;
        const CardContent = ({ className, children }) => <div className={`p-6 pt-0 ${className}`}>{children}</div>;
        const Badge = ({ className, variant, children }) => <div className={`inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 ${className}`}>{children}</div>;
        const Input = ({ className, ...props }) => <input className={`flex h-10 w-full rounded-md border border-slate-300 bg-transparent px-3 py-2 text-sm placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-400 disabled:cursor-not-allowed disabled:opacity-50 ${className}`} {...props} />;

        // --- 核心数据常量 ---
        const PROJECT_INFO = {
            name: "SunLink 光伏+输变电项目", 
            location: "A国 - 北部干旱荒漠与'绿洲'湿地保护区交界",
            mission: "在资金有限、工期紧迫、且国际NGO高度关注的背景下，平衡经济利益、环境合规与社会稳定。"
        };

        const ROLE_DETAILS = {
            owner: { label: "业主", desc: "GreenGen 集团", color: "text-blue-600 bg-blue-50 border-blue-200", icon: User },
            gov: { label: "政府", desc: "能源与环境部", color: "text-green-600 bg-green-50 border-green-200", icon: Landmark },
            mdb: { label: "银行", desc: "世界基础设施银行", color: "text-purple-600 bg-purple-50 border-purple-200", icon: Globe },
            epc: { label: "EPC", desc: "GIP国际工程公司", color: "text-orange-600 bg-orange-50 border-orange-200", icon: Building2 },
            ngo: { label: "公众", desc: "受影响社区及NGO", color: "text-red-600 bg-red-50 border-red-200", icon: Users }
        };

        // --- 主逻辑组件 ---
        const SunLinkApp = () => {
            const [gameState, setGameState] = useState('cover'); // cover, mode_select, lobby, playing
            const [mode, setMode] = useState('single');
            const [loading, setLoading] = useState(false);

            // 模拟多人房间状态
            const [roomPlayers, setRoomPlayers] = useState([]);
            const [roomNumber, setRoomNumber] = useState("1");
            const [playerName, setPlayerName] = useState("Player1");
            const [myRole, setMyRole] = useState(null);

            // 进入游戏逻辑
            const enterGame = (selectedMode) => {
                setMode(selectedMode);
                if (selectedMode === 'single') {
                    setGameState('playing');
                } else {
                    setGameState('lobby_login');
                }
            };

            // 渲染封面
            if (gameState === 'cover') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-slate-900 text-white p-4 relative overflow-hidden">
                        <div className="absolute inset-0 opacity-20 bg-[url('https://images.unsplash.com/photo-1497435334941-8c899ee9e8e9?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80')] bg-cover bg-center"></div>
                        <div className="z-10 text-center space-y-8 max-w-2xl">
                            <div className="inline-block p-4 rounded-full bg-blue-500/20 backdrop-blur-sm mb-4">
                                {SafeIcon(Activity)({size: 64, className: "text-blue-400"})}
                            </div>
                            <h1 className="text-5xl md:text-7xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">SunLink ESG</h1>
                            <p className="text-xl text-slate-300 font-light">国际工程环境社会治理 (ESG) 决策模拟器</p>
                            
                            <div className="flex flex-col sm:flex-row gap-4 justify-center mt-10">
                                <Button onClick={() => enterGame('single')} size="lg" className="h-16 px-8 text-lg bg-blue-600 hover:bg-blue-500 shadow-lg shadow-blue-900/20 border border-blue-400/30">
                                    <span className="flex flex-col items-center">
                                        <span className="font-bold flex items-center gap-2">{SafeIcon(Award)({size: 20})} 单人体验</span>
                                        <span className="text-xs font-normal opacity-80">一人分饰五角 · 快速通关</span>
                                    </span>
                                </Button>
                                <Button onClick={() => enterGame('multi')} size="lg" className="h-16 px-8 text-lg bg-purple-600 hover:bg-purple-500 shadow-lg shadow-purple-900/20 border border-purple-400/30">
                                    <span className="flex flex-col items-center">
                                        <span className="font-bold flex items-center gap-2">{SafeIcon(Network)({size: 20})} 多人联机</span>
                                        <span className="text-xs font-normal opacity-80">真实组队 · 实时博弈</span>
                                    </span>
                                </Button>
                            </div>
                        </div>
                        <div className="absolute bottom-4 text-slate-600 text-xs">v7.52 Stable Fix</div>
                    </div>
                );
            }

            // 渲染多人大厅登录
            if (gameState === 'lobby_login') {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-900 text-white p-4">
                        <Card className="w-full max-w-md relative z-10 border-t-4 border-purple-500">
                             <div className="absolute top-4 left-4">
                                 <Button variant="ghost" size="sm" onClick={() => setGameState('cover')} className="text-slate-500 hover:text-slate-900">&lt; 返回</Button>
                             </div>
                             <CardHeader className="text-center mt-6">
                                 <CardTitle className="text-2xl font-bold text-slate-900">多人大厅</CardTitle>
                             </CardHeader>
                             <CardContent className="space-y-4">
                                 <div>
                                     <label className="text-xs font-bold text-slate-500">昵称</label>
                                     <Input value={playerName} onChange={(e) => setPlayerName(e.target.value)} className="text-slate-900" />
                                 </div>
                                 <div>
                                     <label className="text-xs font-bold text-slate-500">房间号 (1-20)</label>
                                     <Input type="number" value={roomNumber} onChange={(e) => setRoomNumber(e.target.value)} className="text-slate-900" />
                                 </div>
                                 <Button className="w-full bg-purple-600 hover:bg-purple-700 text-white" onClick={() => {
                                     // 这里简单模拟进入，真实逻辑需要连接 LeanCloud，这里为了防白屏先做伪逻辑
                                     // 如果 LeanCloud 未初始化，提示用户
                                     if (!window.AV) {
                                         alert("正在连接云端服务，请稍候...");
                                         // 尝试初始化
                                         try {
                                             const script = document.createElement('script');
                                             script.src = 'https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js';
                                             script.onload = () => {
                                                 window.AV.init({
                                                    appId: "oxljnef7788g0vxPG8KFVbov-MdYXbMMI",
                                                    appKey: "w3iUN3cMVOVBaPAMh96Dr2VX",
                                                    serverURL: "https://oxljnef7.api.lncldglobal.com"
                                                 });
                                                 setGameState('lobby_select');
                                             };
                                             document.body.appendChild(script);
                                         } catch(e) { alert("网络连接失败"); }
                                     } else {
                                         // 如果已经加载
                                         if(!window.AV.applicationId) {
                                             window.AV.init({
                                                appId: "oxljnef7788g0vxPG8KFVbov-MdYXbMMI",
                                                appKey: "w3iUN3cMVOVBaPAMh96Dr2VX",
                                                serverURL: "https://oxljnef7.api.lncldglobal.com"
                                             });
                                         }
                                         setGameState('lobby_select');
                                     }
                                 }}>
                                     进入房间
                                 </Button>
                             </CardContent>
                        </Card>
                    </div>
                )
            }
            
            // 渲染选角大厅 (简化版，确保能显示)
            if (gameState === 'lobby_select') {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-900 p-4">
                        <Card className="w-full max-w-2xl">
                             <CardHeader className="border-b border-slate-100">
                                 <CardTitle className="text-center">房间 #{roomNumber} - 角色选择</CardTitle>
                             </CardHeader>
                             <CardContent className="pt-6 grid grid-cols-2 md:grid-cols-3 gap-4">
                                 {Object.keys(ROLE_DETAILS).map(roleKey => (
                                     <button 
                                        key={roleKey}
                                        onClick={() => { setMyRole(roleKey); setGameState('playing'); }}
                                        className={`p-4 border rounded-lg flex flex-col items-center gap-2 hover:bg-slate-50 transition-all ${myRole === roleKey ? 'ring-2 ring-blue-500 bg-blue-50' : ''}`}
                                     >
                                         <div className={`p-2 rounded-full ${ROLE_DETAILS[roleKey].color.replace('text-', 'bg-').split(' ')[0]} bg-opacity-20 text-white`}>
                                             {/* Icon placeholder to prevent crash */}
                                             <div className="w-6 h-6 bg-gray-400 rounded-full"></div>
                                         </div>
                                         <span className="font-bold text-slate-700">{ROLE_DETAILS[roleKey].label}</span>
                                     </button>
                                 ))}
                             </CardContent>
                             <div className="p-4 border-t text-center">
                                 <Button onClick={() => setGameState('playing')} disabled={!myRole} className="w-full md:w-auto bg-green-600">开始游戏</Button>
                             </div>
                        </Card>
                    </div>
                )
            }

            // 游戏主界面
            if (gameState === 'playing') {
                return <GameCore mode={mode} myRole={myRole || 'owner'} onExit={() => setGameState('cover')} />
            }

            return null;
        };

        // --- 游戏核心逻辑 (简化稳定版) ---
        const GameCore = ({ mode, myRole, onExit }) => {
            const [stage, setStage] = useState(1);
            const [activeRole, setActiveRole] = useState(mode === 'single' ? 'owner' : myRole);
            const [logs, setLogs] = useState([{time: '0:00', msg: '游戏开始。项目进入立项审批阶段。', type: 'info'}]);
            
            // 简单的状态流转演示
            const nextStage = () => {
                if (stage < 5) {
                    setStage(s => s + 1);
                    setLogs(prev => [...prev, {time: `Month ${stage*2}`, msg: `进入阶段 ${stage + 1}`, type: 'info'}]);
                } else {
                    alert("游戏演示结束");
                    onExit();
                }
            };

            return (
                <div className="h-screen w-full bg-slate-100 flex flex-col overflow-hidden">
                    {/* 顶部导航 */}
                    <div className="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-4 shrink-0 shadow-sm text-slate-800">
                        <div className="font-bold flex items-center gap-2">
                            {SafeIcon(Activity)({className:"text-blue-600"})} SunLink Simulator
                        </div>
                        <div className="flex gap-1">
                            {[1,2,3,4,5].map(s => (
                                <div key={s} className={`px-2 py-1 rounded text-xs ${stage===s ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-500'}`}>
                                    Stage {s}
                                </div>
                            ))}
                        </div>
                        <Button variant="ghost" size="sm" onClick={onExit} className="text-red-500">退出</Button>
                    </div>

                    {/* 主体内容 */}
                    <div className="flex-1 flex overflow-hidden">
                        {/* 角色栏 */}
                        <div className="flex-1 p-4 overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {/* 仅显示当前活跃角色或所有角色 */}
                            <Card className="col-span-full mb-4 bg-blue-50 border-blue-200">
                                <CardHeader>
                                    <CardTitle className="flex items-center gap-2 text-blue-800">
                                        {SafeIcon(Info)({size:20})} 当前任务
                                    </CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <p className="text-sm text-blue-900">
                                        {stage === 1 && "业主需要提交环境社会影响评价 (ESIA)，政府进行审批。"}
                                        {stage === 2 && "项目需要向银行申请融资，并签署环境社会承诺计划 (ESCP)。"}
                                        {stage === 3 && "进行EPC招标与合同谈判。"}
                                        {stage === 4 && "项目建设期，处理突发ESG危机。"}
                                        {stage === 5 && "项目验收与后评价。"}
                                    </p>
                                    <Button onClick={nextStage} className="mt-4 bg-blue-600 hover:bg-blue-700 text-white">
                                        完成任务并进入下一阶段 &rarr;
                                    </Button>
                                </CardContent>
                            </Card>

                            {/* 日志区域 */}
                            <Card className="col-span-full lg:col-span-1 h-64 lg:h-auto overflow-hidden flex flex-col">
                                <div className="p-3 border-b bg-slate-50 font-bold text-sm text-slate-700">系统日志</div>
                                <div className="flex-1 overflow-y-auto p-2 space-y-2 bg-slate-900 text-green-400 font-mono text-xs">
                                    {logs.map((l, i) => (
                                        <div key={i}>[{l.time}] {l.msg}</div>
                                    ))}
                                </div>
                            </Card>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <SunLinkApp />
            </ErrorBoundary>
        );
    </script>
</body>
</html>
